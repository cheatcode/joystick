import{parseHTML as w}from"linkedom";import u from"node-fetch";import{URL as d,URLSearchParams as g}from"url";import p from"./event.js";import m from"../load/index.js";import h from"../../lib/generate_cookie_header.js";import y from"../../lib/location_polyfill.js";const k=async(a="",t={})=>{const n=new d(`${window?.location?.origin}/api/_test/bootstrap`);n.search=new g({path_to_component:a});const l={cache:"no-store"},o={};t?.options?.user&&(o.joystick_login_token=t?.options?.user?.joystick_login_token,o.joystick_login_token_expires_at=t?.options?.user?.joystick_login_token_expires_at),t?.options?.language_cookie&&(o.language=t?.options?.language_cookie),l.headers={"Accept-Language":t?.options?.language||"",Cookie:Object.keys(o).length>0?h(o):""};const e=await u(n,l).then(async s=>s.json());window.joystick={settings:e?.settings||{}},window.__joystick_test__=!0,window.__joystick_data__=e?.data||{},window.__joystick_i18n__=e?.translations||{},window.__joystick_req__=e?.req,window.__joystick_url__=t?.url||{params:{},path:"/",query:{},route:"/"}},f=()=>{const a=w(`
    <html>
      <head></head>
      <body>
        <div id="app"></div>
      </body>
    </html>
  `),{window:t,document:n,Element:l,Event:o,HTMLElement:e}=a;return global.window=t,global.document=n,global.HTMLElement=e,global.Element=l,global.Event=o,global.console={log:console.log,warn:console.warn,error:console.error},a},b=async(a="",t={})=>{const n=f();window.fetch=u,window.location=y(`http://localhost:${process.env.PORT}`),await k(a,t);const l=await m(a,{default:!0}),o=t?.layout?await m(t?.layout,{default:!0}):null,e={...t?.props||{}};t?.layout&&(e.page=l);const s=global.joystick.mount(o||l,e,n?.document.querySelector("#app"));t?.state&&(s.state=t?.state);const _=()=>{const c=s?.render_to_html(),r=new RegExp("<when>|</when>","g");return c?.replace(r,"")?.replace(/\n|\t/g," ")?.replace(/> *</g,"><")};return{dom:n,instance:s,test:{data:async(c={})=>s?.data?.refetch(c),renderToHTML:_,render_to_html:_,method:(c="",...r)=>{const i=s?.methods[c];return i?i(...r):null},event:(c="",r="",i={})=>p(c,r,n,i)}}};var H=b;export{H as default};
