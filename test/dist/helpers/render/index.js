import{parseHTML as w}from"linkedom";import d from"node-fetch";import{URL as u,URLSearchParams as p}from"url";import g from"./event.js";import m from"../load/index.js";import h from"../../lib/generate_cookie_header.js";const y=async(n="",t={})=>{const o=new u(`${window?.location?.origin}/api/_test/bootstrap`);o.search=new p({path_to_component:n});const a={cache:"no-store"};a.headers={"Accept-Language":t?.options?.language||"",Cookie:t?.options?.user?h({joystick_login_token:t?.options?.user?.joystick_login_token,joystick_login_token_expires_at:t?.options?.user?.joystick_login_token_expires_at}):""};const e=await d(o,a).then(async s=>s.json());window.joystick={settings:e?.settings||{}},window.__joystick_test__=!0,window.__joystick_data__=e?.data||{},window.__joystick_i18n__=e?.translations||{},window.__joystick_req__=e?.req,window.__joystick_url__=t?.url||{params:{},path:"/",query:{},route:"/"}},k=()=>{const n=w(`
    <html>
      <head></head>
      <body>
        <div id="app"></div>
        <meta name="csrf" content="joystick_test" />
      </body>
    </html>
  `),{window:t,document:o,Element:a,Event:e,HTMLElement:s}=n;return global.window=t,global.document=o,global.HTMLElement=s,global.Element=a,global.Event=e,global.console={log:console.log,warn:console.warn,error:console.error},n},f=async(n="",t={})=>{const o=k();window.fetch=d,window.location={origin:`http://localhost:${process.env.PORT}`},await y(n,t);const a=await m(n,{default:!0}),e=t?.layout?await m(t?.layout,{default:!0}):null,s={...t?.props||{}};t?.layout&&(s.page=a);const l=global.joystick.mount(e||a,s,o?.document.querySelector("#app")),_=()=>{const r=l?.render_to_html(),c=new RegExp("<when>|</when>","g");return r?.replace(c,"")?.replace(/\n|\t/g," ")?.replace(/> *</g,"><")};return{dom:o,instance:l,test:{data:async(r={})=>l?.data?.refetch(r),renderToHTML:_,render_to_html:_,method:(r="",...c)=>{const i=l?.methods[r];return i?i(...c):null},event:(r="",c="",i={})=>g(r,c,o,i)}}};var q=f;export{q as default};
