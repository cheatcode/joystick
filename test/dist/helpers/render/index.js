import{parseHTML as g}from"linkedom";import u from"node-fetch";import{URL as d,URLSearchParams as m}from"url";import p from"./event.js";import w from"../load/index.js";import h from"../../lib/generate_cookie_header.js";const y=async(a="",t={})=>{const n=new d(`${window?.location?.origin}/api/_test/bootstrap`);n.search=new m({path_to_component:a});const s={cache:"no-store"},o={};t?.options?.user&&(o.joystick_login_token=t?.options?.user?.joystick_login_token,o.joystick_login_token_expires_at=t?.options?.user?.joystick_login_token_expires_at),t?.options?.language_cookie&&(o.language=t?.options?.language_cookie),s.headers={"Accept-Language":t?.options?.language||"",Cookie:Object.keys(o).length>0?h(o):""};const e=await u(n,s).then(async c=>c.json());window.joystick={settings:e?.settings||{}},window.__joystick_test__=!0,window.__joystick_data__=e?.data||{},window.__joystick_i18n__=e?.translations||{},window.__joystick_req__=e?.req,window.__joystick_url__=t?.url||{params:{},path:"/",query:{},route:"/"}},k=()=>{const a=g(`
    <html>
      <head></head>
      <body>
        <div id="app"></div>
      </body>
    </html>
  `),{window:t,document:n,Element:s,Event:o,HTMLElement:e}=a;return global.window=t,global.document=n,global.HTMLElement=e,global.Element=s,global.Event=o,global.console={log:console.log,warn:console.warn,error:console.error},a},f=async(a="",t={})=>{const n=k();window.fetch=u,window.location={origin:`http://localhost:${process.env.PORT}`},await y(a,t);const s=await w(a,{default:!0}),o=t?.layout?await w(t?.layout,{default:!0}):null,e={...t?.props||{}};t?.layout&&(e.page=s);const c=global.joystick.mount(o||s,e,n?.document.querySelector("#app"));t?.state&&(c.state=t?.state);const _=()=>{const l=c?.render_to_html(),r=new RegExp("<when>|</when>","g");return l?.replace(r,"")?.replace(/\n|\t/g," ")?.replace(/> *</g,"><")};return{dom:n,instance:c,test:{data:async(l={})=>c?.data?.refetch(l),renderToHTML:_,render_to_html:_,method:(l="",...r)=>{const i=c?.methods[l];return i?i(...r):null},event:(l="",r="",i={})=>p(l,r,n,i)}}};var q=f;export{q as default};
