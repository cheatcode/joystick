import{parseHTML as w}from"linkedom";import m from"node-fetch";import{URL as g,URLSearchParams as d}from"url";import p from"./event.js";import u from"../load/index.js";import h from"../../lib/generate_cookie_header.js";import y from"../../lib/location_polyfill.js";import k from"../../lib/get_test_port.js";const f=async(n="",t={})=>{const a=new g(`${window?.location?.origin}/api/_test/bootstrap`);a.search=new d({path_to_component:n});const l={cache:"no-store"},o={};t?.options?.user&&(o.joystick_login_token=t?.options?.user?.joystick_login_token,o.joystick_login_token_expires_at=t?.options?.user?.joystick_login_token_expires_at),t?.options?.language_cookie&&(o.language=t?.options?.language_cookie),l.headers={"Accept-Language":t?.options?.language||"",Cookie:Object.keys(o).length>0?h(o):""};const e=await m(a,l).then(async r=>r.json());window.joystick={settings:e?.settings||{}},window.__joystick_test__=!0,window.__joystick_data__=e?.data||{},window.__joystick_i18n__=e?.translations||{},window.__joystick_req__=e?.req,window.__joystick_url__=t?.url||{params:{},path:"/",query:{},route:"/"}},b=()=>{const n=w(`
    <html>
      <head></head>
      <body>
        <div id="app"></div>
      </body>
    </html>
  `),{window:t,document:a,Element:l,Event:o,HTMLElement:e}=n;return global.window=t,global.document=a,global.HTMLElement=e,global.Element=l,global.Event=o,global.console={log:console.log,warn:console.warn,error:console.error},n},j=async(n="",t={})=>{const a=b();window.fetch=m,window.location=y(`http://localhost:${k()}`),await f(n,t);const l=await u(n,{default:!0}),o=t?.layout?await u(t?.layout,{default:!0}):null,e={...t?.props||{}};t?.layout&&(e.page=l);const r=global.joystick.mount(o||l,e,a?.document.querySelector("#app"));t?.state&&(r.state=t?.state);const _=()=>{const s=r?.render_to_html(),c=new RegExp("<when>|</when>","g");return s?.replace(c,"")?.replace(/\n|\t/g," ")?.replace(/> *</g,"><")};return{dom:a,instance:r,test:{data:async(s={})=>r?.data?.refetch(s),renderToHTML:_,render_to_html:_,method:(s="",...c)=>{const i=r?.methods[s];return i?i(...c):null},event:(s="",c="",i={})=>p(s,c,a,i)}}};var R=j;export{R as default};
