import{parseHTML as g}from"linkedom";import u from"node-fetch";import{URL as w,URLSearchParams as m}from"url";import p from"./event.js";import d from"../load/index.js";import h from"../../lib/generate_cookie_header.js";const y=async(a="",o={})=>{const n=new w(`${window?.location?.origin}/api/_test/bootstrap`);n.search=new m({path_to_component:a});const r={cache:"no-store"},t={};o?.options?.user&&(t.joystick_login_token=o?.options?.user?.joystick_login_token,t.joystick_login_token_expires_at=o?.options?.user?.joystick_login_token_expires_at),o?.options?.language_cookie&&(t.language=o?.options?.language_cookie),r.headers={"Accept-Language":o?.options?.language||"",Cookie:Object.keys(t).length>0?h(t):""};const e=await u(n,r).then(async s=>s.json());window.joystick={settings:e?.settings||{}},window.__joystick_test__=!0,window.__joystick_data__=e?.data||{},window.__joystick_i18n__=e?.translations||{},window.__joystick_req__=e?.req,window.__joystick_url__=o?.url||{params:{},path:"/",query:{},route:"/"}},k=()=>{const a=g(`
    <html>
      <head></head>
      <body>
        <div id="app"></div>
      </body>
    </html>
  `),{window:o,document:n,Element:r,Event:t,HTMLElement:e}=a;return global.window=o,global.document=n,global.HTMLElement=e,global.Element=r,global.Event=t,global.console={log:console.log,warn:console.warn,error:console.error},a},f=async(a="",o={})=>{const n=k();window.fetch=u,window.location={origin:`http://localhost:${process.env.PORT}`},await y(a,o);const r=await d(a,{default:!0}),t=o?.layout?await d(o?.layout,{default:!0}):null,e={...o?.props||{}};o?.layout&&(e.page=r);const s=global.joystick.mount(t||r,e,n?.document.querySelector("#app")),_=()=>{console.log("rth component",s);const c=s?.render_to_html(),l=new RegExp("<when>|</when>","g");return c?.replace(l,"")?.replace(/\n|\t/g," ")?.replace(/> *</g,"><")};return{dom:n,instance:s,test:{data:async(c={})=>s?.data?.refetch(c),renderToHTML:_,render_to_html:_,method:(c="",...l)=>{const i=s?.methods[c];return i?i(...l):null},event:(c="",l="",i={})=>p(c,l,n,i)}}};var q=f;export{q as default};
