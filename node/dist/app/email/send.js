import w from"chalk";import{htmlToText as $}from"html-to-text";import b from"juice";import j from"nodemailer";import x from"../../lib/dynamic_import.js";import y from"../../lib/get_joystick_build_path.js";import T from"../../lib/get_translations.js";import v from"../settings/load.js";import l from"../../lib/path_exists.js";import k from"../ssr/index.js";import E from"../../test/track_function_call.js";import I from"./validate_smtp_settings.js";const r=v(),p=y(),o=`${p}i18n/email`,M=await l(o)&&fs.readdirSync(o)||[],P=async(t={},e={})=>{if(process.env.NODE_ENV==="test"){E("node.email.send",[t]);return}const m=I(r?.config?.email?.smtp);if(!m)return console.warn(w.redBright("Invalid SMTP settings. Cannot send email.")),Promise.resolve(null);const s=parseInt(e?.port||r?.config?.email?.smtp?.port,10),c=s===465||![25,587].includes(s),u=m?j.createTransport({host:e?.host||r?.config?.email?.smtp?.host,port:s,secure:c,auth:{user:e?.username||r?.config?.email?.smtp?.username,pass:e?.password||r?.config?.email?.smtp?.password}}):null,n=`${p}email/${t?.template}.js`,f=t?.template&&await l(n),a={from:r?.config?.email?.from,...t};if(e?.headers&&(a.headers=e?.headers),f){const h=await x(`${n}?v=${new Date().getTime()}`),g=await T({is_email:!0,email_template_name:t?.template,email_language_files_path:o,email_language_files:M,req:{context:{user:t?.user}}}),i=await k({is_email:!0,component_options:{props:t?.props,translations:g},component_to_render:h,email_options:{base_html_name:t?.base,subject:t?.subject,preheader:t?.preheader?`${t?.preheader}${"\u200C\xA0".repeat(250)}`:""}}),d=$(i),_=b(i,{preserveMediaQueries:!0,preserveImportant:!0,removeStyleTags:!1});return a.html=_,a.text=d,u.sendMail(a)}return console.warn(`Email template at /email/${t?.template}.js could not be found.`),Promise.resolve()};var G=P;export{G as default};
