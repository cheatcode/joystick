import g from"chalk";import{htmlToText as d}from"html-to-text";import j from"juice";import w from"nodemailer";import y from"../../lib/dynamic_import.js";import $ from"../../lib/get_joystick_build_path.js";import k from"../../lib/get_translations.js";import b from"../settings/load.js";import x from"../../lib/path_exists.js";import T from"../ssr/index.js";import v from"../../test/track_function_call.js";import D from"./validate_smtp_settings.js";const a=b(),l=$(),E=async(t={},e={})=>{if(process.env.NODE_ENV==="test"){v("node.email.send",[t]);return}const o=D(a?.config?.email?.smtp);if(!o)return console.warn(g.redBright("Invalid SMTP settings. Cannot send email.")),Promise.resolve(null);const s=parseInt(e?.port||a?.config?.email?.smtp?.port,10),n=s===465||![25,587].includes(s),p=o?w.createTransport({host:e?.host||a?.config?.email?.smtp?.host,port:s,secure:n,auth:{user:e?.username||a?.config?.email?.smtp?.username,pass:e?.password||a?.config?.email?.smtp?.password}}):null,m=`${l}email/${t?.template}.js`,c=t?.template&&(process._joystick_email_templates?.[t?.template]||await x(m)),r={from:a?.config?.email?.from,...t};if(e?.headers&&(r.headers=e?.headers),c){const u=process._joystick_email_templates?.[t?.template]||await y(`${m}?v=${new Date().getTime()}`),f=await k({is_email:!0,email_template_name:t?.template,email_language_files_path:process._joystick_translations?.email?.path||`${l}i18n/email`,email_language_files:process._joystick_translations?.email?.files||[],req:{context:{user:t?.user}}}),i=await T({is_email:!0,component_options:{props:t?.props,translations:f},component_to_render:u,email_options:{base_html_name:t?.base,subject:t?.subject,preheader:t?.preheader?`${t?.preheader}${"\u2007\u034F".repeat(100)}${"\xAD".repeat(50)}`:""}}),h=d(i),_=j(i,{preserveMediaQueries:!0,preserveImportant:!0,removeStyleTags:!1});return r.html=_,r.text=h,p.sendMail(r)}return console.warn(`Email template at /email/${t?.template}.js could not be found.`),Promise.resolve()};var V=E;export{V as default};
