import c from"crypto";import f from"../../lib/set_cookie.js";import u from"../../lib/generate_id.js";import d from"../settings/load.js";const _=d(),n="joystick_session",i=_?.config?.sessions?.secret||null,p=s=>{const e=Buffer.from(JSON.stringify(s)).toString("base64"),t=c.createHmac("sha256",i).update(e).digest("base64");return`${e}.${t}`},g=s=>{if(!s)return null;const[e,t]=s.split(".");if(!e||!t)return null;const a=c.createHmac("sha256",i).update(e).digest("base64");if(t!==a)return null;try{return JSON.parse(Buffer.from(e,"base64").toString())}catch{return null}},m=(s,e,t)=>{if(i){if(s?.headers?.["x-push-instance-token"]&&_?.private?.cheatcode?.is_push||s?.url?.includes("/api/_push/health"))return t();const r=s?.cookies?.[n];let o=g(r);if(console.log({existing_session_cookie:r,session_data:o}),!o){o={_id:u(16),csrf:u(32),created_at:new Date};const l=p(o);f(e,{name:n,value:l,http_only:!0,max_age:30*24*60*60*1e3,same_site:"lax"})}s.cookies={...s?.cookies||{},[n]:o._id},s.context={...s?.context||{},session:o}}t()};var E=m;export{E as default};
