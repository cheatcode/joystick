import i from"crypto";import p from"fs";import f from"../../lib/set_cookie.js";import c from"../../lib/generate_id.js";import h from"../settings/load.js";const u=h(),n="joystick_session";let a=null;try{const s=p.readFileSync(".joystick/PROCESS_ID","utf8").trim();a=i.createHash("sha256").update(`joystick-session-${s}`).digest("hex")}catch{a=i.createHash("sha256").update(`joystick-session-fallback-${Date.now()}`).digest("hex")}const _=u?.config?.sessions?.secret||a,m=s=>{const e=Buffer.from(JSON.stringify(s)).toString("base64"),t=i.createHmac("sha256",_).update(e).digest("base64");return`${e}.${t}`},g=s=>{if(!s)return null;const[e,t]=s.split(".");if(!e||!t)return null;const r=i.createHmac("sha256",_).update(e).digest("base64");if(t!==r)return null;try{return JSON.parse(Buffer.from(e,"base64").toString())}catch{return null}},k=(s,e,t)=>{if(s?.headers?.["x-push-instance-token"]&&u?.private?.cheatcode?.is_push||s?.url?.includes("/api/_push/health"))return t();const d=s?.cookies?.[n];let o=g(d);if(!o){o={_id:c(16),csrf:c(32),created_at:new Date};const l=m(o);f(e,{name:n,value:l,http_only:!0,max_age:30*24*60*60*1e3,same_site:"lax"})}s.cookies={...s?.cookies||{},[n]:o._id},s.context={...s?.context||{},session:o},t()};var j=k;export{j as default};
