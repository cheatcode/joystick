import r from"crypto";import l from"../../lib/set_cookie.js";import c from"../../lib/generate_id.js";import d from"../settings/load.js";const u=d(),o="joystick_session",i=u?.config?.sessions?.secret||null,p=s=>{const e=Buffer.from(JSON.stringify(s)).toString("base64"),t=r.createHmac("sha256",i).update(e).digest("base64");return`${e}.${t}`},m=s=>{if(!s)return null;const[e,t]=s.split(".");if(!e||!t)return null;const a=r.createHmac("sha256",i).update(e).digest("base64");if(t!==a)return null;try{return JSON.parse(Buffer.from(e,"base64").toString())}catch{return null}},g=(s,e,t)=>{if(i){if(s?.headers?.["x-push-instance-token"]&&u?.private?.cheatcode?.is_push||s?.url?.includes("/api/_push/health"))return t();const _=s?.cookies?.[o];let n=m(_);if(!n){n={_id:c(16),csrf:c(32),created_at:new Date};const f=p(n);l(e,{name:o,value:f,http_only:!0,max_age:30*24*60*60*1e3,same_site:"lax"})}s.cookies={...s?.cookies||{},[o]:n._id},s.context={...s?.context||{},session:n}}t()};var E=g;export{E as default};
