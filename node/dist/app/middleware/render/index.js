import k from"fs";import _ from"../../../lib/dynamic_import.js";import l from"../generate_joystick_error_page.js";import j from"../../../lib/get_joystick_build_path.js";import x from"../../../lib/get_translations.js";import v from"./get_url.js";import c from"../../../lib/path_exists.js";import z from"../../ssr/index.js";import d from"../../../lib/strip_preceeding_slash.js";import"../../../lib/get_browser_safe_request.js";const{readFile:A}=k.promises,s=j(),D=()=>A("index.html","utf-8"),T=(n,e,f,h={})=>{e.render=async(i="",t={})=>{const p=d(i),r=d(t?.layout),o=`${s}${p}`,a=t?.layout?`${s}${r}`:null;if(!await c(o))return e.status(404).send(l({type:"page_not_found",path:`res.render('${o}')`,frame:null,stack:`A page component at the path ${o} could not be found.`}));if(a&&!await c(a))return e.status(404).send(l({type:"layout_not_found",path:`res.render('${o}', { layout: '${r}' })`,frame:null,stack:`A layout component at the path ${t?.layout} could not be found.`}));const m=await _(`${o}?v=${new Date().getTime()}`),y=a?await _(`${a}?v=${new Date().getTime()}`):null,u={...t?.props||{}};a&&(u.page=m);const g=await D(),$=await x({joystick_build_path:s,render_component_path:i,req:n}),w=v(n),b=await z({api_schema:h?.options?.api,attributes:t?.attributes,base_html:g,component_options:{props:u,translations:$,url:w},component_to_render:y||m,head:t?.head,render_component_path:p,render_layout_path:r,req:n});return e.status(200).send(b)},f()};var N=T;export{N as default};
