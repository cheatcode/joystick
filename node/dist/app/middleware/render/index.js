import d from"fs";import h from"../../../lib/dynamic_import.js";import f from"../generate_joystick_error_page.js";import D from"../../../lib/get_joystick_build_path.js";import x from"../../../lib/get_translations.js";import O from"./get_url.js";import l from"../../../lib/path_exists.js";import V from"../../ssr/index.js";import y from"../../../lib/strip_preceeding_slash.js";const{readFile:z}=d.promises,i=D(),r=`${i}i18n`,A=await l(r)&&d.readdirSync(r)||[],g=()=>z("index.html","utf-8"),T=await g(),C=(a,n,$,s={})=>{n.render=async(c="",t={})=>{const p=y(c),m=y(t?.layout),o=`${i}${p}`,e=t?.layout?`${i}${m}`:null;if(!await l(o))return n.status(404).send(f({type:"page_not_found",path:`res.render('${o}')`,frame:null,stack:`A page component at the path ${o} could not be found.`}));if(e&&!await l(e))return n.status(404).send(f({type:"layout_not_found",path:`res.render('${o}', { layout: '${m}' })`,frame:null,stack:`A layout component at the path ${t?.layout} could not be found.`}));const w=process.env.NODE_ENV!=="development"?`${o}`:`${o}?v=${new Date().getTime()}`,v=process.env.NODE_ENV!=="development"?`${e}`:`${e}?v=${new Date().getTime()}`,u=await h(w),b=e?await h(v):null,_={...t?.props||{},theme:a?.cookies?.theme||"light"};e&&(_.page=u);const k=process.env.NODE_ENV!=="development"?T:await g(),E=await x({language_files:A,language_files_path:r,render_component_path:c,req:a}),N=O(a),j=await V({api_schema:s?.options?.api,attributes:t?.attributes,base_html:k,component_options:{props:_,translations:E,url:N},component_to_render:b||u,head:t?.head,render_component_path:p,render_layout_path:m,req:a,res:n,mod:t?.mod===!1?null:{in_use:!!s?.mod,css:s?.mod?.css||null,js:s?.mod?.js||null,theme:a?.cookies?.theme||s?.options?.mod?.default_theme||"light",components_in_use:t?.mod?.components}});return n.status(200).send(j)},$()};var M=C;export{M as default};
