import u from"fs";import d from"../../../lib/dynamic_import.js";import h from"../generate_joystick_error_page.js";import j from"../../../lib/get_joystick_build_path.js";import x from"../../../lib/get_translations.js";import O from"./get_url.js";import r from"../../../lib/path_exists.js";import V from"../../ssr/index.js";import f from"../../../lib/strip_preceeding_slash.js";const{readFile:z}=u.promises,p=j(),i=`${p}i18n`,A=await r(i)&&u.readdirSync(i)||[],y=()=>z("index.html","utf-8"),T=await y(),C=(n,o,g,$={})=>{o.render=async(m="",t={})=>{const c=f(m),s=f(t?.layout),e=`${p}${c}`,a=t?.layout?`${p}${s}`:null;if(!await r(e))return o.status(404).send(h({type:"page_not_found",path:`res.render('${e}')`,frame:null,stack:`A page component at the path ${e} could not be found.`}));if(a&&!await r(a))return o.status(404).send(h({type:"layout_not_found",path:`res.render('${e}', { layout: '${s}' })`,frame:null,stack:`A layout component at the path ${t?.layout} could not be found.`}));const w=process.env.NODE_ENV!=="development"?`${e}`:`${e}?v=${new Date().getTime()}`,v=process.env.NODE_ENV!=="development"?`${a}`:`${a}?v=${new Date().getTime()}`,l=await d(w),b=a?await d(v):null,_={...t?.props||{}};a&&(_.page=l);const E=process.env.NODE_ENV!=="development"?T:await y(),N=await x({language_files:A,language_files_path:i,render_component_path:m,req:n}),k=O(n),D=await V({api_schema:$?.options?.api,attributes:t?.attributes,base_html:E,component_options:{props:_,translations:N,url:k},component_to_render:b||l,head:t?.head,render_component_path:c,render_layout_path:s,req:n,mod:t?.mod||null});return o.status(200).send(D)},g()};var M=C;export{M as default};
