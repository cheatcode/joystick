import v from"fs";import c from"../../../lib/dynamic_import.js";import u from"../generate_joystick_error_page.js";import j from"../../../lib/get_joystick_build_path.js";import x from"../../../lib/get_translations.js";import D from"./get_url.js";import l from"../../../lib/path_exists.js";import z from"../../ssr/index.js";import d from"../../../lib/strip_preceeding_slash.js";import"../../../lib/get_browser_safe_request.js";const{readFile:A}=v.promises,s=j(),h=()=>A("index.html","utf-8"),E=await h(),N=(n,e,f,y={})=>{e.render=async(p="",t={})=>{const i=d(p),r=d(t?.layout),o=`${s}${i}`,a=t?.layout?`${s}${r}`:null;if(!await l(o))return e.status(404).send(u({type:"page_not_found",path:`res.render('${o}')`,frame:null,stack:`A page component at the path ${o} could not be found.`}));if(a&&!await l(a))return e.status(404).send(u({type:"layout_not_found",path:`res.render('${o}', { layout: '${r}' })`,frame:null,stack:`A layout component at the path ${t?.layout} could not be found.`}));const m=await c(`${o}?v=${new Date().getTime()}`),g=a?await c(`${a}?v=${new Date().getTime()}`):null,_={...t?.props||{}};a&&(_.page=m);const $=process.env.NODE_ENV!=="development"?E:await h(),w=await x({joystick_build_path:s,render_component_path:p,req:n}),b=D(n),k=await z({api_schema:y?.options?.api,attributes:t?.attributes,base_html:$,component_options:{props:_,translations:w,url:b},component_to_render:g||m,head:t?.head,render_component_path:i,render_layout_path:r,req:n});return e.status(200).send(k)},f()};var K=N;export{K as default};
