import k from"fs";import c from"../../../lib/dynamic_import.js";import l from"../generate_joystick_error_page.js";import D from"../../../lib/get_joystick_build_path.js";import j from"../../../lib/get_translations.js";import x from"./get_url.js";import u from"../../../lib/path_exists.js";import O from"../../ssr/index.js";import d from"../../../lib/strip_preceeding_slash.js";import"../../../lib/get_browser_safe_request.js";const{readFile:V}=k.promises,r=D(),h=()=>V("index.html","utf-8"),z=await h(),A=(n,a,f,y={})=>{a.render=async(p="",t={})=>{const m=d(p),s=d(t?.layout),e=`${r}${m}`,o=t?.layout?`${r}${s}`:null;if(!await u(e))return a.status(404).send(l({type:"page_not_found",path:`res.render('${e}')`,frame:null,stack:`A page component at the path ${e} could not be found.`}));if(o&&!await u(o))return a.status(404).send(l({type:"layout_not_found",path:`res.render('${e}', { layout: '${s}' })`,frame:null,stack:`A layout component at the path ${t?.layout} could not be found.`}));const $=process.env.NODE_ENV!=="development"?`${e}`:`${e}?v=${new Date().getTime()}`,g=process.env.NODE_ENV!=="development"?`${o}`:`${o}?v=${new Date().getTime()}`,i=await c($),w=o?await c(g):null,_={...t?.props||{}};o&&(_.page=i);const b=process.env.NODE_ENV!=="development"?z:await h(),v=await j({joystick_build_path:r,render_component_path:p,req:n}),E=x(n),N=await O({api_schema:y?.options?.api,attributes:t?.attributes,base_html:b,component_options:{props:_,translations:v,url:E},component_to_render:w||i,head:t?.head,render_component_path:m,render_layout_path:s,req:n});return a.status(200).send(N)},f()};var P=A;export{P as default};
