import t from"../databases/queries/sessions.js";import a from"../../lib/set_cookie.js";import _ from"../settings/load.js";const l=async(s,c,o)=>{const e=s?.headers?.["x-push-instance-token"];if(e&&_()?.private?.cheatcode?.is_push){const n=await process.databases.mongodb.collection("instances").findOne({token:{$eq:e}});if(console.log("INSTANCE MATCHES",e,!!n),n)return o()}if(s?.url?.includes("/api/_push/health"))return o();let i=s?.cookies?.joystick_session;(i?await t("get_session",{session_id:i}):null)||(i=await t("create_session"),a(c,"joystick_session",i)),s.cookies={...s?.cookies||{},joystick_session:i},s.context={...s?.context||{},session:await t("get_session",{session_id:i})},o()};var k=l;export{k as default};
