import u from"compression";import h from"cookie-parser";import w from"cors";import c from"express";import g from"serve-favicon";import j from"fs/promises";import n from"path";import b from"./account.js";import y from"./body_parser.js";import v from"./build_error.js";import k from"./csp.js";import x from"./context.js";import E from"./detect_device_type.js";import N from"../../lib/get_joystick_build_path.js";import D from"./hmr_client.js";import H from"./insecure.js";import"../../lib/path_exists.js";import O from"./process_browser_polyfill.js";import V from"./render/index.js";import W from"./request_methods.js";import $ from"./cookie_session.js";const P=N(),z=async(e,a={})=>{const s=await j.readdir(e),o=s.includes("favicon.png"),d=s.includes("favicon.ico");if(a.prefer_png){if(o)return n.join(e,"favicon.png");if(d)return n.join(e,"favicon.ico")}else{if(d)return n.join(e,"favicon.ico");if(o)return n.join(e,"favicon.png")}return null},p=await z("public",{prefer_png:!0}),_=e=>e.path.startsWith("/api/")||e.path.startsWith("/_api/"),A=e=>!_(e),f=(e,a)=>(s,o,d)=>{if(a(s))return e(s,o,d);d()},B=(e={})=>({global:[...[],(i,r,t)=>{i.app.get("trust proxy")||i.app.set("trust proxy",1),t()},v,(i,r,t)=>{if(!["development","test"].includes(process.env.NODE_ENV))return H(i,r,t);t()},(i,r,t)=>{if(process.env.NODE_ENV!=="development")return u()(i,r,t);t()},c.static("public"),{path:"/_joystick/utils/process.js",middleware:O},{path:"/_joystick/index.client.js",middleware:c.static(`${e?.joystick_build_path}index.client.js`)},{path:"/_joystick/index.css",middleware:c.static(`${e?.joystick_build_path}index.css`)},{path:"/_joystick/ui",middleware:c.static(`${e?.joystick_build_path||P}/ui`)},{path:"/_joystick/css",middleware:c.static("css")},{path:"/_joystick/mod/mod-light.css",middleware:(i={},r={},t)=>(r.setHeader("content-type","text/css"),r.status(200).send(e?.mod?.css?.light||""))},{path:"/_joystick/mod/mod-dark.css",middleware:(i={},r={},t)=>(r.setHeader("content-type","text/css"),r.status(200).send(e?.mod?.css?.dark||""))},{path:"/_joystick/mod/mod.js",middleware:(i={},r={},t)=>(r.setHeader("content-type","text/javascript"),r.status(200).send(e?.mod?.js?.iife||""))},{path:"/css",middleware:c.static("css")},h(),y(e?.middleware_config?.bodyParser),w(e?.middleware_config?.cors,e?.port),W,(i,r,t)=>{i.device=E(i),t()},$,(i,r,t)=>{if(process.databases?._users)return b(i,r,t);t()},x,(i,r,t)=>{if(e?.middleware_config?.public_paths?.length>0)for(let m=0;m<e?.middleware_config?.public_paths?.length;m+=1){const l=e?.middleware_config?.public_paths[m];if(i.path.startsWith(l?.route))return c.static(l?.directory)(i,r,t)}t()}],ui:[(i,r,t)=>{if(e?.csp_config)return k(i,r,t,e?.csp_config);t()},async(i,r,t)=>{p?g(p)(i,r,t):t()},(i,r,t)=>V(i,r,t,e?.app_instance),(i,r,t)=>{if(process.env.NODE_ENV==="development"&&i.path==="/_joystick/hmr/client.js")return D(i,r,t);t()}],api:[]}),C=(e,a)=>{for(let s=0;s<a.global.length;s+=1){const o=a.global[s];typeof o=="object"&&o.path&&o.middleware?e.use(o.path,o.middleware):e.use(o)}for(let s=0;s<a.ui.length;s+=1)e.use(f(a.ui[s],A));for(let s=0;s<a.api.length;s+=1)e.use(f(a.api[s],_))},F=(e={})=>{const a=B(e);C(e.express_app,a)};var ce=F;export{ce as default};
