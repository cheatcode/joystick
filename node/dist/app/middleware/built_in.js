import f from"compression";import u from"cookie-parser";import h from"cors";import c from"express";import w from"serve-favicon";import g from"fs/promises";import l from"path";import b from"./account.js";import v from"./body_parser.js";import j from"./build_error.js";import y from"./csp.js";import k from"./context.js";import E from"./detect_device_type.js";import N from"../../lib/get_joystick_build_path.js";import D from"./hmr_client.js";import O from"./insecure.js";import"../../lib/path_exists.js";import V from"./process_browser_polyfill.js";import W from"./render/index.js";import P from"./request_methods.js";import z from"./cookie_session.js";const A=N(),B=async(i,a={})=>{const t=await g.readdir(i),s=t.includes("favicon.png"),e=t.includes("favicon.ico");if(a.prefer_png){if(s)return l.join(i,"favicon.png");if(e)return l.join(i,"favicon.ico")}else{if(e)return l.join(i,"favicon.ico");if(s)return l.join(i,"favicon.png")}return null},n=await B("public",{prefer_png:!0}),d=i=>i.path.startsWith("/api/")||i.path.startsWith("/_api/"),C=i=>!d(i),_=(i,a)=>(t,s,e)=>{if(a(t))return i(t,s,e);e()},F=(i={})=>({global:[(e,o,r)=>{e.app.get("trust proxy")||e.app.set("trust proxy",1),r()},j,(e,o,r)=>{if(!["development","test"].includes(process.env.NODE_ENV))return O(e,o,r);r()},(e,o,r)=>{if(process.env.NODE_ENV!=="development")return f()(e,o,r);r()},c.static("public"),{path:"/_joystick/utils/process.js",middleware:V},{path:"/_joystick",middleware:c.static(i?.joystick_build_path||A)},{path:"/css",middleware:c.static("css")},{path:"/_joystick/css",middleware:c.static("css")},u(),v(i?.middleware_config?.bodyParser),h(i?.middleware_config?.cors,i?.port),P,(e,o,r)=>{e.device=E(e),r()},z,(e,o,r)=>{if(process.databases?._users)return b(e,o,r);r()},k,(e,o,r)=>{if(i?.middleware_config?.public_paths?.length>0)for(let m=0;m<i?.middleware_config?.public_paths?.length;m+=1){const p=i?.middleware_config?.public_paths[m];if(e.path.startsWith(p?.route))return c.static(p?.directory)(e,o,r)}r()}],ui:[(e,o,r)=>{if(i?.csp_config)return y(e,o,r,i?.csp_config);r()},async(e,o,r)=>{n?w(n)(e,o,r):r()},(e,o,r)=>W(e,o,r,i?.app_instance),(e,o,r)=>{if(process.env.NODE_ENV==="development"&&e.path==="/_joystick/hmr/client.js")return D(e,o,r);r()}],api:[]}),G=(i,a)=>{for(let t=0;t<a.global.length;t+=1){const s=a.global[t];typeof s=="object"&&s.path&&s.middleware?i.use(s.path,s.middleware):i.use(s)}for(let t=0;t<a.ui.length;t+=1)i.use(_(a.ui[t],C));for(let t=0;t<a.api.length;t+=1)i.use(_(a.api[t],d))},H=(i={})=>{const a=F(i);G(i.express_app,a)};var si=H;export{si as default};
