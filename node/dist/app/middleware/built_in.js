import u from"compression";import h from"cookie-parser";import g from"cors";import c from"express";import w from"serve-favicon";import j from"fs/promises";import m from"path";import b from"./account.js";import y from"./body_parser.js";import v from"./build_error.js";import k from"./csp.js";import E from"./context.js";import x from"./detect_device_type.js";import N from"../../lib/get_joystick_build_path.js";import D from"./hmr_client.js";import O from"./insecure.js";import"../../lib/path_exists.js";import W from"./process_browser_polyfill.js";import $ from"./render/index.js";import H from"./request_methods.js";import S from"./cookie_session.js";const V=N(),P=async(e,o={})=>{const s=await j.readdir(e),a=s.includes("favicon.png"),n=s.includes("favicon.ico");if(o.prefer_png){if(a)return m.join(e,"favicon.png");if(n)return m.join(e,"favicon.ico")}else{if(n)return m.join(e,"favicon.ico");if(a)return m.join(e,"favicon.png")}return null},p=await P("public",{prefer_png:!0}),_=e=>e.path.startsWith("/api/")||e.path.startsWith("/_api/"),R=e=>!_(e),f=(e,o)=>(s,a,n)=>{if(o(s))return e(s,a,n);n()},T=(e={})=>({global:[...[],(t,r,i)=>{t.app.get("trust proxy")||t.app.set("trust proxy",1),i()},v,(t,r,i)=>{if(!["development","test"].includes(process.env.NODE_ENV))return O(t,r,i);i()},(t,r,i)=>{if(process.env.NODE_ENV!=="development")return u()(t,r,i);i()},c.static("public"),{path:"/_joystick/utils/process.js",middleware:W},{path:"/_joystick/index.client.js",middleware:c.static(`${e?.joystick_build_path}index.client.js`)},{path:"/_joystick/index.css",middleware:c.static(`${e?.joystick_build_path}index.css`)},{path:"/_joystick/ui",middleware:c.static(`${e?.joystick_build_path||V}/ui`)},{path:"/_joystick/css",middleware:c.static("css")},{path:"/_joystick/mod/mod-light.css",middleware:(t={},r={},i)=>(r.setHeader("content-type","text/css"),r.status(200).send(e?.mod?.css?.light||""))},{path:"/_joystick/mod/mod-dark.css",middleware:(t={},r={},i)=>(r.setHeader("content-type","text/css"),r.status(200).send(e?.mod?.css?.dark||""))},{path:"/_joystick/mod/mod.js",middleware:(t={},r={},i)=>(r.setHeader("content-type","text/javascript"),r.status(200).send(e?.mod?.js?.iife||""))},{path:"/css",middleware:c.static("css")},h(),(t,r,i)=>{const d=t.headers["content-length"]||t.headers["Content-Length"],l=t.headers["transfer-encoding"]||t.headers["Transfer-Encoding"];console.log(`[${new Date().toISOString()}] RAW REQUEST`,{ip:t.ip,method:t.method,url:t.originalUrl,content_length:d,transfer_encoding:l,user_agent:t.headers["user-agent"]}),i()},y(e?.middleware_config?.bodyParser),g(e?.middleware_config?.cors,e?.port),H,(t,r,i)=>{t.device=x(t),i()},S,(t,r,i)=>{if(process.databases?._users)return b(t,r,i);i()},E,(t,r,i)=>{if(e?.middleware_config?.public_paths?.length>0)for(let d=0;d<e?.middleware_config?.public_paths?.length;d+=1){const l=e?.middleware_config?.public_paths[d];if(t.path.startsWith(l?.route))return c.static(l?.directory)(t,r,i)}i()}],ui:[(t,r,i)=>{if(e?.csp_config)return k(t,r,i,e?.csp_config);i()},async(t,r,i)=>{p?w(p)(t,r,i):i()},(t,r,i)=>$(t,r,i,e?.app_instance),(t,r,i)=>{if(process.env.NODE_ENV==="development"&&t.path==="/_joystick/hmr/client.js")return D(t,r,i);i()}],api:[]}),U=(e,o)=>{for(let s=0;s<o.global.length;s+=1){const a=o.global[s];typeof a=="object"&&a.path&&a.middleware?e.use(a.path,a.middleware):e.use(a)}for(let s=0;s<o.ui.length;s+=1)e.use(f(o.ui[s],R));for(let s=0;s<o.api.length;s+=1)e.use(f(o.api[s],_))},A=(e={})=>{const o=T(e);U(e.express_app,o)};var ce=A;export{ce as default};
