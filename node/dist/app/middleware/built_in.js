import u from"compression";import h from"cookie-parser";import w from"cors";import c from"express";import g from"serve-favicon";import b from"fs/promises";import d from"path";import j from"./account.js";import v from"./body_parser.js";import y from"./build_error.js";import k from"./csp.js";import E from"./context.js";import N from"./detect_device_type.js";import D from"../../lib/get_joystick_build_path.js";import O from"./hmr_client.js";import V from"./insecure.js";import"../../lib/path_exists.js";import W from"./process_browser_polyfill.js";import $ from"./render/index.js";import P from"./request_methods.js";import x from"./cookie_session.js";const z=D(),A=async(i,a={})=>{const r=await b.readdir(i),s=r.includes("favicon.png"),l=r.includes("favicon.ico");if(a.prefer_png){if(s)return d.join(i,"favicon.png");if(l)return d.join(i,"favicon.ico")}else{if(l)return d.join(i,"favicon.ico");if(s)return d.join(i,"favicon.png")}return null},p=await A("public",{prefer_png:!0}),_=i=>i.path.startsWith("/api/")||i.path.startsWith("/_api/"),B=i=>!_(i),f=(i,a)=>(r,s,l)=>{if(a(r))return i(r,s,l);l()},C=(i={})=>({global:[...[],(t,o,e)=>{t.app.get("trust proxy")||t.app.set("trust proxy",1),e()},y,(t,o,e)=>{if(!["development","test"].includes(process.env.NODE_ENV))return V(t,o,e);e()},(t,o,e)=>{if(process.env.NODE_ENV!=="development")return u()(t,o,e);e()},c.static("public"),{path:"/_joystick/utils/process.js",middleware:W},{path:"/_joystick/index.client.js",middleware:c.static(`${i?.joystick_build_path}index.client.js`)},{path:"/_joystick/index.css",middleware:c.static(`${i?.joystick_build_path}index.css`)},{path:"/_joystick/ui",middleware:c.static(`${i?.joystick_build_path||z}/ui`)},{path:"/_joystick/css",middleware:c.static("css")},{path:"/css",middleware:c.static("css")},h(),v(i?.middleware_config?.bodyParser),w(i?.middleware_config?.cors,i?.port),P,(t,o,e)=>{t.device=N(t),e()},x,(t,o,e)=>{if(process.databases?._users)return j(t,o,e);e()},E,(t,o,e)=>{if(i?.middleware_config?.public_paths?.length>0)for(let n=0;n<i?.middleware_config?.public_paths?.length;n+=1){const m=i?.middleware_config?.public_paths[n];if(t.path.startsWith(m?.route))return c.static(m?.directory)(t,o,e)}e()}],ui:[(t,o,e)=>{if(i?.csp_config)return k(t,o,e,i?.csp_config);e()},async(t,o,e)=>{p?g(p)(t,o,e):e()},(t,o,e)=>$(t,o,e,i?.app_instance),(t,o,e)=>{if(process.env.NODE_ENV==="development"&&t.path==="/_joystick/hmr/client.js")return O(t,o,e);e()}],api:[]}),F=(i,a)=>{for(let r=0;r<a.global.length;r+=1){const s=a.global[r];typeof s=="object"&&s.path&&s.middleware?i.use(s.path,s.middleware):i.use(s)}for(let r=0;r<a.ui.length;r+=1)i.use(f(a.ui[r],B));for(let r=0;r<a.api.length;r+=1)i.use(f(a.api[r],_))},G=(i={})=>{const a=C(i);F(i.express_app,a)};var ci=G;export{ci as default};
