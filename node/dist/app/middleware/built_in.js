import h from"compression";import w from"cookie-parser";import j from"cors";import o from"express";import b from"serve-favicon";import g from"fs/promises";import l from"path";import y from"./account.js";import k from"./body_parser.js";import v from"./build_error.js";import $ from"./csp.js";import E from"./context.js";import N from"./detect_device_type.js";import D from"../../lib/get_joystick_build_path.js";import O from"./hmr_client.js";import V from"./insecure.js";import"../../lib/path_exists.js";import W from"./process_browser_polyfill.js";import P from"./render/index.js";import x from"./request_methods.js";import z from"./cookie_session.js";const d=D(),A=async(i,a={})=>{const r=await g.readdir(i),c=r.includes("favicon.png"),m=r.includes("favicon.ico");if(a.prefer_png){if(c)return l.join(i,"favicon.png");if(m)return l.join(i,"favicon.ico")}else{if(m)return l.join(i,"favicon.ico");if(c)return l.join(i,"favicon.png")}return null},n=await A("public",{prefer_png:!0}),u=i=>i.path.startsWith("/api/")||i.path.startsWith("/_api/"),B=i=>!u(i),f=(i,a)=>(r,c,m)=>{if(a(r))return i(r,c,m);m()},C=(i={})=>({global:[...[],(e,s,t)=>{e.app.get("trust proxy")||e.app.set("trust proxy",1),t()},v,(e,s,t)=>{if(!["development","test"].includes(process.env.NODE_ENV))return V(e,s,t);t()},(e,s,t)=>{if(process.env.NODE_ENV!=="development")return h()(e,s,t);t()},o.static("public"),{path:"/_joystick/utils/process.js",middleware:W},{path:"/_joystick/index.client.js",middleware:o.static(`${i?.joystick_build_path}index.client.js`)},{path:"/_joystick/index.css",middleware:o.static(`${i?.joystick_build_path}index.css`)},{path:"/_joystick/ui",middleware:o.static(`${i?.joystick_build_path||d}/ui`)},{path:"/_joystick/css",middleware:o.static("css")},{path:"/css",middleware:o.static("css")},{path:"/_joystick/mod/mod-light.css",middleware:o.static(`${i?.joystick_build_path||d}/private/mod/mod-light.min.css`)},{path:"/_joystick/mod/mod-light-plus.css",middleware:o.static(`${i?.joystick_build_path||d}/private/mod/mod-light-plus.min.css`)},{path:"/_joystick/mod/mod-dark.css",middleware:o.static(`${i?.joystick_build_path||d}/private/mod/mod-dark.min.css`)},{path:"/_joystick/mod/mod-dark-plus.css",middleware:o.static(`${i?.joystick_build_path||d}/private/mod/mod-dark-plus.min.css`)},{path:"/_joystick/mod/mod.js",middleware:o.static(`${i?.joystick_build_path||d}/lib/mod.esm.min.js`)},{path:"/_joystick/mod/mod-plus.js",middleware:o.static(`${i?.joystick_build_path||d}/lib/mod-plus.esm.min.js`)},w(),k(i?.middleware_config?.bodyParser),j(i?.middleware_config?.cors,i?.port),x,(e,s,t)=>{e.device=N(e),t()},z,(e,s,t)=>{if(process.databases?._users)return y(e,s,t);t()},E,(e,s,t)=>{if(i?.middleware_config?.public_paths?.length>0)for(let p=0;p<i?.middleware_config?.public_paths?.length;p+=1){const _=i?.middleware_config?.public_paths[p];if(e.path.startsWith(_?.route))return o.static(_?.directory)(e,s,t)}t()}],ui:[(e,s,t)=>{if(i?.csp_config)return $(e,s,t,i?.csp_config);t()},async(e,s,t)=>{n?b(n)(e,s,t):t()},(e,s,t)=>P(e,s,t,i?.app_instance),(e,s,t)=>{if(process.env.NODE_ENV==="development"&&e.path==="/_joystick/hmr/client.js")return O(e,s,t);t()}],api:[]}),F=(i,a)=>{for(let r=0;r<a.global.length;r+=1){const c=a.global[r];typeof c=="object"&&c.path&&c.middleware?i.use(c.path,c.middleware):i.use(c)}for(let r=0;r<a.ui.length;r+=1)i.use(f(a.ui[r],B));for(let r=0;r<a.api.length;r+=1)i.use(f(a.api[r],u))},G=(i={})=>{const a=C(i);F(i.express_app,a)};var ci=G;export{ci as default};
