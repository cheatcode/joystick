import d from"compression";import u from"cookie-parser";import h from"cors";import p from"express";import g from"serve-favicon";import w from"fs/promises";import n from"path";import b from"./account.js";import v from"./body_parser.js";import j from"./build_error.js";import y from"./csp.js";import k from"./context.js";import E from"./detect_device_type.js";import N from"../../lib/get_joystick_build_path.js";import W from"./hmr_client.js";import D from"./insecure.js";import"../../lib/path_exists.js";import O from"./process_browser_polyfill.js";import V from"./render/index.js";import P from"./request_methods.js";import z from"./cookie_session.js";const si=N(),A=async(t,s={})=>{const o=await w.readdir(t),a=o.includes("favicon.png"),i=o.includes("favicon.ico");if(s.prefer_png){if(a)return n.join(t,"favicon.png");if(i)return n.join(t,"favicon.ico")}else{if(i)return n.join(t,"favicon.ico");if(a)return n.join(t,"favicon.png")}return null},m=await A("public",{prefer_png:!0}),_=t=>t.path.startsWith("/api/")||t.path.startsWith("/_api/"),B=t=>!_(t),f=(t,s)=>(o,a,i)=>{if(s(o))return t(o,a,i);i()},C=(t={})=>({global:[(i,e,r)=>{i.app.get("trust proxy")||i.app.set("trust proxy",1),r()},j,(i,e,r)=>{if(!["development","test"].includes(process.env.NODE_ENV))return D(i,e,r);r()},(i,e,r)=>{if(process.env.NODE_ENV!=="development")return d()(i,e,r);r()},p.static("public"),(i,e,r)=>{if(i.path==="/_joystick/utils/process.js")return O(i,e,r);r()},(i,e,r)=>{if(i.path.startsWith("/_joystick"))return p.static(t?.joystick_build_path)(i,e,r);r()},(i,e,r)=>{if(i.path.startsWith("/css")||i.path.startsWith("/_joystick/css"))return p.static("css")(i,e,r);r()},u(),v(t?.middleware_config?.bodyParser),h(t?.middleware_config?.cors,t?.port),P,(i,e,r)=>{i.device=E(i),r()},z,(i,e,r)=>{if(process.databases?._users)return b(i,e,r);r()},k,(i,e,r)=>{if(t?.middleware_config?.public_paths?.length>0)for(let c=0;c<t?.middleware_config?.public_paths?.length;c+=1){const l=t?.middleware_config?.public_paths[c];if(i.path.startsWith(l?.route))return p.static(l?.directory)(i,e,r)}r()}],ui:[(i,e,r)=>{if(t?.csp_config)return y(i,e,r,t?.csp_config);r()},async(i,e,r)=>{m?g(m)(i,e,r):r()},(i,e,r)=>V(i,e,r,t?.app_instance),(i,e,r)=>{if(process.env.NODE_ENV==="development"&&i.path==="/_joystick/hmr/client.js")return W(i,e,r);r()}],api:[]}),F=(t,s)=>{for(let o=0;o<s.global.length;o+=1)t.use(s.global[o]);for(let o=0;o<s.ui.length;o+=1)t.use(f(s.ui[o],B));for(let o=0;o<s.api.length;o+=1)t.use(f(s.api[o],_))},G=(t={})=>{const s=C(t);F(t.express_app,s)};var ai=G;export{ai as default};
