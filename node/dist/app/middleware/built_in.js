import u from"compression";import h from"cookie-parser";import w from"cors";import c from"express";import g from"serve-favicon";import j from"fs/promises";import m from"path";import b from"./account.js";import y from"./body_parser.js";import k from"./build_error.js";import v from"./csp.js";import x from"./context.js";import E from"./detect_device_type.js";import N from"../../lib/get_joystick_build_path.js";import D from"./hmr_client.js";import H from"./insecure.js";import"../../lib/path_exists.js";import O from"./process_browser_polyfill.js";import V from"./render/index.js";import W from"./request_methods.js";import $ from"./cookie_session.js";const P=N(),z=async(e,o={})=>{const s=await j.readdir(e),a=s.includes("favicon.png"),d=s.includes("favicon.ico");if(o.prefer_png){if(a)return m.join(e,"favicon.png");if(d)return m.join(e,"favicon.ico")}else{if(d)return m.join(e,"favicon.ico");if(a)return m.join(e,"favicon.png")}return null},p=await z("public",{prefer_png:!0}),_=e=>e.path.startsWith("/api/")||e.path.startsWith("/_api/"),A=e=>!_(e),f=(e,o)=>(s,a,d)=>{if(o(s))return e(s,a,d);d()},B=(e={})=>({global:[...[],(i,r,t)=>{i.app.get("trust proxy")||i.app.set("trust proxy",1),t()},k,(i,r,t)=>{if(!["development","test"].includes(process.env.NODE_ENV))return H(i,r,t);t()},(i,r,t)=>{if(process.env.NODE_ENV!=="development")return u()(i,r,t);t()},c.static("public"),{path:"/_joystick/utils/process.js",middleware:O},{path:"/_joystick/index.client.js",middleware:c.static(`${e?.joystick_build_path}index.client.js`)},{path:"/_joystick/index.css",middleware:c.static(`${e?.joystick_build_path}index.css`)},{path:"/_joystick/ui",middleware:c.static(`${e?.joystick_build_path||P}/ui`)},{path:"/_joystick/css",middleware:c.static("css")},{path:"/_joystick/mod/mod-light.css",middleware:(i={},r={},t)=>(r.setHeader("content-type","text/css"),r.status(200).send(e?.mod?.css?.light||""))},{path:"/_joystick/mod/mod-dark.css",middleware:(i={},r={},t)=>(r.setHeader("content-type","text/css"),r.status(200).send(e?.mod?.css?.dark||""))},{path:"/_joystick/mod/mod.js",middleware:(i={},r={},t)=>(r.setHeader("content-type","text/javascript"),r.status(200).send(e?.mod?.js?.iife||""))},{path:"/css",middleware:c.static("css")},h(),(i={},r={},t)=>{i?.cookies?.theme||r.cookie("theme","light"),t()},y(e?.middleware_config?.bodyParser),w(e?.middleware_config?.cors,e?.port),W,(i,r,t)=>{i.device=E(i),t()},$,(i,r,t)=>{if(process.databases?._users)return b(i,r,t);t()},x,(i,r,t)=>{if(e?.middleware_config?.public_paths?.length>0)for(let n=0;n<e?.middleware_config?.public_paths?.length;n+=1){const l=e?.middleware_config?.public_paths[n];if(i.path.startsWith(l?.route))return c.static(l?.directory)(i,r,t)}t()}],ui:[(i,r,t)=>{if(e?.csp_config)return v(i,r,t,e?.csp_config);t()},async(i,r,t)=>{p?g(p)(i,r,t):t()},(i,r,t)=>V(i,r,t,e?.app_instance),(i,r,t)=>{if(process.env.NODE_ENV==="development"&&i.path==="/_joystick/hmr/client.js")return D(i,r,t);t()}],api:[]}),C=(e,o)=>{for(let s=0;s<o.global.length;s+=1){const a=o.global[s];typeof a=="object"&&a.path&&a.middleware?e.use(a.path,a.middleware):e.use(a)}for(let s=0;s<o.ui.length;s+=1)e.use(f(o.ui[s],A));for(let s=0;s<o.api.length;s+=1)e.use(f(o.api[s],_))},F=(e={})=>{const o=B(e);C(e.express_app,o)};var ce=F;export{ce as default};
