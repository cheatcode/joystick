import h from"compression";import w from"cookie-parser";import g from"cors";import c from"express";import b from"serve-favicon";import j from"fs/promises";import m from"path";import y from"./account.js";import v from"./body_parser.js";import k from"./build_error.js";import $ from"./csp.js";import E from"./context.js";import N from"./detect_device_type.js";import D from"../../lib/get_joystick_build_path.js";import O from"./hmr_client.js";import V from"./insecure.js";import"../../lib/path_exists.js";import W from"./process_browser_polyfill.js";import P from"./render/index.js";import x from"./request_methods.js";import z from"./cookie_session.js";const l=D(),A=async(i,o={})=>{const r=await j.readdir(i),a=r.includes("favicon.png"),d=r.includes("favicon.ico");if(o.prefer_png){if(a)return m.join(i,"favicon.png");if(d)return m.join(i,"favicon.ico")}else{if(d)return m.join(i,"favicon.ico");if(a)return m.join(i,"favicon.png")}return null},n=await A("public",{prefer_png:!0}),f=i=>i.path.startsWith("/api/")||i.path.startsWith("/_api/"),B=i=>!f(i),u=(i,o)=>(r,a,d)=>{if(o(r))return i(r,a,d);d()},C=(i={})=>({global:[...[],(t,s,e)=>{t.app.get("trust proxy")||t.app.set("trust proxy",1),e()},k,(t,s,e)=>{if(!["development","test"].includes(process.env.NODE_ENV))return V(t,s,e);e()},(t,s,e)=>{if(process.env.NODE_ENV!=="development")return h()(t,s,e);e()},c.static("public"),{path:"/_joystick/utils/process.js",middleware:W},{path:"/_joystick/index.client.js",middleware:c.static(`${i?.joystick_build_path}index.client.js`)},{path:"/_joystick/index.css",middleware:c.static(`${i?.joystick_build_path}index.css`)},{path:"/_joystick/ui",middleware:c.static(`${i?.joystick_build_path||l}/ui`)},{path:"/_joystick/css",middleware:c.static("css")},{path:"/css",middleware:c.static("css")},{path:"/_joystick/mod/mod-light.css",middleware:c.static(`${i?.joystick_build_path||l}/private/mod/mod-light${i?.mod?.version==="plus"?"-plus":""}.min.css`)},{path:"/_joystick/mod/mod-dark.css",middleware:c.static(`${i?.joystick_build_path||l}/private/mod/mod-dark${i?.mod?.version==="plus"?"-plus":""}.min.css`)},{path:"/_joystick/mod/mod.js",middleware:c.static(`${i?.joystick_build_path||l}/lib/mod${i?.mod?.version==="plus"?"-plus":""}.min.css`)},w(),v(i?.middleware_config?.bodyParser),g(i?.middleware_config?.cors,i?.port),x,(t,s,e)=>{t.device=N(t),e()},z,(t,s,e)=>{if(process.databases?._users)return y(t,s,e);e()},E,(t,s,e)=>{if(i?.middleware_config?.public_paths?.length>0)for(let p=0;p<i?.middleware_config?.public_paths?.length;p+=1){const _=i?.middleware_config?.public_paths[p];if(t.path.startsWith(_?.route))return c.static(_?.directory)(t,s,e)}e()}],ui:[(t,s,e)=>{if(i?.csp_config)return $(t,s,e,i?.csp_config);e()},async(t,s,e)=>{n?b(n)(t,s,e):e()},(t,s,e)=>P(t,s,e,i?.app_instance),(t,s,e)=>{if(process.env.NODE_ENV==="development"&&t.path==="/_joystick/hmr/client.js")return O(t,s,e);e()}],api:[]}),F=(i,o)=>{for(let r=0;r<o.global.length;r+=1){const a=o.global[r];typeof a=="object"&&a.path&&a.middleware?i.use(a.path,a.middleware):i.use(a)}for(let r=0;r<o.ui.length;r+=1)i.use(u(o.ui[r],B));for(let r=0;r<o.api.length;r+=1)i.use(u(o.api[r],f))},G=(i={})=>{const o=C(i);F(i.express_app,o)};var ci=G;export{ci as default};
