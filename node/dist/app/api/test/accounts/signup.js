import r from"../../../databases/queries/accounts.js";import m from"../../../accounts/default_user_output_fields.js";import p from"../../format_api_error.js";import d from"../../handle_api_error.js";import c from"../../validate_input.js";import y from"../../../accounts/signup.js";const l=async(t={},s={})=>{try{const a=await r("user",{email_address:t?.body?.emailAddress||t?.body?.email_address}),u=await r("user",{username:t?.body?.username}),e=a||u;e&&await r("delete_user",{user_id:e?._id||e?.user_id});const i=process.joystick?.app_options?.accounts?.signup?.metadata,n=i?await c(t?.body?.metadata,i):[];if(n?.length>0)return d("accounts.signup",{errors:n.map(_=>p(new Error(_),"accounts.signup.metadata",401))},s);const o=await y({email_address:t?.body?.emailAddress||t?.body?.email_address,username:t?.body?.username,password:t?.body?.password,metadata:t?.body?.metadata,output:t?.body?.output||m});s.status(200).send(JSON.stringify({...o?.user||{},joystick_login_token:o?.token,joystick_login_token_expires_at:o?.token_expires_at}))}catch(a){d("test.accounts.signup",a,s)}};var x=l;export{x as default};
