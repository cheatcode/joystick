import h from"events";import S from"query-string";import*as y from"ws";import a from"../../test/track_function_call.js";import l from"../../lib/types.js";const j=(e={},s={})=>{e.on("upgrade",(n,r,o)=>{if(n?.url?.includes("/api/_websockets")){const t=(n?.url?.replace("/api/_websockets/","")?.split("?")||[])[0],p=s[t];p&&p.server.handleUpgrade(n,r,o,O=>{p.server.emit("connection",O,n)})}})},$=(e={},s={},n={})=>{const r=Object.assign(e,{params:s});(l.is_function(n?.onOpen)||l.is_function(n?.on_open))&&(n?.onOpen||n?.on_open)(r),e.on("message",o=>{const t=JSON.parse(o);l.is_function(n?.on_message)&&n?.on_message(t,e)}),e.on("close",(o=0,t="")=>{l.is_function(n?.on_close)&&n?.on_close(o,t?.toString(),e)})},u=(e="",s={},n={})=>{const r=new h,o=s?.id?`${e}_${s?.id}`:e;joystick?.emitters&&joystick?.emitters[o]?joystick.emitters[o].push(r):joystick.emitters={...joystick?.emitters||{},[o]:[r]},r.on("message",(t={})=>{n.send(JSON.stringify(t))}),r.on("progress",(t={})=>{n.send(JSON.stringify({type:"PROGRESS",...t}))})},C=(e={})=>{const[s,n]=e?.url?.split("?");return S.parse(n)},E=(e="",s={})=>{s?.server.on("connection",(n={},r={})=>{const o=C(r);u(e,o,n),$(n,o,s)})},c=(e="",s={},n=[])=>(a(`node.websockets.${e}.on_close`,n),s?.onClose||s?.on_close?(s?.onClose||s?.on_close)(...n):null),m=(e="",s={},n=[])=>(a(`node.websockets.${e}.on_message`,n),s?.onMessage||s?.on_message?(s?.onMessage||s?.on_message)(...n):null),g=(e="",s={},n=[])=>(a(`node.websockets.${e}.on_open`,n),s?.onOpen||s?.on_open?(s?.onOpen||s?.on_open)(...n):null),v=(e="")=>new y.WebSocketServer({noServer:!0,path:`/api/_websockets/${e}`}),J=(e={})=>({uploaders:{server:v("uploaders")},...Object.entries(e||{}).reduce((s={},[n,r])=>(s[n]={server:v(n),on_open:(...o)=>g(n,r,o),onOpen:(...o)=>g(n,r,o),on_message:(...o)=>m(n,r,o),onMessage:(...o)=>m(n,r,o),on_close:(...o)=>c(n,r,o),onClose:(...o)=>c(n,r,o)},s),{})}),M=(e={},s={})=>{const n=J(e),r=Object.entries(n);for(let o=0;o<r?.length;o+=1){const[t,p]=r[o];E(t,p)}j(s.express.server,n)};var W=M;export{W as default};
