import r from"winston";import u from"fs";import _ from"path";import{readFile as g}from"fs/promises";import d from"../../lib/path_exists.js";import w from"../../lib/generate_id.js";import h from"../../lib/push_encrypt.js";import k from"./external_transport.js";import y from"../../lib/websocket_client.js";const{mkdir:E}=u.promises,x=r.format(i=>({...i,message:h(i.message,process.env.PUSH_INSTANCE_TOKEN)})),S=async()=>{const i=y({url:"wss://push.cheatcode.co/api/_websockets/instances",options:{max_sends_per_second:10,logging:!1,auto_reconnect:!0,reconnect_attempts:1/0,reconnect_delay_in_seconds:10}}),p=(await g("/root/push/instance_token.txt","utf-8"))?.trim();await d("/root/push/logs")||await E("/root/push/logs",{recursive:!0});const n=r.createLogger({format:r.format.combine(r.format.timestamp(),x(),r.format(e=>(e._id=w(16),e))(),r.format.json()),transports:[new r.transports.File({filename:"/root/push/logs/app.log",maxsize:1024*1024*10,maxFiles:1,tailable:!0}),new k({on_log:async(e={})=>{i.send({headers:{"x-push-instance-token":p},type:"log",log:e})}})]});function s(){if(process.env.PUSH_DEBUG!=="true")return"";const e=Error.prepareStackTrace;Error.prepareStackTrace=(b,f)=>f;const t=new Error().stack;Error.prepareStackTrace=e;const o=t[2],a=_.relative(process.cwd(),o.getFileName()),m=o.getLineNumber();return`[${a}:${m}] `}function c(e,t){const o=typeof e=="string"&&e.endsWith(`
`)?e.slice(0,-1):e;return t+o}process.stdout.write=function(e){return function(t){const o=s();n.info(c(t.toString(),o)),e.apply(process.stdout,arguments)}}(process.stdout.write),process.stderr.write=function(e){return function(t){const o=s();n.error(c(t.toString(),o)),e.apply(process.stderr,arguments)}}(process.stderr.write);const l=console.warn;console.warn=function(...e){const t=e.map(a=>typeof a=="string"?a:JSON.stringify(a)).join(" "),o=s();n.warn(c(t,o)),l.apply(console,e)},process.on("uncaughtException",e=>{const t=s();n.error(c(`Uncaught Exception: ${e instanceof Error?e.stack:e}`,t))}),process.on("unhandledRejection",e=>{const t=s();n.error(c(`Unhandled Rejection: ${e instanceof Error?e.stack:e}`,t))})};var I=S;export{I as default};
