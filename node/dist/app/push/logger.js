import o from"winston";import f from"fs";import u from"path";import _ from"../../lib/path_exists.js";import g from"../../lib/generate_id.js";import w from"../../lib/push_encrypt.js";import d from"./external_transport.js";import"../../lib/websocket_client.js";const{mkdir:h}=f.promises,E=o.format(i=>({...i,message:w(i.message,process.env.PUSH_INSTANCE_TOKEN)})),k=async()=>{const i=process.env.PUSH_INSTANCE_TOKEN;await _("/root/push/logs")||await h("/root/push/logs",{recursive:!0});const n=o.createLogger({format:o.format.combine(o.format.timestamp(),E(),o.format(e=>(e._id=g(16),e))(),o.format.json()),transports:[new o.transports.File({filename:"/root/push/logs/app.log",maxsize:1024*1024*10,maxFiles:1,tailable:!0}),new d({on_log:async(e={})=>{process.push_instances_websocket.send({headers:{"x-push-instance-token":i},type:"log",log:e})}})]});function s(){if(process.env.PUSH_DEBUG!=="true")return"";const e=Error.prepareStackTrace;Error.prepareStackTrace=(y,m)=>m;const r=new Error().stack;Error.prepareStackTrace=e;const t=r[2],a=u.relative(process.cwd(),t.getFileName()),l=t.getLineNumber();return`[${a}:${l}] `}function c(e,r){const t=typeof e=="string"&&e.endsWith(`
`)?e.slice(0,-1):e;return r+t}process.stdout.write=function(e){return function(r){const t=s();n.info(c(r.toString(),t)),e.apply(process.stdout,arguments)}}(process.stdout.write),process.stderr.write=function(e){return function(r){const t=s();n.error(c(r.toString(),t)),e.apply(process.stderr,arguments)}}(process.stderr.write);const p=console.warn;console.warn=function(...e){const r=e.map(a=>typeof a=="string"?a:JSON.stringify(a)).join(" "),t=s();n.warn(c(r,t)),p.apply(console,e)},process.on("uncaughtException",e=>{const r=s();n.error(c(`Uncaught Exception: ${e instanceof Error?e.stack:e}`,r))}),process.on("unhandledRejection",e=>{const r=s();n.error(c(`Unhandled Rejection: ${e instanceof Error?e.stack:e}`,r))})};var F=k;export{F as default};
