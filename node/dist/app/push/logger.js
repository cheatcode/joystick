import n from"winston";import m from"fs";import f from"path";import u from"../../lib/path_exists.js";import g from"../../lib/generate_id.js";import _ from"../../lib/push_encrypt.js";const{mkdir:d}=m.promises,w=n.format(o=>({...o,message:_(o.message,process.env.PUSH_INSTANCE_TOKEN)})),h=async()=>{await u("/root/push/logs")||await d("/root/push/logs",{recursive:!0});const o=n.createLogger({format:n.format.combine(n.format.timestamp(),w(),n.format(r=>(r._id=g(16),r))(),n.format.json()),transports:[new n.transports.File({filename:"/root/push/logs/app.log",maxsize:1024*1024*10,maxFiles:1,tailable:!0})]});function s(){if(process.env.PUSH_DEBUG!=="true")return"";const r=Error.prepareStackTrace;Error.prepareStackTrace=(E,l)=>l;const e=new Error().stack;Error.prepareStackTrace=r;const t=e[2],a=f.relative(process.cwd(),t.getFileName()),p=t.getLineNumber();return`[${a}:${p}] `}function c(r,e){const t=typeof r=="string"&&r.endsWith(`
`)?r.slice(0,-1):r;return e+t}process.stdout.write=function(r){return function(e){const t=s();o.info(c(e.toString(),t)),r.apply(process.stdout,arguments)}}(process.stdout.write),process.stderr.write=function(r){return function(e){const t=s();o.error(c(e.toString(),t)),r.apply(process.stderr,arguments)}}(process.stderr.write);const i=console.warn;console.warn=function(...r){const e=r.map(a=>typeof a=="string"?a:JSON.stringify(a)).join(" "),t=s();o.warn(c(e,t)),i.apply(console,r)},process.on("uncaughtException",r=>{const e=s();o.error(c(`Uncaught Exception: ${r instanceof Error?r.stack:r}`,e))}),process.on("unhandledRejection",r=>{const e=s();o.error(c(`Unhandled Rejection: ${r instanceof Error?r.stack:r}`,e))})};var U=h;export{U as default};
