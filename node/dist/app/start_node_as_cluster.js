import o from"cluster";import i from"os";const t=s=>{s.on("message",r=>{if(r.type==="websocket")process.send&&process.send(r);else for(const e in o.workers)o.workers[e].id!==s.id&&o.workers[e].send(r)})},f=(s=null)=>{const r=i.cpus().length;if(o.isPrimary){for(let e=1;e<r;e++){const n=o.fork(process.env);t(n)}o.on("exit",(e,n,l)=>{console.warn(`Worker ${e.process.pid} died. Restarting...`);const c=o.fork(process.env);t(c)}),process.on("message",e=>{if(e.type==="websocket")typeof global.handle_websocket_message=="function"&&global.handle_websocket_message(e);else for(const n in o.workers)o.workers[n].send(e)}),typeof s=="function"&&s()}};var k=f;export{k as default};
