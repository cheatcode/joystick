import o from"cluster";import t from"os";const i=s=>{s.on("message",r=>{if(r.type==="websocket")process.send&&process.send(r);else for(const e in o.workers)o.workers[e].id!==s.id&&o.workers[e].send(r)})},f=(s=null)=>{const r=t.cpus().length;if(o.isPrimary){console.log(`Primary ${process.pid} is running`);for(let e=1;e<r;e++){const n=o.fork(process.env);i(n)}o.on("exit",(e,n,l)=>{console.warn(`Worker ${e.process.pid} died. Restarting...`);const c=o.fork(process.env);i(c)}),process.on("message",e=>{if(e.type==="websocket")typeof global.handle_websocket_message=="function"&&global.handle_websocket_message(e);else for(const n in o.workers)o.workers[n].send(e)}),typeof s=="function"&&s()}else o.isWorker&&(console.log(`Worker ${process.pid} started`),typeof s=="function"&&s())};var p=f;export{p as default};
