import o from"cluster";import c from"os";const i=s=>{s.on("message",r=>{if(r.type==="websocket")process.send&&process.send(r);else for(const e in o.workers)o.workers[e].id!==s.id&&o.workers[e].send(r)})},l=(s=null)=>{const r=c.cpus().length;if(o.isPrimary){console.log(`Primary ${process.pid} is running`);for(let e=1;e<r;e++){const n=o.fork(process.env);i(n)}o.on("exit",(e,n,f)=>{console.warn(`Worker ${e.process.pid} died. Restarting...`);const t=o.fork(process.env);i(t)}),process.on("message",e=>{if(e.type==="websocket")typeof global.handle_websocket_message=="function"&&global.handle_websocket_message(e);else for(const n in o.workers)o.workers[n].send(e)}),typeof s=="function"&&s()}else o.isWorker&&console.log(`Worker ${process.pid} started`)};var k=l;export{k as default};
