import f from"http";import g from"fs";import l from"./api/accounts/authenticated.js";import b from"./api/accounts/login.js";import y from"./api/accounts/logout.js";import x from"./api/accounts/recover_password.js";import w from"./api/accounts/reset_password.js";import j from"./api/accounts/signup.js";import k from"./api/accounts/user.js";import v from"./api/accounts/verify_email.js";import"./api/push/health.js";import O from"./api/test/accounts/delete.js";import q from"./api/test/accounts/signup.js";import E from"./api/test/bootstrap.js";import R from"./api/test/process.js";import N from"./api/test/queues.js";import S from"./databases/mongodb/create_indexes.js";import D from"./databases/postgresql/create_indexes.js";import I from"./databases/postgresql/create_tables.js";import J from"../lib/dynamic_import.js";import A from"./generate_machine_id.js";import P from"./generate_process_id.js";import $ from"../lib/get_browser_safe_request.js";import L from"../lib/get_joystick_build_path.js";import u from"./databases/get_target_database_connection.js";import T from"./handle_process_errors.js";import U from"./settings/load.js";import B from"../lib/parse_route_pattern.js";import _ from"../lib/path_exists.js";import C from"./push/index.js";import V from"./push/logger.js";import z from"./queues/index.js";import F from"./register_app_options.js";import H from"./cron_jobs/register.js";import Q from"./databases/register_database.js";import Y from"./api/register_getters.js";import G from"./routes/register_route_from_function.js";import K from"./routes/register_route_from_object.js";import M from"./api/register_setters.js";import W from"./uploaders/register.js";import X from"./websockets/register.js";import Z from"./ssr/index.js";import ss from"./start_express.js";import ts from"./start_node_as_cluster.js";import es from"../lib/strip_preceeding_slash.js";import p from"../lib/types.js";const{readFile:c}=g.promises,os=U();class rs{constructor(s={}){f.globalAgent.maxSockets=1/0,T(s?.events),F(this,s),this.generate_machine_id(),this.generate_process_id(),process.title=process.env.NODE_ENV==="test"?"joystick_test_app":"joystick_app",process.joystick={app_options:s,external_process_ids:[],track_external_process:(t="")=>{process.send({external_process_id:t}),process.joystick.external_process_ids.push(t)}}}async connect_databases(){const s=os?.config?.databases;for(let t=0;t<s?.length;t+=1){const e=s[t],o=parseInt(process.env.PORT,10)+10+t,r=s?.filter(i=>e?.provider===i?.provider)?.length>1;await Q(e,o,r)}if(s?.length>0){const t=u("queues"),e=u("sessions"),o=u("users");process.databases._queues=t?.connection,process.databases._sessions=e?.connection,process.databases._users=o?.connection;const r=[t,e,o],i=r?.filter(a=>a?.provider==="mongodb")?.map(a=>a?.database_type);await S(i);const m=r?.filter(a=>a?.provider==="postgresql")?.map(a=>a?.database_type);await I(m),await D(m)}}async generate_machine_id(){this.joystick_machine_id=await A()}async generate_process_id(){this.joystick_process_id=await P()}on_after_start_server(s={}){process.on("message",t=>{if(typeof t=="string"){const e=JSON.parse(t);["RESTART"].includes(e?.type),e?.type==="BUILD_ERROR"&&(process.BUILD_ERROR=JSON.parse(t))}}),console.log(`App running at: http://localhost:${s.port}`)}register_accounts(){this.express.app.get("/api/_accounts/authenticated",l),this.express.app.post("/api/_accounts/user",k),this.express.app.post("/api/_accounts/login",b),this.express.app.post("/api/_accounts/logout",y),this.express.app.post("/api/_accounts/recover-password",x),this.express.app.post("/api/_accounts/reset-password",w),this.express.app.post("/api/_accounts/signup",j),this.express.app.get("/api/_accounts/verify-email",v)}register_api(){const s=this?.options?.api?.getters,t=this?.options?.api?.setters,e=this?.options?.api?.options,o=this?.options?.api?.context;s&&p.is_object(s)&&Object.keys(s||{}).length>0&&Y(this.express.app,Object.entries(s||{}),o,e),t&&p.is_object(t)&&Object.keys(t||{}).length>0&&M(this.express.app,Object.entries(t||{}),o,e)}register_caches(){process.caches={},p.is_function(this.options.caches)&&this.options.caches()}register_cron_jobs(){H(this.options.cronJobs||this.options.cron_jobs)}register_dynamic_pages(){this.express.app.post("/_joystick/dynamic_page/data",async(s={},t={})=>{const e=L(),o=es(s?.body?.page),r=`${e}/${o}`;if(!s?.body?.page||!await _(r))return handle_api_error("joystick.dynamic_pages.load",new Error(`Component not found at ${r}.`),t);const i=await J(r);if(i){const m=B(s?.body?.route_pattern||"",s?.body?.path),a=$({params:m?.params||{},query:s?.body?.query_params||{},url:s?.body?.path,headers:s?.headers,context:s?.context}),d=await Z({is_dynamic_page_render:!0,component_to_render:i,api_schema:this?.options?.api,component_options:{props:s?.body?.props},req:a});return t.status(200).send({data:d,req:a,url:{params:m?.params||{},query:s?.body?.query_params||{},path:s?.body?.path,route:s?.body?.route_pattern||s?.body?.path}})}return t.status(200).send({})})}register_fixtures(){p.is_function(this.options.fixtures)&&this.options.fixtures()}register_indexes(){p.is_function(this.options.indexes)&&this.options.indexes()}async register_mod(){const s="private/mod/mod-light.min.css",t="private/mod/mod-dark.min.css",e="private/mod/mod_css_map_free.json",o="private/mod/mod-light-plus.min.css",r="private/mod/mod-dark-plus.min.css",i="private/mod/mod_css_map_plus.json";this.mod={free:{css:{light:await _(s)?await c(s,"utf-8"):"",dark:await _(t)?await c(t,"utf-8"):""},map:await _(e)?JSON.parse(await c(e,"utf-8")):""},plus:{css:{light:await _(o)?await c(o,"utf-8"):"",dark:await _(r)?await c(r,"utf-8"):""},map:await _(i)?JSON.parse(await c(i,"utf-8")):""}}}async register_push(){process.env.NODE_ENV!=="development"&&process.env.IS_PUSH_DEPLOYED&&(await V(),await C())}register_queues(){if(p.is_object(this.options.queues)){const s=Object.entries(this.options.queues||{});for(let t=0;t<s.length;t+=1){const[e,o]=s[t];process.queues={...process.queues||{},[e]:new z(e,o)}}}}register_routes(){const s=Object.entries(this?.options?.routes||{});for(let t=0;t<s?.length;t+=1){const[e,o]=s[t],r=p.is_object(o);p.is_function(o)&&G(this.express.app,e,o),r&&K(this.express.app,e,o)}}register_tests(){this.express.app.get("/api/_test/bootstrap",(s={},t={})=>E(s,t,this)),this.express.app.get("/api/_test/process",R),this.express.app.delete("/api/_test/accounts",O),this.express.app.post("/api/_test/accounts/signup",q),this.express.app.post("/api/_test/queues",(s={},t={})=>N(s,t,this))}register_uploaders(){W(this.options.uploaders,this)}register_websockets(){X(this.options.websockets,this)}async start(){this.register_push(),await this.connect_databases(),this.register_caches(),this.register_cron_jobs(),this.register_queues(),this.start_express(),this.register_tests(),this.register_accounts(),this.register_api(),this.register_routes(),this.register_dynamic_pages(),this.register_websockets(),this.register_uploaders(),this.register_fixtures(),this.register_indexes(),this.register_mod()}start_express(){this.express=ss(this.on_after_start_server,this)}}const h=async(n={})=>{const s=new rs(n);return await s.start(n),s},is=(n={})=>new Promise(async s=>{if(n?.cluster)ts(async()=>{const t=await h(n);return s(t.express)});else{const t=await h(n);return s(t.express)}});var Zs=is;export{Zs as default};
