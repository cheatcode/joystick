import l from"http";import b from"fs";import y from"./api/accounts/authenticated.js";import x from"./api/accounts/login.js";import w from"./api/accounts/logout.js";import j from"./api/accounts/recover_password.js";import k from"./api/accounts/reset_password.js";import v from"./api/accounts/signup.js";import q from"./api/accounts/user.js";import O from"./api/accounts/verify_email.js";import E from"./api/test/accounts/delete.js";import N from"./api/test/accounts/signup.js";import R from"./api/test/bootstrap.js";import S from"./api/test/process.js";import T from"./api/test/queues.js";import I from"./databases/mongodb/create_indexes.js";import C from"./databases/postgresql/create_indexes.js";import D from"./databases/postgresql/create_tables.js";import A from"../lib/dynamic_import.js";import H from"./generate_machine_id.js";import P from"./generate_process_id.js";import U from"../lib/get_browser_safe_request.js";import $ from"../lib/get_joystick_build_path.js";import h from"./databases/get_target_database_connection.js";import J from"./handle_process_errors.js";import L from"./settings/load.js";import B from"../lib/parse_route_pattern.js";import n from"../lib/path_exists.js";import V from"./push/index.js";import Y from"./push/logger.js";import z from"./queues/index.js";import u from"../lib/read_mod_component_css.js";import f from"../lib/read_mod_global_css.js";import F from"./register_app_options.js";import K from"./cron_jobs/register.js";import Q from"./databases/register_database.js";import G from"./api/register_getters.js";import M from"./routes/register_route_from_function.js";import W from"./routes/register_route_from_object.js";import X from"./api/register_setters.js";import Z from"./uploaders/register.js";import tt from"./websockets/register.js";import st from"./ssr/index.js";import et from"./start_express.js";import ot from"./start_node_as_cluster.js";import rt from"../lib/strip_preceeding_slash.js";import _ from"../lib/types.js";import it from"../lib/websocket_client.js";const{readFile:d}=b.promises,at=L();class pt{constructor(t={}){l.globalAgent.maxSockets=1/0,J(t?.events),F(this,t),this.generate_machine_id(),this.generate_process_id(),process.title=process.env.NODE_ENV==="test"?"joystick_test_app":"joystick_app",process.joystick={app_options:t,external_process_ids:[],track_external_process:(s="")=>{process.send({external_process_id:s}),process.joystick.external_process_ids.push(s)}}}async connect_databases(){const t=at?.config?.databases;for(let s=0;s<t?.length;s+=1){const e=t[s],o=parseInt(process.env.PORT,10)+10+s,i=t?.filter(a=>e?.provider===a?.provider)?.length>1;await Q(e,o,i)}if(t?.length>0){const s=h("queues"),e=h("users");process.databases._queues=s?.connection,process.databases._users=e?.connection;const o=[s,e],i=o?.filter(r=>r?.provider==="mongodb")?.map(r=>r?.database_type);await I(i);const a=o?.filter(r=>r?.provider==="postgresql")?.map(r=>r?.database_type);await D(a),await C(a)}}async generate_machine_id(){this.joystick_machine_id=await H()}async generate_process_id(){this.joystick_process_id=await P()}on_after_start_server(t={}){process.on("message",s=>{if(typeof s=="string"){const e=JSON.parse(s);["RESTART"].includes(e?.type),e?.type==="BUILD_ERROR"&&(process.BUILD_ERROR=JSON.parse(s))}}),console.log(`App running at: http://localhost:${t.port}`)}register_accounts(){this.express.app.get("/api/_accounts/authenticated",y),this.express.app.post("/api/_accounts/user",q),this.express.app.post("/api/_accounts/login",x),this.express.app.post("/api/_accounts/logout",w),this.express.app.post("/api/_accounts/recover-password",j),this.express.app.post("/api/_accounts/reset-password",k),this.express.app.post("/api/_accounts/signup",v),this.express.app.get("/api/_accounts/verify-email",O)}register_api(){const t=this?.options?.api?.getters,s=this?.options?.api?.setters,e=this?.options?.api?.options,o=this?.options?.api?.context;t&&_.is_object(t)&&Object.keys(t||{}).length>0&&G(this.express.app,Object.entries(t||{}),o,e),s&&_.is_object(s)&&Object.keys(s||{}).length>0&&X(this.express.app,Object.entries(s||{}),o,e)}register_caches(){process.caches={},_.is_function(this.options.caches)&&this.options.caches()}register_cron_jobs(){K(this.options.cronJobs||this.options.cron_jobs)}register_dynamic_pages(){this.express.app.post("/_joystick/dynamic_page/data",async(t={},s={})=>{const e=$(),o=rt(t?.body?.page),i=`${e}/${o}`;if(!t?.body?.page||!await n(i))return handle_api_error("joystick.dynamic_pages.load",new Error(`Component not found at ${i}.`),s);const a=await A(i);if(a){const r=B(t?.body?.route_pattern||"",t?.body?.path),c=U({params:r?.params||{},query:t?.body?.query_params||{},url:t?.body?.path,headers:t?.headers,context:t?.context}),p=await st({is_dynamic_page_render:!0,component_to_render:a,api_schema:this?.options?.api,component_options:{props:t?.body?.props},req:c});return s.status(200).send({data:p,req:c,url:{params:r?.params||{},query:t?.body?.query_params||{},path:t?.body?.path,route:t?.body?.route_pattern||t?.body?.path}})}return s.status(200).send({})})}register_fixtures(){_.is_function(this.options.fixtures)&&this.options.fixtures()}register_indexes(){_.is_function(this.options.indexes)&&this.options.indexes()}async register_mod(){if(!await n("private/mod"))return;const s=await n("private/mod/mod_version.txt")&&(await d("private/mod/mod_version.txt","utf-8"))?.trim()||"free";let e,o,i,a={},r={};if(s==="plus"){e=await n("private/mod/mod-light-plus.min.css")&&await d("private/mod/mod-light-plus.min.css","utf-8")||"",o=await n("private/mod/mod-dark-plus.min.css")&&await d("private/mod/mod-dark-plus.min.css","utf-8")||"",i=await n("lib/mod-plus.esm.min.js")&&await d("lib/mod-plus.esm.min.js","utf-8")||"",a=await f();const c=await u("free"),p=await u("plus");r={...c||{},...p||{}}}else e=await n("private/mod/mod-light.min.css")&&await d("private/mod/mod-light.min.css","utf-8")||"",o=await n("private/mod/mod-dark.min.css")&&await d("private/mod/mod-dark.min.css","utf-8")||"",o=await n("lib/mod.esm.min.js")&&await d("lib/mod.esm.min.js","utf-8")||"",a=await f(),r={...await u("free")||{}};this.mod={version:s,css:{light:e,dark:o},js:i,globals:a,components:r},this.express.app.get("/_joystick/mod/mod-light.css",async(c={},p={})=>(p.setHeader("Content-Type","text/css"),p.status(200).send(this?.mod?.css?.light||""))),this.express.app.get("/_joystick/mod/mod-dark.css",async(c={},p={})=>(p.setHeader("Content-Type","text/css"),p.status(200).send(this?.mod?.css?.dark||""))),this.express.app.get("/_joystick/mod/mod.js",async(c={},p={})=>(p.setHeader("Content-Type","text/javascript"),p.status(200).send(this?.mod?.js||"")))}async register_push(){process.env.NODE_ENV!=="development"&&process.env.IS_PUSH_DEPLOYED&&(this.express.app.get("/api/_push/health",async(t={},s={})=>t?.headers?.["x-push-instance-token"]!==process.env.PUSH_INSTANCE_TOKEN?s.status(403).send("403 - You are not allowed to access this endpoint."):s.status(200).send("ok")),process.push_instances_websocket=it({url:"wss://push.cheatcode.co/api/_websockets/instances",options:{max_sends_per_second:10,logging:!1,auto_reconnect:!0,reconnect_attempts:1/0,reconnect_delay_in_seconds:10}}),await V(),await Y())}register_queues(){if(_.is_object(this.options.queues)){const t=Object.entries(this.options.queues||{});for(let s=0;s<t.length;s+=1){const[e,o]=t[s];process.queues={...process.queues||{},[e]:new z(e,o)}}}}register_routes(){const t=Object.entries(this?.options?.routes||{});for(let s=0;s<t?.length;s+=1){const[e,o]=t[s],i=_.is_object(o);_.is_function(o)&&M(this.express.app,e,o),i&&W(this.express.app,e,o)}}register_tests(){this.express.app.get("/api/_test/bootstrap",(t={},s={})=>R(t,s,this)),this.express.app.get("/api/_test/process",S),this.express.app.delete("/api/_test/accounts",E),this.express.app.post("/api/_test/accounts/signup",N),this.express.app.post("/api/_test/queues",(t={},s={})=>T(t,s,this))}register_uploaders(){Z(this.options.uploaders,this)}register_websockets(){tt(this.options.websockets,this)}async start(){await this.connect_databases(),this.register_caches(),this.register_cron_jobs(),this.register_queues(),this.start_express(),this.register_websockets(),this.register_tests(),this.register_push(),this.register_accounts(),this.register_api(),this.register_routes(),this.register_dynamic_pages(),this.register_uploaders(),this.register_fixtures(),this.register_indexes(),this.register_mod()}start_express(){this.express=et(this.on_after_start_server,this)}}const g=async(m={})=>{const t=new pt(m);return await t.start(m),t},nt=(m={})=>new Promise(async t=>{if(m?.cluster)ot(async()=>{const s=await g(m);return t(s.express)});else{const s=await g(m);return t(s.express)}});var os=nt;export{os as default};
