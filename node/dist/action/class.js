import l from"../app/api/format_api_error.js";import e from"../test/track_function_call.js";import h from"../lib/types.js";import u from"../app/api/validate_input.js";class f{constructor(i={}){this.name=i?.name,this.config=i?.config,this.options=i?.options,this.steps=this._serialize_steps(),this._serialize_steps=this._serialize_steps.bind(this),this._log_error=this._log_error.bind(this),this.run=this.run.bind(this)}_serialize_steps(){return Object.entries(this?.config?.steps||{})?.reduce((i={},[r="",s={}])=>(i[r]=async(...o)=>{try{e(`node.actions.${this?.name}.steps.${r}`,[...o,this]);const t=await s?.run(...o,this);return(h.is_function(s?.onSuccess)||h.is_function(s?.on_success))&&((s.onSuccess||s.on_success)(t,this),e(`node.actions.${this?.name}.steps.${r}.on_success`,[t,this])),t}catch(t){(this.options?.logErrors||this.options?.log_errors)&&this._log_error(r,t),(h.is_function(s.onError)||h.is_function(s.on_error))&&((s.onError||s.on_error)(t,this),e(`node.actions.${this?.name}.steps.${r}.on_error`,[t,this]))}},i),{})}_log_error(i=null,r=null){let s="";this.name&&!i&&(s+=`${this.name}`),this.name&&i&&(s+=`${this.name}.${i}`),console.log({path:s,exception:r})}run(i={}){return new Promise(async(r,s)=>{try{if(this.abort=t=>{throw e(`node.actions.${this?.name}.abort`,[t]),s(t),t},Object.keys(this?.config?.input||{})?.length>0){const t=await u(i,this?.config?.input);if(t?.length>0){for(let n=0;n<t?.length;n+=1){const a=t[n];(this?.options?.logErrors||this?.options?.log_errors)&&console.log(`[${this.name}.validation] ${a}`)}const c=t?.map(n=>n?.substring(0,n.length-1)).join(", ");return s(new Error(c))}}e(`node.actions.${this.name}.run`,[i||{},this.steps,this]);const o=await this.config?.run(i||{},this?.steps,this);return r(o)}catch(o){(this.options?.logErrors||this?.options?.log_errors)&&this._log_error(null,o),s(o)}}).catch(r=>Promise.reject(l(r,r?.location||this.name)))}}var b=f;export{b as default};
