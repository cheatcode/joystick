import b from"../app/databases/get_target_database_connection.js";import v from"../lib/generate_id.js";const y=(c="",t={})=>{const $={ttl:null,max_items:null,...t},m=b("cache");return m?.provider==="redis"?O(c,m.connection,$):J(c,$)},J=(c,t={})=>{const{ttl:$,max_items:m}=t,u=e=>{const f=Date.now();return{...e,_cache_created_at:f,_cache_accessed_at:f}},s=()=>{if(!$||!process.caches[c])return;const e=Date.now(),f=$*1e3;process.caches[c]=process.caches[c].filter(a=>e-a._cache_created_at<f)},w=()=>{!m||!process.caches[c]||process.caches[c].length>m&&(process.caches[c].sort((e,f)=>f._cache_accessed_at-e._cache_accessed_at),process.caches[c]=process.caches[c].slice(0,m))},g=e=>(e._cache_accessed_at=Date.now(),e);return{add:(e={})=>{s();const f=u(e);process.caches[c]=[...process.caches[c]||[],f],w()},find:(e=null)=>(s(),(e?process.caches[c]?.filter(a=>a[e[0]]===e[1]):process.caches[c])?.map(g)||[]),find_one:(e=null)=>{s();const f=e?process.caches[c]?.find(a=>a[e[0]]===e[1]):null;return f?g(f):null},set:(e=[])=>{const f=e.map(u);process.caches[c]=f,w()},update:([e="",f=""],a={})=>{s();const r=process.caches[c]?.findIndex((i={})=>i[e]===f);typeof r=="number"&&(process.caches[c][r]={...process.caches[c][r]||{},...a,_cache_accessed_at:Date.now()})},remove:([e="",f=""])=>{process.caches[c]&&(process.caches[c]=process.caches[c].filter((a={})=>a[e]!==f))}}},O=(c,t,$={})=>{const{ttl:m,max_items:u}=$,s=`cache:${c}`,w=`${s}:lru`,g=async()=>{if(!u)return;const a=await t.scard(`${s}:index`);if(a>u){const r=a-u,i=await t.zrange(w,0,r-1);for(const l of i)await f(l)}},e=async a=>{u&&await t.zadd(w,{score:Date.now(),value:a})},f=async a=>{const r=`${s}:${a}`,i=await t.hget(r,"data");if(i){const l=JSON.parse(i);for(const[d,o]of Object.entries(l))d!=="_cache_id"&&await t.srem(`${s}:field:${d}:${o}`,a)}await t.del(r),await t.srem(`${s}:index`,a),await t.zrem(w,a)};return{add:async(a={})=>{a._cache_id||(a._cache_id=v(16));const r=`${s}:${a._cache_id}`;m?(await t.hset(r,"data",JSON.stringify(a)),await t.expire(r,m)):await t.hset(r,"data",JSON.stringify(a)),await t.sadd(`${s}:index`,a._cache_id),await e(a._cache_id);for(const[i,l]of Object.entries(a))i!=="_cache_id"&&await t.sadd(`${s}:field:${i}:${l}`,a._cache_id);await g()},find:async(a=null)=>{if(!a){const o=await t.smembers(`${s}:index`),p=[];for(const h of o){const n=await t.hget(`${s}:${h}`,"data");n?(p.push(JSON.parse(n)),await e(h)):(await t.srem(`${s}:index`,h),await t.zrem(w,h))}return p}const[r,i]=a,l=await t.smembers(`${s}:field:${r}:${i}`),d=[];for(const o of l){const p=await t.hget(`${s}:${o}`,"data");p?(d.push(JSON.parse(p)),await e(o)):(await t.srem(`${s}:field:${r}:${i}`,o),await t.srem(`${s}:index`,o),await t.zrem(w,o))}return d},find_one:async(a=null)=>{if(!a)return null;const[r,i]=a,l=await t.smembers(`${s}:field:${r}:${i}`);if(l.length>0){const d=l[0],o=await t.hget(`${s}:${d}`,"data");if(o)return await e(d),JSON.parse(o);await t.srem(`${s}:field:${r}:${i}`,d),await t.srem(`${s}:index`,d),await t.zrem(w,d)}return null},set:async(a=[])=>{const r=await t.smembers(`${s}:index`);if(r.length>0){const i=t.client.multi();for(const d of r)i.del(`${s}:${d}`);const l=await t.client.keys(`${s}:field:*`);for(const d of l)i.del(d);i.del(`${s}:index`),i.del(w),await i.exec()}for(const i of a)await O(c,t,$).add(i)},update:async([a="",r=""],i={})=>{const l=await t.smembers(`${s}:field:${a}:${r}`);if(l.length>0){const d=l[0],o=`${s}:${d}`,p=await t.hget(o,"data");if(p){const h=JSON.parse(p),n={...h,...i};for(const[_,x]of Object.entries(h))_!=="_cache_id"&&await t.srem(`${s}:field:${_}:${x}`,d);m?(await t.hset(o,"data",JSON.stringify(n)),await t.expire(o,m)):await t.hset(o,"data",JSON.stringify(n)),await e(d);for(const[_,x]of Object.entries(n))_!=="_cache_id"&&await t.sadd(`${s}:field:${_}:${x}`,d)}}},remove:async([a="",r=""])=>{const i=await t.smembers(`${s}:field:${a}:${r}`);for(const l of i)await f(l)}}};var k=y;export{k as default};
