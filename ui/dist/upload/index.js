var B=Object.create;var h=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var z=r=>h(r,"__esModule",{value:!0});var m=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var K=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Q(e))!X.call(r,n)&&n!=="default"&&h(r,n,{get:()=>e[n],enumerable:!(t=G(e,n))||t.enumerable});return r},Y=r=>K(z(h(r!=null?B(W(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var S=m((ur,E)=>{"use strict";E.exports=r=>encodeURIComponent(r).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)});var N=m((gr,A)=>{"use strict";var O="%[a-f0-9]{2}",j=new RegExp(O,"gi"),$=new RegExp("("+O+")+","gi");function F(r,e){try{return decodeURIComponent(r.join(""))}catch{}if(r.length===1)return r;e=e||1;var t=r.slice(0,e),n=r.slice(e);return Array.prototype.concat.call([],F(t),F(n))}function Z(r){try{return decodeURIComponent(r)}catch{for(var e=r.match(j),t=1;t<e.length;t++)r=F(e,t).join(""),e=r.match(j);return r}}function v(r){for(var e={"%FE%FF":"\uFFFD\uFFFD","%FF%FE":"\uFFFD\uFFFD"},t=$.exec(r);t;){try{e[t[0]]=decodeURIComponent(t[0])}catch{var n=Z(t[0]);n!==t[0]&&(e[t[0]]=n)}t=$.exec(r)}e["%C2"]="\uFFFD";for(var s=Object.keys(e),c=0;c<s.length;c++){var a=s[c];r=r.replace(new RegExp(a,"g"),e[a])}return r}A.exports=function(r){if(typeof r!="string")throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof r+"`");try{return r=r.replace(/\+/g," "),decodeURIComponent(r)}catch{return v(r)}}});var C=m((mr,I)=>{"use strict";I.exports=(r,e)=>{if(!(typeof r=="string"&&typeof e=="string"))throw new TypeError("Expected the arguments to be of type `string`");if(e==="")return[r];let t=r.indexOf(e);return t===-1?[r]:[r.slice(0,t),r.slice(t+e.length)]}});var k=m((yr,q)=>{"use strict";q.exports=function(r,e){for(var t={},n=Object.keys(r),s=Array.isArray(e),c=0;c<n.length;c++){var a=n[c],o=r[a];(s?e.indexOf(a)!==-1:e(a,o,r))&&(t[a]=o)}return t}});var V=m(f=>{"use strict";var rr=S(),er=N(),R=C(),tr=k(),nr=r=>r==null,w=Symbol("encodeFragmentIdentifier");function sr(r){switch(r.arrayFormat){case"index":return e=>(t,n)=>{let s=t.length;return n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,[i(e,r),"[",s,"]"].join("")]:[...t,[i(e,r),"[",i(s,r),"]=",i(n,r)].join("")]};case"bracket":return e=>(t,n)=>n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,[i(e,r),"[]"].join("")]:[...t,[i(e,r),"[]=",i(n,r)].join("")];case"colon-list-separator":return e=>(t,n)=>n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,[i(e,r),":list="].join("")]:[...t,[i(e,r),":list=",i(n,r)].join("")];case"comma":case"separator":case"bracket-separator":{let e=r.arrayFormat==="bracket-separator"?"[]=":"=";return t=>(n,s)=>s===void 0||r.skipNull&&s===null||r.skipEmptyString&&s===""?n:(s=s===null?"":s,n.length===0?[[i(t,r),e,i(s,r)].join("")]:[[n,i(s,r)].join(r.arrayFormatSeparator)])}default:return e=>(t,n)=>n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,i(e,r)]:[...t,[i(e,r),"=",i(n,r)].join("")]}}function ar(r){let e;switch(r.arrayFormat){case"index":return(t,n,s)=>{if(e=/\[(\d*)\]$/.exec(t),t=t.replace(/\[\d*\]$/,""),!e){s[t]=n;return}s[t]===void 0&&(s[t]={}),s[t][e[1]]=n};case"bracket":return(t,n,s)=>{if(e=/(\[\])$/.exec(t),t=t.replace(/\[\]$/,""),!e){s[t]=n;return}if(s[t]===void 0){s[t]=[n];return}s[t]=[].concat(s[t],n)};case"colon-list-separator":return(t,n,s)=>{if(e=/(:list)$/.exec(t),t=t.replace(/:list$/,""),!e){s[t]=n;return}if(s[t]===void 0){s[t]=[n];return}s[t]=[].concat(s[t],n)};case"comma":case"separator":return(t,n,s)=>{let c=typeof n=="string"&&n.includes(r.arrayFormatSeparator),a=typeof n=="string"&&!c&&d(n,r).includes(r.arrayFormatSeparator);n=a?d(n,r):n;let o=c||a?n.split(r.arrayFormatSeparator).map(l=>d(l,r)):n===null?n:d(n,r);s[t]=o};case"bracket-separator":return(t,n,s)=>{let c=/(\[\])$/.test(t);if(t=t.replace(/\[\]$/,""),!c){s[t]=n&&d(n,r);return}let a=n===null?[]:n.split(r.arrayFormatSeparator).map(o=>d(o,r));if(s[t]===void 0){s[t]=a;return}s[t]=[].concat(s[t],a)};default:return(t,n,s)=>{if(s[t]===void 0){s[t]=n;return}s[t]=[].concat(s[t],n)}}}function D(r){if(typeof r!="string"||r.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function i(r,e){return e.encode?e.strict?rr(r):encodeURIComponent(r):r}function d(r,e){return e.decode?er(r):r}function U(r){return Array.isArray(r)?r.sort():typeof r=="object"?U(Object.keys(r)).sort((e,t)=>Number(e)-Number(t)).map(e=>r[e]):r}function M(r){let e=r.indexOf("#");return e!==-1&&(r=r.slice(0,e)),r}function cr(r){let e="",t=r.indexOf("#");return t!==-1&&(e=r.slice(t)),e}function L(r){r=M(r);let e=r.indexOf("?");return e===-1?"":r.slice(e+1)}function P(r,e){return e.parseNumbers&&!Number.isNaN(Number(r))&&typeof r=="string"&&r.trim()!==""?r=Number(r):e.parseBooleans&&r!==null&&(r.toLowerCase()==="true"||r.toLowerCase()==="false")&&(r=r.toLowerCase()==="true"),r}function T(r,e){e=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},e),D(e.arrayFormatSeparator);let t=ar(e),n=Object.create(null);if(typeof r!="string"||(r=r.trim().replace(/^[?#&]/,""),!r))return n;for(let s of r.split("&")){if(s==="")continue;let[c,a]=R(e.decode?s.replace(/\+/g," "):s,"=");a=a===void 0?null:["comma","separator","bracket-separator"].includes(e.arrayFormat)?a:d(a,e),t(d(c,e),a,n)}for(let s of Object.keys(n)){let c=n[s];if(typeof c=="object"&&c!==null)for(let a of Object.keys(c))c[a]=P(c[a],e);else n[s]=P(c,e)}return e.sort===!1?n:(e.sort===!0?Object.keys(n).sort():Object.keys(n).sort(e.sort)).reduce((s,c)=>{let a=n[c];return Boolean(a)&&typeof a=="object"&&!Array.isArray(a)?s[c]=U(a):s[c]=a,s},Object.create(null))}f.extract=L;f.parse=T;f.stringify=(r,e)=>{if(!r)return"";e=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},e),D(e.arrayFormatSeparator);let t=a=>e.skipNull&&nr(r[a])||e.skipEmptyString&&r[a]==="",n=sr(e),s={};for(let a of Object.keys(r))t(a)||(s[a]=r[a]);let c=Object.keys(s);return e.sort!==!1&&c.sort(e.sort),c.map(a=>{let o=r[a];return o===void 0?"":o===null?i(a,e):Array.isArray(o)?o.length===0&&e.arrayFormat==="bracket-separator"?i(a,e)+"[]":o.reduce(n(a),[]).join("&"):i(a,e)+"="+i(o,e)}).filter(a=>a.length>0).join("&")};f.parseUrl=(r,e)=>{e=Object.assign({decode:!0},e);let[t,n]=R(r,"#");return Object.assign({url:t.split("?")[0]||"",query:T(L(r),e)},e&&e.parseFragmentIdentifier&&n?{fragmentIdentifier:d(n,e)}:{})};f.stringifyUrl=(r,e)=>{e=Object.assign({encode:!0,strict:!0,[w]:!0},e);let t=M(r.url).split("?")[0]||"",n=f.extract(r.url),s=f.parse(n,{sort:!1}),c=Object.assign(s,r.query),a=f.stringify(c,e);a&&(a=`?${a}`);let o=cr(r.url);return r.fragmentIdentifier&&(o=`#${e[w]?i(r.fragmentIdentifier,e):r.fragmentIdentifier}`),`${t}${a}${o}`};f.pick=(r,e,t)=>{t=Object.assign({parseFragmentIdentifier:!0,[w]:!1},t);let{url:n,query:s,fragmentIdentifier:c}=f.parseUrl(r,t);return f.stringifyUrl({url:n,query:tr(s,e),fragmentIdentifier:c},t)};f.exclude=(r,e,t)=>{let n=Array.isArray(e)?s=>!e.includes(s):(s,c)=>!e(s,c);return f.pick(r,n,t)}});var p="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890".split(""),b=(r=16)=>{let e="",t=0;for(;t<r;)e+=p[Math.floor(Math.random()*(p.length-1))],t+=1;return e};var u=(r="",e={})=>{throw new Error(`[joystick${r?`.${r}`:""}] ${e.message||e.reason||e}`)};var x=(r="",e=[])=>{try{console.error(`${r} failed with the following errors:`),e.forEach(t=>{console.log(t.message),t.stack&&console.log(t.stack)})}catch(t){u(r,t)}};var H=Y(V());var g=null,y=0,J=(r={},e=null)=>{try{let t=r?.url;r?.query&&(t=`${t}?${H.default.stringify(r.query)}`);let n=new WebSocket(t);g&&(clearInterval(g),g=null);let s={client:n,send:(c={})=>n.send(JSON.stringify(c))};return n.addEventListener("open",()=>{r?.options?.logging&&console.log(`[joystick.websockets] Connected to ${r?.url}`),r?.events?.onOpen&&r.events.onOpen(s),y=0}),n.addEventListener("message",c=>{c?.data&&r?.events?.onMessage&&r.events.onMessage(JSON.parse(c.data||{}),s)}),n.addEventListener("close",c=>{r?.options?.logging&&console.log(`[joystick.websockets] Disconnected from ${r?.url}`),r?.events?.onClose&&r.events.onClose(c?.code,c?.reason,s),n=null;let a=[1e3,1001].includes(c?.code);r?.options?.autoReconnect&&!g&&!a&&(g=setInterval(()=>{n=null,y<(r?.options?.reconnectAttempts||12)?(J(r,e),r?.options?.logging&&console.log(`[joystick.websockets] Attempting to reconnect (${y+1}/12)...`),y+=1):clearInterval(g)},r?.options?.reconnectDelayInSeconds*1e3||5e3))}),e&&e(s),s}catch(t){u("websockets.client",t)}},_=J;var Sr=(r="",e={})=>{try{return new Promise((t,n)=>{let s=b(),c=0;_({url:`${window?.process?.env.NODE_ENV==="development"?"ws":"wss"}://${location.host}/api/_websockets/uploaders`,options:{logging:!1,autoReconnect:!0,reconnectAttempts:12,reconnectDelayInSeconds:5},query:{id:s},events:{onMessage:(a={})=>{a?.type==="PROGRESS"&&e?.onProgress&&c<100&&c!==a?.progress&&(c=a?.progress,e.onProgress(a?.progress,a?.provider))}}},()=>{let a;e?.files?.length>0&&(a=new FormData,Array.from(e?.files).forEach(l=>{a.append("files",l,l.name)}));let o=new XMLHttpRequest;o.onload=()=>{let l=o.responseText?JSON.parse(o.responseText):null;l&&l.errors?(x("upload",l.errors),n(l.errors)):t(l?.uploads)},o.open("POST",`${window.location.origin}/api/_uploaders/${r}`),o.setRequestHeader("x-joystick-upload-id",s),o.setRequestHeader("x-joystick-upload-input",JSON.stringify(e?.input||{})),o.send(a)})})}catch(t){u("upload",t)}};export{Sr as default};
