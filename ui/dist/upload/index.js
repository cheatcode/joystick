var f="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890".split(""),g=(e=16)=>{let r="",o=0;for(;o<e;)r+=f[Math.floor(Math.random()*(f.length-1))],o+=1;return r};var i=(e="",r={})=>{throw new Error(`[joystick${e?`.${e}`:""}] ${r.message||r.reason||r}`)};var w=(e="",r=[])=>{try{console.error(`${e} failed with the following errors:`),r.forEach(o=>{console.log(o.message),o.stack&&console.log(o.stack)})}catch(o){i(e,o)}};var d=null,u=0,m=(e={},r=null)=>{try{let o=e?.url;e?.query&&(o=`${o}?${new URLSearchParams(e.query).toString()}`);let s=new WebSocket(o);d&&(clearInterval(d),d=null);let l={client:s,send:(t={})=>s.send(JSON.stringify(t))};return s.addEventListener("open",()=>{e?.options?.logging&&console.log(`[joystick.websockets] Connected to ${e?.url}`),e?.events?.onOpen&&e.events.onOpen(l),u=0}),s.addEventListener("message",t=>{t?.data&&e?.events?.onMessage&&e.events.onMessage(JSON.parse(t.data||{}),l)}),s.addEventListener("close",t=>{e?.options?.logging&&console.log(`[joystick.websockets] Disconnected from ${e?.url}`),e?.events?.onClose&&e.events.onClose(t?.code,t?.reason,l),s=null;let n=[1e3,1001].includes(t?.code);e?.options?.autoReconnect&&!d&&!n&&(d=setInterval(()=>{s=null,u<(e?.options?.reconnectAttempts||12)?(m(e,r),e?.options?.logging&&console.log(`[joystick.websockets] Attempting to reconnect (${u+1}/12)...`),u+=1):clearInterval(d)},e?.options?.reconnectDelayInSeconds*1e3||5e3))}),r&&r(l),l}catch(o){i("websockets.client",o)}},p=m;var R=(e="",r={})=>{try{return new Promise((o,s)=>{let l=g(),t=0;p({url:`${window?.process?.env.NODE_ENV==="development"?"ws":"wss"}://${location.host}/api/_websockets/uploaders`,options:{logging:!1,autoReconnect:!0,reconnectAttempts:12,reconnectDelayInSeconds:5},query:{id:l},events:{onMessage:(n={})=>{n?.type==="PROGRESS"&&r?.onProgress&&t<100&&t!==n?.progress&&(t=n?.progress,r.onProgress(n?.progress,n?.provider))}}},()=>{let n;r?.files?.length>0&&(n=new FormData,Array.from(r?.files).forEach(c=>{n.append("files",c,c.name)}));let a=new XMLHttpRequest;a.onload=()=>{let c=a.responseText?JSON.parse(a.responseText):null;c&&c.errors?(w("upload",c.errors),s(c.errors)):o(c?.uploads)},a.open("POST",`${window.location.origin}/api/_uploaders/${e}`),a.setRequestHeader("x-joystick-upload-id",l),a.setRequestHeader("x-joystick-upload-input",JSON.stringify(r?.input||{})),a.send(n)})})}catch(o){i("upload",o)}};export{R as default};
