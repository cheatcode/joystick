import o from"fs";import i from"path";import k from"os";import{promisify as g}from"util";import{pipeline as j}from"stream";import{execFile as v}from"child_process";const z=g(j),m=g(v),D=async(s=null)=>{const n=i.join(k.homedir(),".joystick","databases","mongodb"),t=i.join(n,"bin"),a=i.join(t,"bin");if(await M(n))return;await F(n,t,a);const d=(await B()).includes("ARM"),p=d?"https://fastdl.mongodb.org/osx/mongodb-macos-arm64-7.0.2.tgz":"https://fastdl.mongodb.org/osx/mongodb-macos-x86_64-7.0.2.tgz",l=d?"https://downloads.mongodb.com/compass/mongosh-2.2.12-darwin-arm64.zip":"https://downloads.mongodb.com/compass/mongosh-2.2.12-darwin-x64.zip",f=i.basename(new URL(p).pathname),r=i.join(n,f),u=i.basename(new URL(l).pathname),c=i.join(n,u);process.loader.print("MongoDB not found. Downloading... (patience is a virtue\u2014it's chonky)"),await h(p,r),await h(l,c),process.loader.print("Installing MongoDB..."),await m("tar",["-xzf",r,"-C",t,"--strip-components=1"]);const e=i.join(n,"mongosh_temp");await o.promises.mkdir(e,{recursive:!0}),await m("unzip",["-q",c,"-d",e]);const _=(await o.promises.readdir(e)).find(x=>x.startsWith("mongosh-"));if(!_)throw new Error("Could not find mongosh directory in extracted contents");const b=i.join(e,_,"bin","mongosh"),y=i.join(a,"mongosh");await o.promises.copyFile(b,y),await o.promises.unlink(r),await o.promises.unlink(c),await o.promises.rm(e,{recursive:!0,force:!0}),await w(t),await w(a),process.loader.print("MongoDB and MongoDB Shell installed!")},h=async(s,n)=>{const t=await fetch(s);if(!t.ok)throw new Error(`Failed to download: ${t.statusText}`);await z(t.body,o.createWriteStream(n))},M=async s=>{try{return await o.promises.access(s),!0}catch{return!1}},B=async()=>{const{stdout:s}=await m("sysctl",["-n","machdep.cpu.brand_string"]);return s.trim()},F=async(s,n,t)=>{await o.promises.mkdir(s,{recursive:!0}),await o.promises.mkdir(n,{recursive:!0}),await o.promises.mkdir(t,{recursive:!0})},w=async s=>{const n=await o.promises.readdir(s);for(const t of n)await o.promises.chmod(i.join(s,t),"755")};var q=D;export{q as default};
