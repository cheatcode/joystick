import o from"fs";import n from"path";import k from"os";import{promisify as w}from"util";import{pipeline as v}from"stream";import{execFile as D}from"child_process";const z=w(v),h=w(D),B=async(e=null)=>{const t=n.join(k.homedir(),".joystick","databases","mongodb"),i=n.join(t,"bin"),a=n.join(i,"bin");if(await C(t))return;await F(t,i,a);const p="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2204-7.0.2.tgz",l="https://downloads.mongodb.com/compass/mongosh-2.2.12-linux-x64.tgz",g=n.basename(new URL(p).pathname),m=n.join(t,g),b=n.basename(new URL(l).pathname),c=n.join(t,b);process.loader.print("MongoDB not found. Downloading... (this may take a few minutes)"),await u(p,m),await u(l,c),process.loader.print("Installing MongoDB..."),await h("tar",["-xzf",m,"-C",t]);const d=(await o.promises.readdir(t)).find(s=>s.startsWith("mongodb-"));if(!d)throw new Error("Could not find extracted MongoDB directory");const f=n.join(t,d,"bin"),y=await o.promises.readdir(f);for(const s of y)await o.promises.rename(n.join(f,s),n.join(a,s));const r=n.join(t,"mongosh_temp");await o.promises.mkdir(r,{recursive:!0}),await h("tar",["-xzf",c,"-C",r]);const _=(await o.promises.readdir(r)).find(s=>s.startsWith("mongosh-"));if(!_)throw new Error("Could not find mongosh directory in extracted contents");const x=n.join(r,_,"bin","mongosh"),j=n.join(a,"mongosh");await o.promises.copyFile(x,j),await o.promises.unlink(m),await o.promises.unlink(c),await o.promises.rm(r,{recursive:!0,force:!0}),await o.promises.rm(n.join(t,d),{recursive:!0,force:!0}),await M(a),process.loader.print("MongoDB installed!")},u=async(e,t)=>{const i=await fetch(e);if(!i.ok)throw new Error(`Failed to download: ${i.statusText}`);await z(i.body,o.createWriteStream(t))},C=async e=>{try{return await o.promises.access(e),!0}catch{return!1}},F=async(e,t,i)=>{await o.promises.mkdir(e,{recursive:!0}),await o.promises.mkdir(t,{recursive:!0}),await o.promises.mkdir(i,{recursive:!0})},M=async e=>{const t=await o.promises.readdir(e);for(const i of t)await o.promises.chmod(n.join(e,i),"755")};var P=B;export{P as default};
