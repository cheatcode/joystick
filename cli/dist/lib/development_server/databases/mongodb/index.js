import e from"child_process";import y from"fs";import a from"os";import u from"../../../cli_log.js";import b from"../../../command_exists.js";import h from"../../../get_platform_safe_path.js";import k from"../../../get_process_id_from_port.js";import v from"../../../kill_port_process.js";import r from"../../../path_exists.js";const{rename:j,readdir:x,mkdir:$}=y.promises,K=()=>{u(` MongoDB is not installed on this computer.

 Download MongoDB at https://www.mongodb.com/try/download/community

 After you've installed MongoDB, run joystick start again, or, remove MongoDB from your config.databases array in your settings.development.json file to skip starting it up.`,{level:"danger",docs:"https://github.com/cheatcode/joystick#databases"})},L=async()=>{if(process.platform==="win32"){const o=await i();return o&&o.length>0}return b("mongod")},i=async()=>await x("C:\\Program Files\\MongoDB\\Server\\"),D=()=>process.platform==="win32"?"mongosh.exe":"mongo",B=()=>process.platform==="win32"?"mongod.exe":"mongod",M=(o=2610,s=[])=>new Promise(t=>{const c=B(),m=`${a.homedir()}/.joystick/databases/mongodb/bin/bin/${c}`,d=["--port",o,"--dbpath",h(`./.joystick/data/mongodb_${o}`),"--quiet","--replSet",`joystick_${o}`];e.spawn(m,d.filter(n=>!!n)).stdout.on("data",async n=>{if((n?.toString()).includes("Waiting for connections")){const _=D(),g=`${a.homedir()}/.joystick/databases/mongodb/bin/bin/${_}`;e.exec(`${g} --eval "rs.initiate()" --verbose --port ${o}`,async(p,l,f)=>{console.log({error:p,_stdout:l,stderr:f});const w=await k(o);return t(parseInt(w,10))})}})}),S=async(o=2610)=>{const s=await r(".joystick/data/mongodb"),t=await r(`.joystick/data/mongodb_${o}`);return s&&!t&&await j(".joystick/data/mongodb",`.joystick/data/mongodb_${o}`),t||await $(`.joystick/data/mongodb_${o}`,{recursive:!0}),t},P=async(o=2610)=>{const s=process.platform==="win32"?await i():null;await S(o);try{return await v(o),await M(o,s)}catch(t){console.warn(t),process.exit(1)}};var N=P;export{N as default};
