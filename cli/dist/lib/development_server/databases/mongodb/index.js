import e from"child_process";import m from"fs";import _ from"../../../cli_log.js";import g from"../../../command_exists.js";import p from"../../../get_platform_safe_path.js";import l from"../../../get_process_id_from_port.js";import f from"../../../kill_port_process.js";import a from"../../../path_exists.js";const{rename:u,readdir:w,mkdir:y}=m.promises,b=()=>{_(` MongoDB is not installed on this computer.

 Download MongoDB at https://www.mongodb.com/try/download/community

 After you've installed MongoDB, run joystick start again, or, remove MongoDB from your config.databases array in your settings.development.json file to skip starting it up.`,{level:"danger",docs:"https://github.com/cheatcode/joystick#databases"})},h=async()=>{if(process.platform==="win32"){const o=await i();return o&&o.length>0}return g("mongod")},i=async()=>await w("C:\\Program Files\\MongoDB\\Server\\"),k=(o=[])=>process.platform==="win32"&&["6.0","7.0","8.0","9.0","10.0"].some(t=>o.includes(t))?"mongosh":"mongo",v=(o=2610,s=[])=>new Promise(t=>{const n=["--port",o,"--dbpath",p(`./.joystick/data/mongodb_${o}`),"--quiet","--replSet",`joystick_${o}`];e.spawn("mongod",n.filter(r=>!!r)).stdout.on("data",async r=>{if((r?.toString()).includes("Waiting for connections")){const c=k(s);e.exec(`${c} --eval "rs.initiate()" --verbose --port ${o}`,async(B,M,S)=>{const d=await l(o);return t(parseInt(d,10))})}})}),x=async(o=2610)=>{const s=await a(".joystick/data/mongodb"),t=await a(`.joystick/data/mongodb_${o}`);return s&&!t&&await u(".joystick/data/mongodb",`.joystick/data/mongodb_${o}`),t||await y(`.joystick/data/mongodb_${o}`,{recursive:!0}),t},j=async(o=2610)=>{const s=await h(),t=process.platform==="win32"?await i():null;s||(b(),process.exit(1)),await x(o);try{return await f(o),await v(o,t)}catch(n){console.warn(n),process.exit(1)}};var E=j;export{E as default};
