import a from"child_process";import f from"fs";import i from"os";import w from"../../../cli_log.js";import y from"../../../command_exists.js";import u from"../../../get_platform_safe_path.js";import b from"../../../get_process_id_from_port.js";import h from"../../../kill_port_process.js";import c from"../../../path_exists.js";const{rename:k,readdir:v,mkdir:j}=f.promises,K=()=>{w(` MongoDB is not installed on this computer.

 Download MongoDB at https://www.mongodb.com/try/download/community

 After you've installed MongoDB, run joystick start again, or, remove MongoDB from your config.databases array in your settings.development.json file to skip starting it up.`,{level:"danger",docs:"https://github.com/cheatcode/joystick#databases"})},L=async()=>{if(process.platform==="win32"){const o=await m();return o&&o.length>0}return y("mongod")},m=async()=>await v("C:\\Program Files\\MongoDB\\Server\\"),x=()=>process.platform==="win32"?"mongsh.exe":"mongo",$=()=>process.platform==="win32"?"mongod.exe":"mongod",D=(o=2610,s=[])=>new Promise(t=>{const d=$(),_=`${i.homedir()}/.joystick/databases/mongodb/bin/bin/${d}`,g=["--port",o,"--dbpath",u(`./.joystick/data/mongodb_${o}`),"--quiet","--replSet",`joystick_${o}`];a.spawn(_,g.filter(n=>!!n)).stdout.on("data",async n=>{const e=n?.toString();if(console.log(e),e.includes("Waiting for connections")){const p=x(),r=`${i.homedir()}/.joystick/databases/mongodb/bin/bin/${p}`;console.log(r),a.exec(`${r} --eval "rs.initiate()" --verbose --port ${o}`,async(P,q,A)=>{const l=await b(o);return t(parseInt(l,10))})}})}),B=async(o=2610)=>{const s=await c(".joystick/data/mongodb"),t=await c(`.joystick/data/mongodb_${o}`);return s&&!t&&await k(".joystick/data/mongodb",`.joystick/data/mongodb_${o}`),t||await j(`.joystick/data/mongodb_${o}`,{recursive:!0}),t},M=async(o=2610)=>{const s=process.platform==="win32"?await m():null;await B(o);try{return await h(o),await D(o,s)}catch(t){console.warn(t),process.exit(1)}};var N=M;export{N as default};
