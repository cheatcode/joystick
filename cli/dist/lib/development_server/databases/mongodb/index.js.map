{
  "version": 3,
  "sources": ["../../../../../src/lib/development_server/databases/mongodb/index.js"],
  "sourcesContent": ["import child_process from \"child_process\";\nimport fs from \"fs\";\nimport os from \"os\";\nimport get_platform_safe_path from '../../../get_platform_safe_path.js';\nimport get_process_id_from_port from \"../../../get_process_id_from_port.js\";\nimport kill_port_process from \"../../../kill_port_process.js\";\nimport path_exists from \"../../../path_exists.js\";\n\nconst { rename, mkdir } = fs.promises;\n\nconst get_mongo_shell_command = () => {\n  if (process.platform === 'win32') {\n    return 'mongosh.exe';\n  }\n\n  return 'mongosh';\n};\n\nconst get_mongo_server_command = () => {\n  if (process.platform === 'win32') {\n    return 'mongod.exe';\n  }\n\n  return 'mongod';\n};\n\nconst start_mongodb_process = (mongodb_port = 2610) => {\n  return new Promise((resolve) => {\n    // TODO: Does this hold up on Linux?\n    const mongo_server_command = get_mongo_server_command();\n    const joystick_mongod_path = `${os.homedir()}/.joystick/databases/mongodb/bin/bin/${mongo_server_command}`;\n    const database_process_flags = [\n      '--port',\n      mongodb_port,\n      '--dbpath',\n      get_platform_safe_path(`./.joystick/data/mongodb_${mongodb_port}`),\n      '--quiet',\n      '--replSet',\n      `joystick_${mongodb_port}`,\n    ];\n\n    const database_process = child_process.spawn(\n      joystick_mongod_path,\n      database_process_flags.filter((command) => !!command),\n    );\n\n    database_process.stdout.on('data', async (data) => {\n      const stdout = data?.toString();\n\n      if (stdout.includes('Waiting for connections')) {\n        const mongo_shell_command = get_mongo_shell_command();\n        const joystick_mongo_shell_path = `${os.homedir()}/.joystick/databases/mongodb/bin/bin/${mongo_shell_command}`;\n        child_process.exec(`${joystick_mongo_shell_path} --eval \"rs.initiate()\" --verbose --port ${mongodb_port}`, async (error, _stdout, _stderr) => {\n          if (error && !error?.message?.includes('already initialized')) {\n            console.log(error);\n          }\n\n          const process_id = await get_process_id_from_port(mongodb_port);\n          return resolve(parseInt(process_id, 10));\n        });\n      }\n    });\n\n    database_process.stderr.on('data', async (data) => {\n      const stderr = data.toString();\n      console.log(stderr);\n    });\n  });\n};\n\nconst setup_data_directory = async (mongodb_port = 2610) => {\n  // NOTE: MongoDB was originally started as a standalone server. To enable additional functionality,\n  // we moved to a replica set config which necessitated multiple data directories in order to support\n  // running the same app on multiple ports (a limitation of MongoDB).\n  const legacy_data_directory_exists = await path_exists(\".joystick/data/mongodb\");\n  const data_directory_exists = await path_exists(`.joystick/data/mongodb_${mongodb_port}`);\n\n  if (legacy_data_directory_exists && !data_directory_exists) {\n    await rename('.joystick/data/mongodb', `.joystick/data/mongodb_${mongodb_port}`);\n  }\n\n  if (!data_directory_exists) {\n    await mkdir(`.joystick/data/mongodb_${mongodb_port}`, { recursive: true });\n  }\n\n  return data_directory_exists;\n};\n\nconst start_mongodb = async (mongodb_port = 2610) => {\n  await setup_data_directory(mongodb_port);\n\n  try {\n    await kill_port_process(mongodb_port);\n    const mongo_process_id = await start_mongodb_process(mongodb_port);\n    return mongo_process_id;\n  } catch (exception) {\n    console.warn(exception);\n    process.exit(1);\n  }\n};\n\nexport default start_mongodb;\n"],
  "mappings": "AAAA,OAAOA,MAAmB,gBAC1B,OAAOC,MAAQ,KACf,OAAOC,MAAQ,KACf,OAAOC,MAA4B,qCACnC,OAAOC,MAA8B,uCACrC,OAAOC,MAAuB,gCAC9B,OAAOC,MAAiB,0BAExB,KAAM,CAAE,OAAAC,EAAQ,MAAAC,CAAM,EAAIP,EAAG,SAEvBQ,EAA0B,IAC1B,QAAQ,WAAa,QAChB,cAGF,UAGHC,EAA2B,IAC3B,QAAQ,WAAa,QAChB,aAGF,SAGHC,EAAwB,CAACC,EAAe,OACrC,IAAI,QAASC,GAAY,CAE9B,MAAMC,EAAuBJ,EAAyB,EAChDK,EAAuB,GAAGb,EAAG,QAAQ,CAAC,wCAAwCY,CAAoB,GAClGE,EAAyB,CAC7B,SACAJ,EACA,WACAT,EAAuB,4BAA4BS,CAAY,EAAE,EACjE,UACA,YACA,YAAYA,CAAY,EAC1B,EAEMK,EAAmBjB,EAAc,MACrCe,EACAC,EAAuB,OAAQE,GAAY,CAAC,CAACA,CAAO,CACtD,EAEAD,EAAiB,OAAO,GAAG,OAAQ,MAAOE,GAAS,CAGjD,IAFeA,GAAM,SAAS,GAEnB,SAAS,yBAAyB,EAAG,CAC9C,MAAMC,EAAsBX,EAAwB,EAC9CY,EAA4B,GAAGnB,EAAG,QAAQ,CAAC,wCAAwCkB,CAAmB,GAC5GpB,EAAc,KAAK,GAAGqB,CAAyB,4CAA4CT,CAAY,GAAI,MAAOU,EAAOC,EAASC,IAAY,CACxIF,GAAS,CAACA,GAAO,SAAS,SAAS,qBAAqB,GAC1D,QAAQ,IAAIA,CAAK,EAGnB,MAAMG,EAAa,MAAMrB,EAAyBQ,CAAY,EAC9D,OAAOC,EAAQ,SAASY,EAAY,EAAE,CAAC,CACzC,CAAC,CACH,CACF,CAAC,EAEDR,EAAiB,OAAO,GAAG,OAAQ,MAAOE,GAAS,CACjD,MAAMO,EAASP,EAAK,SAAS,EAC7B,QAAQ,IAAIO,CAAM,CACpB,CAAC,CACH,CAAC,EAGGC,EAAuB,MAAOf,EAAe,OAAS,CAI1D,MAAMgB,EAA+B,MAAMtB,EAAY,wBAAwB,EACzEuB,EAAwB,MAAMvB,EAAY,0BAA0BM,CAAY,EAAE,EAExF,OAAIgB,GAAgC,CAACC,GACnC,MAAMtB,EAAO,yBAA0B,0BAA0BK,CAAY,EAAE,EAG5EiB,GACH,MAAMrB,EAAM,0BAA0BI,CAAY,GAAI,CAAE,UAAW,EAAK,CAAC,EAGpEiB,CACT,EAEMC,EAAgB,MAAOlB,EAAe,OAAS,CACnD,MAAMe,EAAqBf,CAAY,EAEvC,GAAI,CACF,aAAMP,EAAkBO,CAAY,EACX,MAAMD,EAAsBC,CAAY,CAEnE,OAASmB,EAAW,CAClB,QAAQ,KAAKA,CAAS,EACtB,QAAQ,KAAK,CAAC,CAChB,CACF,EAEA,IAAOC,EAAQF",
  "names": ["child_process", "fs", "os", "get_platform_safe_path", "get_process_id_from_port", "kill_port_process", "path_exists", "rename", "mkdir", "get_mongo_shell_command", "get_mongo_server_command", "start_mongodb_process", "mongodb_port", "resolve", "mongo_server_command", "joystick_mongod_path", "database_process_flags", "database_process", "command", "data", "mongo_shell_command", "joystick_mongo_shell_path", "error", "_stdout", "_stderr", "process_id", "stderr", "setup_data_directory", "legacy_data_directory_exists", "data_directory_exists", "start_mongodb", "exception", "index_default"]
}
