{
  "version": 3,
  "sources": ["../../../../src/lib/development_server/databases/installer.js"],
  "sourcesContent": ["import fs from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport { promisify } from 'util';\nimport { pipeline } from 'stream';\nimport { execFile } from 'child_process';\n\nconst stream_pipeline = promisify(pipeline);\nconst exec_file_async = promisify(execFile);\n\nconst database_versions = {\n  mongodb: '8',\n  postgresql: '16',\n  redis: '7',\n};\n\nconst database_display_names = {\n  mongodb: 'MongoDB',\n  postgresql: 'PostgreSQL',\n  redis: 'Redis',\n};\n\nconst get_platform = () => {\n  const platform = os.platform();\n  if (platform === 'darwin') return 'macos';\n  if (platform === 'linux') return 'linux';\n  throw new Error(`Unsupported platform: ${platform}. Please use WSL2 on Windows.`);\n};\n\nconst get_architecture = () => {\n  const arch = os.arch();\n  if (arch === 'arm64') return 'arm64';\n  if (arch === 'x64') return 'x86_64';\n  throw new Error(`Unsupported architecture: ${arch}`);\n};\n\nconst build_download_url = (database, version, platform, architecture) => {\n  const cache_buster = Date.now();\n  return `https://cdn.joystickjs.com/${database}/${version}/${platform}/${architecture}.tar.gz?t=${cache_buster}`;\n};\n\nconst check_if_file_exists = async (file_path) => {\n  try {\n    await fs.promises.access(file_path);\n    return true;\n  } catch {\n    return false;\n  }\n};\n\nconst download_file = async (url, file_path) => {\n  const response = await fetch(url);\n  if (!response.ok) {\n    throw new Error(`Failed to download ${url}: ${response.statusText}`);\n  }\n  await stream_pipeline(response.body, fs.createWriteStream(file_path));\n};\n\nconst make_files_executable = async (directory) => {\n  const files = await fs.promises.readdir(directory);\n  for (const file of files) {\n    const file_path = path.join(directory, file);\n    const stats = await fs.promises.stat(file_path);\n    if (stats.isFile()) {\n      await fs.promises.chmod(file_path, '755');\n    }\n  }\n};\n\nconst install_database = async (database_name) => {\n  const base_directory = path.join(os.homedir(), '.joystick', 'databases', database_name);\n\n  if (await check_if_file_exists(base_directory)) {\n    return;\n  }\n\n  const platform = get_platform();\n  const architecture = get_architecture();\n  const version = database_versions[database_name];\n\n  if (!version) {\n    throw new Error(`Unsupported database: ${database_name}`);\n  }\n\n  const download_url = build_download_url(database_name, version, platform, architecture);\n  const archive_filename = `${database_name}.tar.gz`;\n  const archive_path = path.join(base_directory, archive_filename);\n  const display_name = database_display_names[database_name] || database_name;\n\n  process.loader.print(`${display_name} not found. Downloading... (this may take a few minutes)`);\n\n  await fs.promises.mkdir(base_directory, { recursive: true });\n  await download_file(download_url, archive_path);\n\n  process.loader.print(`Installing ${display_name}...`);\n\n  await exec_file_async('tar', ['-xzf', archive_path, '-C', base_directory]);\n  await fs.promises.unlink(archive_path);\n  await make_files_executable(base_directory);\n\n  process.loader.print(`${display_name} installed!`);\n};\n\nexport default install_database;\n"],
  "mappings": "AAAA,OAAOA,MAAQ,KACf,OAAOC,MAAU,OACjB,OAAOC,MAAQ,KACf,OAAS,aAAAC,MAAiB,OAC1B,OAAS,YAAAC,MAAgB,SACzB,OAAS,YAAAC,MAAgB,gBAEzB,MAAMC,EAAkBH,EAAUC,CAAQ,EACpCG,EAAkBJ,EAAUE,CAAQ,EAEpCG,EAAoB,CACxB,QAAS,IACT,WAAY,KACZ,MAAO,GACT,EAEMC,EAAyB,CAC7B,QAAS,UACT,WAAY,aACZ,MAAO,OACT,EAEMC,EAAe,IAAM,CACzB,MAAMC,EAAWT,EAAG,SAAS,EAC7B,GAAIS,IAAa,SAAU,MAAO,QAClC,GAAIA,IAAa,QAAS,MAAO,QACjC,MAAM,IAAI,MAAM,yBAAyBA,CAAQ,+BAA+B,CAClF,EAEMC,EAAmB,IAAM,CAC7B,MAAMC,EAAOX,EAAG,KAAK,EACrB,GAAIW,IAAS,QAAS,MAAO,QAC7B,GAAIA,IAAS,MAAO,MAAO,SAC3B,MAAM,IAAI,MAAM,6BAA6BA,CAAI,EAAE,CACrD,EAEMC,EAAqB,CAACC,EAAUC,EAASL,EAAUM,IAAiB,CACxE,MAAMC,EAAe,KAAK,IAAI,EAC9B,MAAO,8BAA8BH,CAAQ,IAAIC,CAAO,IAAIL,CAAQ,IAAIM,CAAY,aAAaC,CAAY,EAC/G,EAEMC,EAAuB,MAAOC,GAAc,CAChD,GAAI,CACF,aAAMpB,EAAG,SAAS,OAAOoB,CAAS,EAC3B,EACT,MAAQ,CACN,MAAO,EACT,CACF,EAEMC,EAAgB,MAAOC,EAAKF,IAAc,CAC9C,MAAMG,EAAW,MAAM,MAAMD,CAAG,EAChC,GAAI,CAACC,EAAS,GACZ,MAAM,IAAI,MAAM,sBAAsBD,CAAG,KAAKC,EAAS,UAAU,EAAE,EAErE,MAAMjB,EAAgBiB,EAAS,KAAMvB,EAAG,kBAAkBoB,CAAS,CAAC,CACtE,EAEMI,EAAwB,MAAOC,GAAc,CACjD,MAAMC,EAAQ,MAAM1B,EAAG,SAAS,QAAQyB,CAAS,EACjD,UAAWE,KAAQD,EAAO,CACxB,MAAMN,EAAYnB,EAAK,KAAKwB,EAAWE,CAAI,GAC7B,MAAM3B,EAAG,SAAS,KAAKoB,CAAS,GACpC,OAAO,GACf,MAAMpB,EAAG,SAAS,MAAMoB,EAAW,KAAK,CAE5C,CACF,EAEMQ,EAAmB,MAAOC,GAAkB,CAChD,MAAMC,EAAiB7B,EAAK,KAAKC,EAAG,QAAQ,EAAG,YAAa,YAAa2B,CAAa,EAEtF,GAAI,MAAMV,EAAqBW,CAAc,EAC3C,OAGF,MAAMnB,EAAWD,EAAa,EACxBO,EAAeL,EAAiB,EAChCI,EAAUR,EAAkBqB,CAAa,EAE/C,GAAI,CAACb,EACH,MAAM,IAAI,MAAM,yBAAyBa,CAAa,EAAE,EAG1D,MAAME,EAAejB,EAAmBe,EAAeb,EAASL,EAAUM,CAAY,EAChFe,EAAmB,GAAGH,CAAa,UACnCI,EAAehC,EAAK,KAAK6B,EAAgBE,CAAgB,EACzDE,EAAezB,EAAuBoB,CAAa,GAAKA,EAE9D,QAAQ,OAAO,MAAM,GAAGK,CAAY,0DAA0D,EAE9F,MAAMlC,EAAG,SAAS,MAAM8B,EAAgB,CAAE,UAAW,EAAK,CAAC,EAC3D,MAAMT,EAAcU,EAAcE,CAAY,EAE9C,QAAQ,OAAO,MAAM,cAAcC,CAAY,KAAK,EAEpD,MAAM3B,EAAgB,MAAO,CAAC,OAAQ0B,EAAc,KAAMH,CAAc,CAAC,EACzE,MAAM9B,EAAG,SAAS,OAAOiC,CAAY,EACrC,MAAMT,EAAsBM,CAAc,EAE1C,QAAQ,OAAO,MAAM,GAAGI,CAAY,aAAa,CACnD,EAEA,IAAOC,EAAQP",
  "names": ["fs", "path", "os", "promisify", "pipeline", "execFile", "stream_pipeline", "exec_file_async", "database_versions", "database_display_names", "get_platform", "platform", "get_architecture", "arch", "build_download_url", "database", "version", "architecture", "cache_buster", "check_if_file_exists", "file_path", "download_file", "url", "response", "make_files_executable", "directory", "files", "file", "install_database", "database_name", "base_directory", "download_url", "archive_filename", "archive_path", "display_name", "installer_default"]
}
