import g from"child_process";import I from"fs";import L from"util";import f from"os";import r from"path";import D from"../../../get_platform_safe_path.js";import y from"../../../get_process_id_from_port.js";import u from"../../../path_exists.js";const i=L.promisify(g.exec),{rename:A}=I.promises,R=()=>{const t=f.arch();if(t==="arm64")return"arm64";if(t==="x64")return"x86_64";throw new Error(`Unsupported architecture: ${t}`)},c=t=>{const s={...process.env},o=r.join(t,"lib");return process.platform==="darwin"?s.DYLD_LIBRARY_PATH=o:process.platform==="linux"&&(s.LD_LIBRARY_PATH=o),s},P=async(t=2610)=>{const s=await u(".joystick/data/postgresql");let o=await u(`.joystick/data/postgresql_${t}`);return s&&!o&&(await A(".joystick/data/postgresql",`.joystick/data/postgresql_${t}`),o=!0),o},Y=()=>process.platform==="win32"?"createdb.exe":"createdb",B=()=>process.platform==="win32"?"postgres.exe":"postgres",H=()=>process.platform==="win32"?"initdb.exe":"initdb",S=()=>process.platform==="win32"?"pgctl.exe":"pgctl",T=async(t=2610)=>{try{const s=t,o=R(),e=r.join(f.homedir(),".joystick","databases","postgresql",o),b=S(),j=H(),h=B(),x=Y(),w=r.join(e,"bin",b),k=r.join(e,"bin",j),$=r.join(e,"bin",h),q=r.join(e,"bin",x);await P(t)||await i(`${k} -D .joystick/data/postgresql_${t} --no-locale`,{env:c(e)});const p=parseInt(await y(s),10);p&&await i(`${w} kill KILL ${p}`,{env:c(e)});const _=g.spawn($,[`-p ${s}`,"-D",D(`.joystick/data/postgresql_${t}`)],{env:c(e)});return new Promise(d=>{_.stderr.on("data",async a=>{if((a?.toString()).includes("database system is ready to accept connections")){const l=(await y(s))?.replace(`
`,""),v=`${q} -h 127.0.0.1 -p ${s} app`;i(v,{env:c(e)}).then(()=>{d(parseInt(l,10))}).catch(({stderr:n})=>{n&&n.includes('database "app" already exists')?d(parseInt(l,10)):console.log(n)})}}),_.stdout.on("data",async a=>{const m=a?.toString();console.log(m)})})}catch(s){console.warn(s),process.exit(1)}};var N=T;export{N as default};
//# sourceMappingURL=index.js.map
