import n from"child_process";import x from"fs";import q from"util";import I from"os";import"path";import f from"../../../get_platform_safe_path.js";import g from"../../../get_process_id_from_port.js";import u from"../../../path_exists.js";const e=q.promisify(n.exec),{rename:D,mkdir:L,readdir:O}=x.promises,v=async(t=2610)=>{const o=await u(".joystick/data/postgresql");let s=await u(`.joystick/data/postgresql_${t}`);return o&&!s&&(await D(".joystick/data/postgresql",`.joystick/data/postgresql_${t}`),s=!0),s||(await L(`.joystick/data/postgresql_${t}`,{recursive:!0}),s=!0),process.platform==="linux"&&(await e("sudo chmod 755 /root"),await e(`sudo chmod 755 /root/${process.project_folder}`),await e(`sudo chmod 755 /root/${process.project_folder}/.joystick`),await e(`sudo chmod 700 /root/${process.project_folder}/.joystick/data/postgresql_${t}`),await e(`sudo chown -R postgres:postgres /root/${process.project_folder}/.joystick/data/postgresql_${t}`)),s},K=()=>process.platform==="win32"?"createdb.exe":"createdb",S=()=>process.platform==="win32"?"postgres.exe":"postgres",P=()=>process.platform==="win32"?"initdb.exe":"initdb",R=()=>process.platform==="win32"?"pgctl.exe":"pgctl",z=async(t=2610)=>{try{const o=t,s=`${I.homedir()}/.joystick/databases/postgresql/bin/bin`,y=R(),$=P(),w=S(),j=K(),p=`${s}/${y}`,h=`${s}/${$}`,k=`${s}/${w}`,d=`${s}/${j}`;await v(t)&&(process.platform==="linux"?await e(`sudo -u postgres ./initdb -D ${process.cwd()}/.joystick/data/postgresql_${t} --no-locale`,{cwd:s}):await e(`${h} -D .joystick/data/postgresql_${t} --options=--no-locale`));const r=parseInt(await g(o),10);r&&(process.platform==="linux"?await e(`${p} kill KILL ${r}`):await e(`${p} kill KILL ${r}`));const _=process.platform==="linux"?n.spawn("sudo",["-u","postgres","bash","-c",`./postgres -p ${o} -D ${f(`${process.cwd()}/.joystick/data/postgresql_${t}`)} > >(tee /dev/stderr) 2> >(tee /dev/stderr >&2)`],{cwd:s,shell:"/bin/bash",stdio:["ignore","pipe","pipe"]}):n.spawn(k,[`-p ${o}`,"-D",f(`.joystick/data/postgresql_${t}`)]);return new Promise(l=>{_.stderr.on("data",async a=>{const c=a?.toString();c?.includes("another server might be running")||console.warn(c)}),_.stdout.on("data",async a=>{if((a?.toString()).includes("database system is ready to accept connections")){const m=(await g(o))?.replace(`
`,""),b=process.platform==="linux"?`sudo -u postgres ${d} -h 127.0.0.1 -p ${o} app`:`${d} -h 127.0.0.1 -p ${o} app`;e(b).then(()=>{l(parseInt(m,10))}).catch(({stderr:i})=>{i&&i.includes('database "app" already exists')?l(parseInt(m,10)):console.log(i)})}})})}catch(o){console.warn(o),process.exit(1)}};var Q=z;export{Q as default};
