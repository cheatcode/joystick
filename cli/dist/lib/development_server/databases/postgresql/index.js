import m from"child_process";import w from"fs";import h from"util";import g from"os";import k from"../../../cli_log.js";import b from"../../../command_exists.js";import x from"../../../get_platform_safe_path.js";import y from"../../../get_process_id_from_port.js";import"../../../kill_port_process.js";import f from"../../../path_exists.js";const p=h.promisify(m.exec),{rename:j}=w.promises,$=async(t=2610)=>{const e=await f(".joystick/data/postgresql");let a=await f(`.joystick/data/postgresql_${t}`);return e&&!a&&(await j(".joystick/data/postgresql",`.joystick/data/postgresql_${t}`),a=!0),a},F=()=>{k("PostgreSQL is not installed on this computer. You can download PostgreSQL at https://www.postgresql.org/download. After you've installed PostgreSQL, run joystick start again, or, remove PostgreSQL from your databases list in your settings.development.json file to skip startup.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli#databases"})},G=()=>b("psql"),q=()=>process.platform==="win32"?"createdb.exe":"createdb",L=()=>process.platform==="win32"?"pg_ctl.exe":"pg_ctl",S=async(t=2610)=>{try{const e=L(),a=q(),i=`${g.homedir()}/.joystick/databases/postgresql/bin/bin/${e}`,u=`${g.homedir()}/.joystick/databases/postgresql/bin/bin/${a}`;await $(t)||await p(`${i} init -D .joystick/data/postgresql_${t} --options=--no-locale`).catch(s=>{console.warn(s)});const c=t,d=parseInt(await y(c),10);d&&await p(`${i} kill KILL ${d}`);const l=m.spawn(`${i}`,["-o",`"-p ${c}"`,"-D",x(`.joystick/data/postgresql_${t}`),"start"].filter(s=>!!s));return new Promise(s=>{l.stderr.on("data",async n=>{const o=n?.toString();console.log(o),o?.includes("another server might be running")||console.warn(o)}),l.stdout.on("data",async n=>{const o=n?.toString();if(console.log(o),o.includes("database system is ready to accept connections")){const _=(await y(c))?.replace(`
`,"");p(`${u} -h 127.0.0.1 -p ${c} app`).then(r=>{s(parseInt(_,10))}).catch(({stderr:r})=>{console.log(r),r&&r.includes('database "app" already exists')?s(parseInt(_,10)):console.log(r)})}})})}catch(e){console.warn(e),process.exit(1)}};var H=S;export{H as default};
