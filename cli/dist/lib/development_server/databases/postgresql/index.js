import g from"child_process";import $ from"fs";import h from"util";import _ from"os";import k from"../../../get_platform_safe_path.js";import f from"../../../get_process_id_from_port.js";import u from"../../../path_exists.js";const e=h.promisify(g.exec),{rename:b,mkdir:j}=$.promises,x=async(t=2610)=>{const a=await u(".joystick/data/postgresql");let s=await u(`.joystick/data/postgresql_${t}`);if(a&&!s&&(await b(".joystick/data/postgresql",`.joystick/data/postgresql_${t}`),s=!0),s||(await j(`.joystick/data/postgresql_${t}`,{recursive:!0}),s=!0),process.platform==="linux")try{await e(`sudo chown postgres:postgres .joystick/data/postgresql_${t}`),await e(`sudo chmod 700 .joystick/data/postgresql_${t}`)}catch(r){throw console.error("Error setting permissions for data directory:",r),r}return s},q=()=>process.platform==="win32"?"createdb.exe":"createdb",I=()=>process.platform==="win32"?"pg_ctl.exe":"pg_ctl",D=async(t=2610)=>{try{const a=I(),s=q(),r=`${_.homedir()}/.joystick/databases/postgresql/bin`,n=`${_.platform()==="linux"?"sudo -u postgres ":""}${r}/bin/${a}`,w=`${_.homedir()}/.joystick/databases/postgresql/bin/bin/${s}`;await x(t)||await e(`${n} init -D .joystick/data/postgresql_${t} --options=--no-locale`).catch(o=>{console.warn(o)});const i=t,l=parseInt(await f(i),10);l&&await e(`${n} kill KILL ${l}`);const m=g.spawn(`${n}`,["-o",`"-p ${i}"`,"-D",k(`.joystick/data/postgresql_${t}`),"start"].filter(o=>!!o));return new Promise(o=>{m.stderr.on("data",async d=>{const p=d?.toString();p?.includes("another server might be running")||console.warn(p)}),m.stdout.on("data",async d=>{if((d?.toString()).includes("database system is ready to accept connections")){const y=(await f(i))?.replace(`
`,"");e(`${w} -h 127.0.0.1 -p ${i} app`).then(c=>{o(parseInt(y,10))}).catch(({stderr:c})=>{c&&c.includes('database "app" already exists')?o(parseInt(y,10)):console.log(c)})}})})}catch(a){console.warn(a),process.exit(1)}};var B=D;export{B as default};
