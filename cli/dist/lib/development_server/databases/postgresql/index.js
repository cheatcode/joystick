import _ from"child_process";import u from"fs";import h from"util";import m from"os";import w from"../../../cli_log.js";import g from"../../../command_exists.js";import k from"../../../get_platform_safe_path.js";import y from"../../../get_process_id_from_port.js";import"../../../kill_port_process.js";import f from"../../../path_exists.js";const n=h.promisify(_.exec),{rename:x}=u.promises,q=async(t=2610)=>{const s=await f(".joystick/data/postgresql");let o=await f(`.joystick/data/postgresql_${t}`);return s&&!o&&(await x(".joystick/data/postgresql",`.joystick/data/postgresql_${t}`),o=!0),o},z=()=>{w("PostgreSQL is not installed on this computer. You can download PostgreSQL at https://www.postgresql.org/download. After you've installed PostgreSQL, run joystick start again, or, remove PostgreSQL from your databases list in your settings.development.json file to skip startup.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli#databases"})},B=()=>g("psql"),C=()=>g("pg_ctl"),j=async(t=2610)=>{try{const s=`${m.homedir()}/.joystick/databases/postgresql/bin/pg_ctl`,o=`${m.homedir()}/.joystick/databases/postgresql/bin/createdb`;await q(t)||await n(`${s} init -D .joystick/data/postgresql_${t} --options=--no-locale`);const e=t,p=parseInt(await y(e),10);p&&await n(`${s} kill KILL ${p}`);const d=_.spawn(`${s}`,["-o",`"-p ${e}"`,"-D",k(`.joystick/data/postgresql_${t}`),"start"].filter(a=>!!a));return new Promise(a=>{d.stderr.on("data",async i=>{const c=i?.toString();c?.includes("another server might be running")||console.warn(c)}),d.stdout.on("data",async i=>{if((i?.toString()).includes("database system is ready to accept connections")){const l=(await y(e))?.replace(`
`,"");n(`${o} -h 127.0.0.1 -p ${e} app`).then(r=>{a(parseInt(l,10))}).catch(({stderr:r})=>{r&&r.includes('database "app" already exists')?a(parseInt(l,10)):console.log(r)})}})})}catch(s){console.warn(s),process.exit(1)}};var E=j;export{E as default};
