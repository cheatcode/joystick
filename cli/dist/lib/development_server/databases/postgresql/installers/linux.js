import t from"fs";import s from"path";import w from"os";import{promisify as p}from"util";import{pipeline as m}from"stream";import{execFile as f}from"child_process";const g=p(m),a=p(f),h=async(e=null)=>{const r=s.join(w.homedir(),".joystick","databases","postgresql"),o=s.join(r,"bin"),l=s.join(o,"bin");if(await b(r))return;await k(r,o,l);const d="https://ftp.postgresql.org/pub/source/v16.0/postgresql-16.0.tar.gz",u=s.basename(new URL(d).pathname),c=s.join(r,u);process.loader.print("PostgreSQL not found. Downloading..."),await y(d,c),process.loader.print("Installing PostgreSQL..."),await a("tar",["-xzf",c,"-C",r]);const n=s.join(r,"postgresql-16.0");await _();try{await a("./configure",["--prefix="+o,"--without-icu"],{cwd:n})}catch(i){throw console.error("Error during PostgreSQL configuration:",i),i}try{await a("make",[],{cwd:n})}catch(i){throw console.error("Error during PostgreSQL build:",i),i}try{await a("make",["install"],{cwd:n})}catch(i){throw console.error("Error during PostgreSQL installation:",i),i}await t.promises.unlink(c),await t.promises.rm(n,{recursive:!0,force:!0}),await x(l),process.loader.print("PostgreSQL installed!")},_=async()=>{const e=["gcc","make","libreadline-dev","zlib1g-dev"];for(const r of e)try{await a("dpkg",["-s",r])}catch{throw console.error(`Required package '${r}' is not installed.`),console.error("Please install the necessary dependencies. For Ubuntu or Debian, run:"),console.error(`sudo apt-get update && sudo apt-get install ${e.join(" ")}`),new Error("Missing dependencies")}},y=async(e,r)=>{const o=await fetch(e);if(!o.ok)throw new Error(`Failed to download: ${o.statusText}`);await g(o.body,t.createWriteStream(r))},b=async e=>{try{return await t.promises.access(e),!0}catch{return!1}},k=async(e,r,o)=>{await t.promises.mkdir(e,{recursive:!0}),await t.promises.mkdir(r,{recursive:!0}),await t.promises.mkdir(o,{recursive:!0})},x=async e=>{const r=await t.promises.readdir(e);for(const o of r)await t.promises.chmod(s.join(e,o),"755")};var Q=h;export{Q as default};
