import o from"fs";import s from"path";import m from"os";import{promisify as d}from"util";import{pipeline as w}from"stream";import{execFile as u}from"child_process";const f=d(w),i=d(u),g=async(r=null)=>{const e=s.join(m.homedir(),".joystick","databases","postgresql"),t=s.join(e,"bin"),c=s.join(t,"bin");if(await h(e))return;await y(e,t,c);const l="https://ftp.postgresql.org/pub/source/v16.0/postgresql-16.0.tar.gz",p=s.basename(new URL(l).pathname),n=s.join(e,p);process.loader.print("PostgreSQL not found. Downloading... (this may take a few minutes)"),await k(l,n),process.loader.print("Installing PostgreSQL..."),await i("tar",["-xzf",n,"-C",e]);const a=s.join(e,"postgresql-16.0");await _(),await i("./configure",["--prefix="+t],{cwd:a}),await i("make",[],{cwd:a}),await i("make",["install"],{cwd:a}),await o.promises.unlink(n),await o.promises.rm(a,{recursive:!0,force:!0}),await b(c),process.loader.print("PostgreSQL installed!")},_=async()=>{const r=["gcc","make","libreadline-dev","zlib1g-dev"];for(const e of r)try{await i("dpkg",["-s",e])}catch{throw console.error(`Required package '${e}' is not installed.`),console.error("Please install the necessary dependencies. For Ubuntu or Debian, run:"),console.error(`sudo apt-get update && sudo apt-get install ${r.join(" ")}`),new Error("Missing dependencies")}},k=async(r,e)=>{const t=await fetch(r);if(!t.ok)throw new Error(`Failed to download: ${t.statusText}`);await f(t.body,o.createWriteStream(e))},h=async r=>{try{return await o.promises.access(r),!0}catch{return!1}},y=async(r,e,t)=>{await o.promises.mkdir(r,{recursive:!0}),await o.promises.mkdir(e,{recursive:!0}),await o.promises.mkdir(t,{recursive:!0})},b=async r=>{const e=await o.promises.readdir(r);for(const t of e)await o.promises.chmod(s.join(r,t),"755")};var L=g;export{L as default};
