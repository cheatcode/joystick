import e from"fs";import t from"path";import h from"os";import{promisify as d}from"util";import{pipeline as b}from"stream";import{execFile as y}from"child_process";const g=d(b),j=d(y),k=async(o=null)=>{const i=t.join(h.homedir(),".joystick","databases","postgresql"),s=t.join(i,"bin"),n=t.join(s,"bin");if(await q(i))return;await v(i,s,n);const p="https://get.enterprisedb.com/postgresql/postgresql-16.0-1-osx-binaries.zip",f=t.basename(new URL(p).pathname),c=t.join(i,f);process.loader.print("PostgreSQL not found. Downloading... (this may take a few minutes)"),await x(p,c),process.loader.print("Installing PostgreSQL...");const r=t.join(i,"temp");await e.promises.mkdir(r,{recursive:!0}),await j("unzip",["-q",c,"-d",r]);const m=t.join(r,"pgsql","bin"),w=await e.promises.readdir(m);for(const a of w)await e.promises.rename(t.join(m,a),t.join(n,a));const u=["share","lib","include"];for(const a of u){const l=t.join(r,"pgsql",a),_=t.join(s,a);await e.promises.access(l).then(()=>!0).catch(()=>!1)&&await e.promises.rename(l,_)}await e.promises.unlink(c),await e.promises.rm(r,{recursive:!0,force:!0}),await L(n),process.loader.print("PostgreSQL installed!")},x=async(o,i)=>{const s=await fetch(o);if(!s.ok)throw new Error(`Failed to download: ${s.statusText}`);await g(s.body,e.createWriteStream(i))},q=async o=>{try{return await e.promises.access(o),!0}catch{return!1}},v=async(o,i,s)=>{await e.promises.mkdir(o,{recursive:!0}),await e.promises.mkdir(i,{recursive:!0}),await e.promises.mkdir(s,{recursive:!0})},L=async o=>{const i=await e.promises.readdir(o);for(const s of i)await e.promises.chmod(t.join(o,s),"755")};var D=k;export{D as default};
