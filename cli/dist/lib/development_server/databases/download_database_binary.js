import r from"fs";import e from"path";import c from"os";import"https";import{promisify as l}from"util";import{pipeline as w}from"stream";import{execFile as f}from"child_process";const u=l(w),p=l(f),g=async t=>{if(c.platform()!=="win32"){const o=await r.promises.readdir(t);for(const i of o)await r.promises.chmod(e.join(t,i),"755")}},h=async(t,s,o,i)=>{const n=c.platform();if(t==="redis")if(n==="win32")await p("powershell",["Expand-Archive","-Path",s,"-DestinationPath",i]);else{await p("tar",["-xzf",s,"-C",o,"--strip-components=1"]),await r.promises.unlink(s);const a=e.join(o,"src");await p("make",["-C",a]);const d=e.join(a,"redis-server"),m=e.join(a,"redis-cli");await r.promises.copyFile(d,e.join(i,"redis-server")),await r.promises.copyFile(m,e.join(i,"redis-cli"))}else n==="win32"?await p("powershell",["Expand-Archive","-Path",s,"-DestinationPath",i]):await p("tar",["-xzf",s,"-C",i,"--strip-components=1"]),await r.promises.unlink(s)},x=async(t,s)=>{const o=await fetch(t);if(!o.ok)throw new Error(`Failed to download: ${o.statusText}`);await u(o.body,r.createWriteStream(s))},b=async t=>{try{return await r.promises.access(t),!0}catch{return!1}},_=async()=>{if(c.platform()==="darwin"){const{stdout:t}=await p("sysctl",["-n","machdep.cpu.brand_string"]);return t.trim()}return c.arch()},y=async(t,s)=>{if(s){const a=await r.promises.readFile(s,"utf-8");return JSON.parse(a)[t].url}const o=c.platform();return{mongodb:{win32:"https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-6.0.5.zip",darwin:(await _()).includes("ARM")?"https://fastdl.mongodb.org/osx/mongodb-macos-arm64-6.0.5.tgz":"https://fastdl.mongodb.org/osx/mongodb-macos-x86_64-6.0.5.tgz",linux:"https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2004-6.0.5.tgz"},redis:{win32:"https://github.com/tporadowski/redis/releases/download/v5.0.14.1/Redis-x64-5.0.14.1.zip",darwin:"https://download.redis.io/releases/redis-6.2.6.tar.gz",linux:"https://download.redis.io/releases/redis-6.2.6.tar.gz"},postgresql:{win32:"https://get.enterprisedb.com/postgresql/postgresql-14.7-1-windows-x64-binaries.zip",darwin:"https://get.enterprisedb.com/postgresql/postgresql-14.7-1-osx-binaries.zip",linux:"https://ftp.postgresql.org/pub/source/v14.7/postgresql-14.7.tar.gz"}}[t][o]},z=async(t,s)=>{await r.promises.mkdir(t,{recursive:!0}),await r.promises.mkdir(s,{recursive:!0})},j=async(t,s=null)=>{const o=e.join(c.homedir(),".joystick","databases",t),i=e.join(o,"bin");await z(o,i);const n=await y(t,s),a=e.basename(new URL(n).pathname),d=e.join(o,a);await b(d)||(await x(n,d),await h(t,d,o,i),await g(i))};var R=j;export{R as default};
