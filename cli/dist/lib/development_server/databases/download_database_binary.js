import t from"fs";import s from"path";import d from"os";import"https";import{promisify as h}from"util";import{pipeline as k}from"stream";import{execFile as q}from"child_process";const F=h(k),m=h(q),g={mongodb:"MongoDB",postgresql:"PostgreSQL",redis:"Redis"},P=async o=>{if(d.platform()!=="win32"){const i=await t.promises.readdir(o);for(const r of i)await t.promises.chmod(s.join(o,r),"755")}},D=async(o,e,i,r)=>{const c=d.platform();if(o==="redis")if(c==="win32")await m("powershell",["Expand-Archive","-Path",e,"-DestinationPath",r]);else{await m("tar",["-xzf",e,"-C",i,"--strip-components=1"]),await t.promises.unlink(e);const n=s.join(i,"src");await m("make",["-C",n]);const l=s.join(n,"redis-server"),a=s.join(n,"redis-cli");await t.promises.copyFile(l,s.join(r,"redis-server")),await t.promises.copyFile(a,s.join(r,"redis-cli"))}else{if(c==="win32"){const n=s.join(i,"temp");await m("powershell",["Expand-Archive","-Path",e,"-DestinationPath",n]);const l=(await t.promises.readdir(n))[0],a=s.join(n,l,"bin");await t.promises.access(r).then(()=>!0).catch(()=>!1)&&await t.promises.rm(r,{recursive:!0,force:!0});const f=s.join(r,"bin");await t.promises.mkdir(f,{recursive:!0});const _=await t.promises.readdir(a);for(const p of _)await t.promises.copyFile(s.join(a,p),s.join(f,p));if(o==="mongodb"){const p=(await j("mongodb",null)).mongosh,u=s.join(i,"mongosh.zip");await x(p,u);const w=s.join(i,"mongosh_temp");await m("powershell",["Expand-Archive","-Path",u,"-DestinationPath",w]);const z=(await t.promises.readdir(w))[0],v=s.join(w,z,"bin","mongosh.exe");await t.promises.copyFile(v,s.join(f,"mongosh.exe")),await t.promises.unlink(u),await t.promises.rm(w,{recursive:!0,force:!0})}const y=["mongod.exe","mongo.exe","mongosh.exe"];for(const p of y)if(!await t.promises.access(s.join(f,p)).then(()=>!0).catch(()=>!1))throw new Error(`Required file ${p} not found in the extracted MongoDB files.`);await t.promises.rm(n,{recursive:!0,force:!0})}else await m("tar",["-xzf",e,"-C",r,"--strip-components=1"]);await t.promises.unlink(e)}},x=async(o,e)=>{const i=await fetch(o);if(!i.ok)throw new Error(`Failed to download: ${i.statusText}`);await F(i.body,t.createWriteStream(e))},b=async o=>{try{return await t.promises.access(o),!0}catch{return!1}},A=async()=>{if(d.platform()==="darwin"){const{stdout:o}=await m("sysctl",["-n","machdep.cpu.brand_string"]);return o.trim()}return d.arch()},j=async(o,e)=>{if(e){const n=await t.promises.readFile(e,"utf-8");return JSON.parse(n)[o].url}const i=d.platform(),r=await A();return{mongodb:{win32:{main:"https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-6.0.5.zip",mongosh:"https://downloads.mongodb.com/compass/mongosh-1.8.0-win32-x64.zip"},darwin:r.includes("ARM")?"https://fastdl.mongodb.org/osx/mongodb-macos-arm64-6.0.5.tgz":"https://fastdl.mongodb.org/osx/mongodb-macos-x86_64-6.0.5.tgz",linux:"https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu2004-6.0.5.tgz"},redis:{win32:"https://github.com/tporadowski/redis/releases/download/v5.0.14.1/Redis-x64-5.0.14.1.zip",darwin:"https://download.redis.io/releases/redis-6.2.6.tar.gz",linux:"https://download.redis.io/releases/redis-6.2.6.tar.gz"},postgresql:{win32:"https://get.enterprisedb.com/postgresql/postgresql-14.7-1-windows-x64-binaries.zip",darwin:"https://get.enterprisedb.com/postgresql/postgresql-14.7-1-osx-binaries.zip",linux:"https://ftp.postgresql.org/pub/source/v14.7/postgresql-14.7.tar.gz"}}[o][i]},E=async(o,e)=>{await t.promises.mkdir(o,{recursive:!0}),await t.promises.mkdir(e,{recursive:!0})},R=async(o,e=null)=>{const i=s.join(d.homedir(),".joystick","databases",o),r=s.join(i,"bin");if(await b(i))return;await E(i,r);const c=await j(o,e),n=typeof c=="object"?c.main:c,l=s.basename(new URL(n).pathname),a=s.join(i,l);await b(a)||(process.loader.print(`${g[o]} not found. Downloading...`),await x(n,a),process.loader.print(`Installing ${g[o]}...`),await D(o,a,i,r),await P(r),process.loader.print(`${g[o]} installed!`))};var N=R;export{N as default};
