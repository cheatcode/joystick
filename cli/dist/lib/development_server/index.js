import u from"chalk";import S from"child_process";import P from"fs";import"os";import T,{dirname as V}from"path";import{fileURLToPath as L}from"url";import G from"util";import w from"./check_if_port_occupied.js";import p from"../cli_log.js";import m from"./get_database_process_ids.js";import M from"../get_platform_safe_path.js";import E from"../kill_port_process.js";import h from"../load_settings.js";import J from"../loader.js";import y from"../path_exists.js";import b from"../required_files.js";import k from"./start_app_server.js";import D from"./start_databases.js";import q from"./start_hmr_server.js";import U from"./watch_for_changes/index.js";import F from"../constants.js";import R from"./kill_process_ids.js";import B,{run_tests_integrated as N}from"./run_tests.js";import K from"../debounce.js";import Y from"./databases/download_database_binary.js";const{stat:z}=P.promises,X=G.promisify(S.exec),l=parseInt(process?.version?.split(".")[0]?.replace("v",""),10),Q=L(import.meta.url),d=V(Q),f=[];let I=!0;const W=async(s=!1)=>{const r=m();await B({watch:s,__dirname:d,process_ids:[...f,...r],cleanup_process:process.cleanup_process})},Z=(s=[],r=0,a="")=>{const t=["--no-warnings"];r<19&&t.push("--experimental-specifier-resolution=node");const e=S.fork(T.resolve(`${a}/cleanup.js`),[],{detached:!0,silent:!0});process.cleanup_process=e,process.on("SIGINT",async()=>{const o=m();e.send(JSON.stringify({process_ids:[...s,...o]})),process.exit()}),process.on("SIGTERM",async()=>{const o=m();e.send(JSON.stringify({process_ids:[...s,...o]})),process.exit()})},ss=async(s=[])=>{const r=s?.find(c=>c?.path?.match(F.SETTINGS_FILE_NAME_REGEX)?.length>0),a=s?.find(c=>c?.path?.includes("i18n")),t=s?.find(c=>c?.path?.includes("index.html")),e=s?.find(c=>c?.path?.includes("index.css")||c?.path?.includes("css/")),o=s?.find(c=>c?.path?.includes("index.client.js"));process.hmr_server_process.send(JSON.stringify({type:"FILE_CHANGE",settings:r?(await h(process.env.NODE_ENV)).settings:null,i18n_change:!!a,index_html_change:!!t,index_css_change:!!e,index_client_change:!!o}))},es=(s=0,r=!1,a={},t=[],e=!1)=>{process.hmr_server_process.on("message",async o=>{["HAS_HMR_CONNECTIONS","HAS_NO_HMR_CONNECTIONS","HMR_UPDATE_COMPLETE"].includes(o?.type)||process.loader.print(o),o?.type==="HAS_HMR_CONNECTIONS"&&(process.hmr_server_process.has_connections=!0),o?.type==="HAS_NO_HMR_CONNECTIONS"&&(process.hmr_server_process.has_connections=!1),o?.type==="HMR_UPDATE_COMPLETE"&&process.app_server_process&&!process.app_server_restarting&&(process.app_server_restarting=!0,$(s,r,a,t,e))})},ts=()=>{process.hmr_server_process.on("error",s=>{p(s.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})}),process.hmr_server_process.stdout.on("data",s=>{console.log(s.toString())}),process.hmr_server_process.stderr.on("data",s=>{p(s.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})})},rs=(s=0,r="",a=!1,t={},e=[],o=!1)=>{process.hmr_server_process=q(s,r),f.push(process.hmr_server_process?.pid),ts(),es(s,a,t,e,o)},as=async(s={})=>{const{settings:r}=await h(process.env.NODE_ENV),a=r?.config?.databases?JSON.stringify(r?.config?.databases):"",t=s?.config?.databases?JSON.stringify(s?.config?.databases):"";return a!==t},$=async(s=0,r=!1,a=null,t=[],e=!1)=>{K(async()=>{if(await as(a)){const c=m();p(`Database configuration has changed in settings.${process.env.NODE_ENV}.json. Please restart your app to add, change, or remove databases.`,{level:"danger",docs:"https://cheatcode.co/docs/joystick/structure"}),R([process.hmr_server_process?.pid,process.app_server_process?.pid,...c]),process.exit(0)}else R([...process.app_server_process.external_process_ids||[]]),await E(process.env.PORT),O(s,r,t,e)},300)},os=(s=!1,r=!1,a=!1)=>{process.app_server_process.external_process_ids=[],process.app_server_process.on("message",t=>{t?.external_process_id&&(process.app_server_process.external_process_ids=[...process.app_server_process.external_process_ids||[],t?.external_process_id])}),process.app_server_process.on("error",t=>{a||p(t.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})}),process.app_server_process.stdout.on("data",async t=>{const e=t.toString(),o=e.includes("App running at:");if(a){process.loader.print(e);return}if(e&&o&&process.env.NODE_ENV!=="test"&&process.loader.print(e),e&&!o&&!e.includes("BUILD_ERROR")&&console.log(e),e&&o&&process.env.NODE_ENV==="test"&&W(s),e&&o&&r&&process.env.NODE_ENV!=="test"){if(I){I=!1;return}setTimeout(async()=>{try{await N({__dirname:d})}catch(c){console.error("Error running integrated tests:",c)}},1e3)}}),process.app_server_process.stderr.on("data",t=>{p(t.toString(),{level:"danger",docs:"https://cheatcode.co/docs/joystick"})})},O=(s=0,r=!1,a=[],t=!1,e=!1,o={})=>{process.app_server_process=k(s,r,a,o),f.push(process.app_server_process?.pid),os(r,t,e),process.app_server_restarting=!1},j=async(s={},r=null)=>{const a=s?.config?.databases?.map((t={})=>t?.provider);for(let t=0;t<a?.length;t+=1){const e=a[t];await Y(e)}if(r){const t=a?.length>0?3e3:0;setTimeout(r,t)}},cs=(s={},r=2600)=>{process.title=s?.environment==="test"?"joystick_test":"joystick",process.project_folder=T.basename(process.cwd()),process.loader=new J,s?.environment==="test"&&(console.log(""),process.loader.print(`Initializing test environment...
`)),process.env.LOGS_PATH=s?.logs||null,process.env.NODE_ENV=s?.environment||"development",process.env.PORT=r,process.env.IS_DEBUG_MODE=s?.debug},ns=(s=2600)=>{p(`Port ${s} is already occupied. To start Joystick on this port, clear it and try again.`,{level:"danger"}),process.exit(0)},is=(s=2600)=>parseInt(s||2600,10),ps=async()=>{const s=M(`${process.cwd()}/.joystick/build`);await y(s)&&await X(`${process.platform==="win32"?"rmdir /s /q":"rm -rf"} ${s}`)},_s=async()=>{const s=[];for(let r=0;r<b?.length;r+=1){const a=b[r],t=await y(`${process.cwd()}/${a.path}`),e=t&&await z(`${process.cwd()}/${a.path}`);a&&a.type==="file"&&(!t||t&&!e.isFile())&&s.push({type:"file",path:a.path}),a&&a.type==="directory"&&(!t||t&&!e.isDirectory())&&s.push({type:"directory",path:a.path})}if(s?.length>0){const r=s?.filter(e=>e.type==="file"),a=s?.filter(e=>e.type==="directory");let t=`The following paths are missing and required in a Joystick project:

`;if(r?.length>0){t+=`  ${u.yellow(">")} Required Files:

`;for(let e=0;e<r?.length;e+=1){const o=r[e],c=e+1===r?.length;t+=`  ${u.red(`/${o.path}
${c&&a?.length>0?`
`:""}`)}`}}if(a?.length>0){t+=`  ${u.yellow(">")} Required Directories:

`;for(let e=0;e<a?.length;e+=1){const o=a[e];t+=`  ${u.red(`/${o.path}
`)}`}}p(t,{level:"danger",docs:"https://cheatcode.co/docs/joystick/structure"}),process.exit(0)}},ls=async()=>{const s=await y(`${process.cwd()}/.joystick`),r=await y(`${process.cwd()}/tests`);process.env.NODE_ENV==="test"&&(!s||!r)&&(p("joystick test must be run in a directory with a .joystick folder and tests folder.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli/test"}),process.exit(0)),process.env.NODE_ENV!=="test"&&!s&&(p("joystick start must be run in a directory with a .joystick folder.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli/start"}),process.exit(0))},ds=async(s={})=>{await ls(),await _s(),await ps();const r=is(s?.port),a=await w(r),t=await w(r+1);a&&ns(r),t&&E(r),cs(s,r);let e,o;if(s?.tests&&s?.environment!=="test"){const n=await h(process.env.NODE_ENV,{skip_global_env:!0});e=n.settings,o=n.raw_settings}else{const n=await h(process.env.NODE_ENV);e=n.settings,o=n.raw_settings}await j(e),await D({environment:process.env.NODE_ENV,port:r,settings:e});const c=s?.tests&&s?.environment!=="test"?{JOYSTICK_SETTINGS:o}:{};s?.tests&&s?.environment!=="test"&&(await w(1977)&&await E(1977),setTimeout(async()=>{try{const g=await h("test",{skip_global_env:!0}),v=g.settings,H=g.raw_settings;await j(v,async()=>{try{await D({environment:"test",port:1977,settings:v}),setTimeout(()=>{const i=k(l,!1,s?.imports||[],{NODE_ENV:"test",PORT:1977,LOGS_PATH:process.env.LOGS_PATH,ROOT_URL:process.env.ROOT_URL,JOYSTICK_SETTINGS:H});f.push(i?.pid),process.test_app_server_process=i,i.external_process_ids=[],i.on("message",_=>{_?.external_process_id&&(i.external_process_ids=[...i.external_process_ids||[],_?.external_process_id],f.push(_?.external_process_id))}),i.on("error",_=>{}),i.stdout.on("data",async _=>{const x=_.toString(),A=x.includes("App running at:");if(x&&A)try{await N({__dirname:d})}catch(C){console.error("Error running integrated tests:",C)}}),i.stderr.on("data",_=>{})},3e3)}catch(i){console.error("Error starting test server after database installation:",i)}})}catch(g){console.error("Error starting test server:",g)}},100)),s?._is_test_server?O(l,!1,s?.imports||[],!1,!0):U({hot_module_reload:(n=[])=>ss(n),restart_app_server:()=>$(l,s?.watch,e,s?.imports,s?.tests),start_app_server:()=>O(l,s?.watch,s?.imports,s?.tests,s?._is_test_server,c),start_hmr_server:s?.environment!=="test"?()=>rs(l,d,s?.watch,e,s?.imports,s?.tests):null,run_tests:s?.tests?async()=>{setTimeout(async()=>{try{await N({__dirname:d})}catch(n){console.error("Error running tests after file change:",n)}},2e3)}:null},{excluded_paths:e?.config?.build?.excluded_paths,custom_copy_paths:e?.config?.build?.copy_paths?.map(n=>({path:n}))||[]}),Z(f,l,d)};var Ls=ds;export{Ls as default};
//# sourceMappingURL=index.js.map
