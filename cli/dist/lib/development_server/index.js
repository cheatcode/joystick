import f from"chalk";import E from"child_process";import v from"fs";import"os";import T,{dirname as P}from"path";import{fileURLToPath as L}from"url";import I from"util";import O from"./check_if_port_occupied.js";import i from"../cli_log.js";import h from"./get_database_process_ids.js";import H from"../get_platform_safe_path.js";import y from"../kill_port_process.js";import g from"../load_settings.js";import $ from"../loader.js";import u from"../path_exists.js";import w from"../required_files.js";import m from"./start_app_server.js";import S from"./start_databases.js";import j from"./start_hmr_server.js";import G from"./watch_for_changes/index.js";import V from"../constants.js";import R from"./kill_process_ids.js";import A,{run_tests_integrated as x}from"./run_tests.js";import J from"../debounce.js";import C from"./databases/download_database_binary.js";const{stat:U}=v.promises,M=I.promisify(E.exec),d=parseInt(process?.version?.split(".")[0]?.replace("v",""),10),q=L(import.meta.url),l=P(q),p=[],F=async(s=!1)=>{const t=h();await A({watch:s,__dirname:l,process_ids:[...p,...t],cleanup_process:process.cleanup_process})},K=(s=[],t=0,r="")=>{const o=["--no-warnings"];t<19&&o.push("--experimental-specifier-resolution=node");const e=E.fork(T.resolve(`${r}/cleanup.js`),[],{detached:!0,silent:!0});process.cleanup_process=e,process.on("SIGINT",async()=>{const c=h();e.send(JSON.stringify({process_ids:[...s,...c]})),process.exit()}),process.on("SIGTERM",async()=>{const c=h();e.send(JSON.stringify({process_ids:[...s,...c]})),process.exit()})},Y=async(s=[])=>{const t=s?.find(a=>a?.path?.match(V.SETTINGS_FILE_NAME_REGEX)?.length>0),r=s?.find(a=>a?.path?.includes("i18n")),o=s?.find(a=>a?.path?.includes("index.html")),e=s?.find(a=>a?.path?.includes("index.css")||a?.path?.includes("css/")),c=s?.find(a=>a?.path?.includes("index.client.js"));process.hmr_server_process.send(JSON.stringify({type:"FILE_CHANGE",settings:t?await g(process.env.NODE_ENV):null,i18n_change:!!r,index_html_change:!!o,index_css_change:!!e,index_client_change:!!c}))},B=(s=0,t=!1,r={},o=[],e=!1)=>{process.hmr_server_process.on("message",async c=>{["HAS_HMR_CONNECTIONS","HAS_NO_HMR_CONNECTIONS","HMR_UPDATE_COMPLETE"].includes(c?.type)||process.loader.print(c),c?.type==="HAS_HMR_CONNECTIONS"&&(process.hmr_server_process.has_connections=!0),c?.type==="HAS_NO_HMR_CONNECTIONS"&&(process.hmr_server_process.has_connections=!1),c?.type==="HMR_UPDATE_COMPLETE"&&process.app_server_process&&!process.app_server_restarting&&(process.app_server_restarting=!0,b(s,t,r,o,e))})},z=()=>{process.hmr_server_process.on("error",s=>{i(s.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})}),process.hmr_server_process.stdout.on("data",s=>{console.log(s.toString())}),process.hmr_server_process.stderr.on("data",s=>{i(s.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})})},X=(s=0,t="",r=!1,o={},e=[],c=!1)=>{process.hmr_server_process=j(s,t),p.push(process.hmr_server_process?.pid),z(),B(s,r,o,e,c)},Q=async(s={})=>{const t=await g(process.env.NODE_ENV),r=t?.config?.databases?JSON.stringify(t?.config?.databases):"",o=s?.config?.databases?JSON.stringify(s?.config?.databases):"";return r!==o},b=async(s=0,t=!1,r=null,o=[],e=!1)=>{J(async()=>{if(await Q(r)){const a=h();i(`Database configuration has changed in settings.${process.env.NODE_ENV}.json. Please restart your app to add, change, or remove databases.`,{level:"danger",docs:"https://cheatcode.co/docs/joystick/structure"}),R([process.hmr_server_process?.pid,process.app_server_process?.pid,...a]),process.exit(0)}else{R([...process.app_server_process.external_process_ids||[]]),await y(process.env.PORT);const a=await g(process.env.NODE_ENV);process.app_server_process=m(s,t,o,{NODE_ENV:process.env.NODE_ENV,PORT:process.env.PORT,LOGS_PATH:process.env.LOGS_PATH,ROOT_URL:process.env.ROOT_URL,JOYSTICK_SETTINGS:JSON.stringify(a)}),p.push(process.app_server_process?.pid),k(t,e,!1),process.app_server_restarting=!1}},300)},k=(s=!1,t=!1,r=!1)=>{process.app_server_process.external_process_ids=[],process.app_server_process.on("message",o=>{o?.external_process_id&&(process.app_server_process.external_process_ids=[...process.app_server_process.external_process_ids||[],o?.external_process_id])}),process.app_server_process.on("error",o=>{r||i(o.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})}),process.app_server_process.stdout.on("data",async o=>{const e=o.toString(),c=e.includes("App running at:");if(r){process.loader.print(e);return}e&&c&&process.env.NODE_ENV!=="test"&&process.loader.print(e),e&&!c&&!e.includes("BUILD_ERROR")&&console.log(e),e&&c&&process.env.NODE_ENV==="test"&&F(s),e&&c&&t&&process.env.NODE_ENV!=="test"&&setTimeout(async()=>{try{await x({__dirname:l})}catch(a){console.error("Error running integrated tests:",a)}},2e3)}),process.app_server_process.stderr.on("data",o=>{i(o.toString(),{level:"danger",docs:"https://cheatcode.co/docs/joystick"})})},W=(s=0,t=!1,r=[],o=!1,e=!1,c={})=>{process.app_server_process=m(s,t,r,{NODE_ENV:process.env.NODE_ENV,PORT:process.env.PORT,LOGS_PATH:process.env.LOGS_PATH,ROOT_URL:process.env.ROOT_URL,JOYSTICK_SETTINGS:JSON.stringify(c)}),p.push(process.app_server_process?.pid),k(t,o,e),process.app_server_restarting=!1},Z=async(s={})=>{const t=s?.config?.databases?.map((r={})=>r?.provider);for(let r=0;r<t?.length;r+=1){const o=t[r];await C(o)}},ss=(s={},t=2600)=>{process.title=s?.environment==="test"?"joystick_test":"joystick",process.project_folder=T.basename(process.cwd()),process.loader=new $,s?.environment==="test"&&(console.log(""),process.loader.print(`Initializing test environment...
`)),process.env.LOGS_PATH=s?.logs||null,process.env.NODE_ENV=s?.environment||"development",process.env.PORT=t,process.env.IS_DEBUG_MODE=s?.debug},es=(s=2600)=>{i(`Port ${s} is already occupied. To start Joystick on this port, clear it and try again.`,{level:"danger"}),process.exit(0)},ts=(s=2600)=>parseInt(s||2600,10),rs=async()=>{const s=H(`${process.cwd()}/.joystick/build`);await u(s)&&await M(`${process.platform==="win32"?"rmdir /s /q":"rm -rf"} ${s}`)},os=async()=>{const s=[];for(let t=0;t<w?.length;t+=1){const r=w[t],o=await u(`${process.cwd()}/${r.path}`),e=o&&await U(`${process.cwd()}/${r.path}`);r&&r.type==="file"&&(!o||o&&!e.isFile())&&s.push({type:"file",path:r.path}),r&&r.type==="directory"&&(!o||o&&!e.isDirectory())&&s.push({type:"directory",path:r.path})}if(s?.length>0){const t=s?.filter(e=>e.type==="file"),r=s?.filter(e=>e.type==="directory");let o=`The following paths are missing and required in a Joystick project:

`;if(t?.length>0){o+=`  ${f.yellow(">")} Required Files:

`;for(let e=0;e<t?.length;e+=1){const c=t[e],a=e+1===t?.length;o+=`  ${f.red(`/${c.path}
${a&&r?.length>0?`
`:""}`)}`}}if(r?.length>0){o+=`  ${f.yellow(">")} Required Directories:

`;for(let e=0;e<r?.length;e+=1){const c=r[e];o+=`  ${f.red(`/${c.path}
`)}`}}i(o,{level:"danger",docs:"https://cheatcode.co/docs/joystick/structure"}),process.exit(0)}},cs=async()=>{const s=await u(`${process.cwd()}/.joystick`),t=await u(`${process.cwd()}/tests`);process.env.NODE_ENV==="test"&&(!s||!t)&&(i("joystick test must be run in a directory with a .joystick folder and tests folder.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli/test"}),process.exit(0)),process.env.NODE_ENV!=="test"&&!s&&(i("joystick start must be run in a directory with a .joystick folder.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli/start"}),process.exit(0))},as=async(s={})=>{await cs(),await os(),await rs();const t=ts(s?.port),r=await O(t),o=await O(t+1);r&&es(t),o&&y(t),ss(s,t);const e=await g(process.env.NODE_ENV);await Z(e),await S({environment:process.env.NODE_ENV,port:t,settings:e}),W(d,s?.watch,s?.imports||[],s?.tests,!1,e),s?.tests&&s?.environment!=="test"&&(await O(1977)&&await y(1977),setTimeout(async()=>{try{const a=`${process.cwd()}/settings.test.json`,D=await v.promises.readFile(a,"utf-8"),N=JSON.parse(D);await S({environment:"test",port:1977,settings:N});const n=m(d,!1,s?.imports||[],{NODE_ENV:"test",PORT:1977,LOGS_PATH:process.env.LOGS_PATH,ROOT_URL:process.env.ROOT_URL,JOYSTICK_SETTINGS:JSON.stringify(N)});p.push(n?.pid),process.test_app_server_process=n,n.external_process_ids=[],n.on("message",_=>{_?.external_process_id&&(n.external_process_ids=[...n.external_process_ids||[],_?.external_process_id],p.push(_?.external_process_id))}),n.on("error",_=>{}),n.stdout.on("data",async _=>{}),n.stderr.on("data",_=>{})}catch(a){console.error("Error starting test server:",a)}},100)),s?._is_test_server||G({hot_module_reload:(c=[])=>Y(c),restart_app_server:()=>b(d,s?.watch,e,s?.imports,s?.tests),start_app_server:()=>m(d,s?.watch,s?.imports||[],{NODE_ENV:process.env.NODE_ENV,PORT:process.env.PORT,LOGS_PATH:process.env.LOGS_PATH,ROOT_URL:process.env.ROOT_URL,JOYSTICK_SETTINGS:JSON.stringify(e)}),start_hmr_server:s?.environment!=="test"?()=>X(d,l,s?.watch,e,s?.imports,s?.tests):null,run_tests:s?.tests?async()=>{setTimeout(async()=>{try{await x({__dirname:l})}catch(c){console.error("Error running tests after file change:",c)}},2e3)}:null},{excluded_paths:e?.config?.build?.excluded_paths,custom_copy_paths:e?.config?.build?.copy_paths?.map(c=>({path:c}))||[]}),K(p,d,l)};var Is=as;export{Is as default};
//# sourceMappingURL=index.js.map
