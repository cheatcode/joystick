import p from"chalk";import u from"child_process";import b from"fs";import"os";import y,{dirname as k}from"path";import{fileURLToPath as S}from"url";import T from"util";import f from"./check_if_port_occupied.js";import n from"../cli_log.js";import _ from"./get_database_process_ids.js";import D from"../get_platform_safe_path.js";import m from"../kill_port_process.js";import g from"../load_settings.js";import $ from"../loader.js";import d from"../path_exists.js";import v from"../required_files.js";import j from"./start_app_server.js";import R from"./start_databases.js";import I from"./start_hmr_server.js";import H from"./watch_for_changes/index.js";import C from"../constants.js";import w from"./kill_process_ids.js";import M,{run_tests_integrated as E}from"./run_tests.js";import V from"../debounce.js";import A from"./databases/download_database_binary.js";const{stat:P}=b.promises,q=T.promisify(u.exec),l=parseInt(process?.version?.split(".")[0]?.replace("v",""),10),L=S(import.meta.url),i=k(L),h=[],G=async(s=!1)=>{const t=_();await M({watch:s,__dirname:i,process_ids:[...h,...t],cleanup_process:process.cleanup_process})},J=(s=[],t=0,e="")=>{const o=["--no-warnings"];t<19&&o.push("--experimental-specifier-resolution=node");const r=u.fork(y.resolve(`${e}/cleanup.js`),[],{detached:!0,silent:!0});process.cleanup_process=r,process.on("SIGINT",async()=>{const c=_();r.send(JSON.stringify({process_ids:[...s,...c]})),process.exit()}),process.on("SIGTERM",async()=>{const c=_();r.send(JSON.stringify({process_ids:[...s,...c]})),process.exit()})},U=async(s=[])=>{const t=s?.find(a=>a?.path?.match(C.SETTINGS_FILE_NAME_REGEX)?.length>0),e=s?.find(a=>a?.path?.includes("i18n")),o=s?.find(a=>a?.path?.includes("index.html")),r=s?.find(a=>a?.path?.includes("index.css")||a?.path?.includes("css/")),c=s?.find(a=>a?.path?.includes("index.client.js"));process.hmr_server_process.send(JSON.stringify({type:"FILE_CHANGE",settings:t?await g(process.env.NODE_ENV):null,i18n_change:!!e,index_html_change:!!o,index_css_change:!!r,index_client_change:!!c}))},F=(s=0,t=!1,e={},o=[],r=!1)=>{process.hmr_server_process.on("message",async c=>{["HAS_HMR_CONNECTIONS","HAS_NO_HMR_CONNECTIONS","HMR_UPDATE_COMPLETE"].includes(c?.type)||process.loader.print(c),c?.type==="HAS_HMR_CONNECTIONS"&&(process.hmr_server_process.has_connections=!0),c?.type==="HAS_NO_HMR_CONNECTIONS"&&(process.hmr_server_process.has_connections=!1),c?.type==="HMR_UPDATE_COMPLETE"&&process.app_server_process&&!process.app_server_restarting&&(process.app_server_restarting=!0,N(s,t,e,o,r))})},B=()=>{process.hmr_server_process.on("error",s=>{n(s.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})}),process.hmr_server_process.stdout.on("data",s=>{console.log(s.toString())}),process.hmr_server_process.stderr.on("data",s=>{n(s.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})})},z=(s=0,t="",e=!1,o={},r=[],c=!1)=>{process.hmr_server_process=I(s,t),h.push(process.hmr_server_process?.pid),B(),F(s,e,o,r,c)},X=async(s={})=>{const t=await g(process.env.NODE_ENV),e=t?.config?.databases?JSON.stringify(t?.config?.databases):"",o=s?.config?.databases?JSON.stringify(s?.config?.databases):"";return e!==o},N=async(s=0,t=!1,e=null,o=[],r=!1)=>{V(async()=>{if(await X(e)){const a=_();n(`Database configuration has changed in settings.${process.env.NODE_ENV}.json. Please restart your app to add, change, or remove databases.`,{level:"danger",docs:"https://cheatcode.co/docs/joystick/structure"}),w([process.hmr_server_process?.pid,process.app_server_process?.pid,...a]),process.exit(0)}else w([...process.app_server_process.external_process_ids||[]]),await m(process.env.PORT),O(s,t,o,r)},300)},K=(s=!1,t=!1)=>{process.app_server_process.external_process_ids=[],process.app_server_process.on("message",e=>{e?.external_process_id&&(process.app_server_process.external_process_ids=[...process.app_server_process.external_process_ids||[],e?.external_process_id])}),process.app_server_process.on("error",e=>{n(e.toString(),{level:"danger",docs:"https://github.com/cheatcode/joystick"})}),process.app_server_process.stdout.on("data",async e=>{const o=e.toString(),r=o.includes("App running at:");o&&r&&process.env.NODE_ENV!=="test"&&process.loader.print(o),o&&!r&&!o.includes("BUILD_ERROR")&&console.log(o),o&&r&&process.env.NODE_ENV==="test"&&G(s),o&&r&&t&&process.env.NODE_ENV!=="test"&&setTimeout(async()=>{try{await E({__dirname:i})}catch(c){console.error("Error running integrated tests:",c)}},2e3)}),process.app_server_process.stderr.on("data",e=>{n(e.toString(),{level:"danger",docs:"https://cheatcode.co/docs/joystick"})})},O=(s=0,t=!1,e=[],o=!1)=>{process.app_server_process=j(s,t,e),h.push(process.app_server_process?.pid),K(t,o),process.app_server_restarting=!1},Q=async(s={})=>{const t=s?.config?.databases?.map((e={})=>e?.provider);for(let e=0;e<t?.length;e+=1){const o=t[e];await A(o)}},W=(s={},t=2600)=>{process.title=s?.environment==="test"?"joystick_test":"joystick",process.project_folder=y.basename(process.cwd()),process.loader=new $,s?.environment==="test"&&(console.log(""),process.loader.print(`Initializing test environment...
`)),process.env.LOGS_PATH=s?.logs||null,process.env.NODE_ENV=s?.environment||"development",process.env.PORT=t,process.env.IS_DEBUG_MODE=s?.debug},Y=(s=2600)=>{n(`Port ${s} is already occupied. To start Joystick on this port, clear it and try again.`,{level:"danger"}),process.exit(0)},Z=(s=2600)=>parseInt(s||2600,10),ss=async()=>{const s=D(`${process.cwd()}/.joystick/build`);await d(s)&&await q(`${process.platform==="win32"?"rmdir /s /q":"rm -rf"} ${s}`)},es=async()=>{const s=[];for(let t=0;t<v?.length;t+=1){const e=v[t],o=await d(`${process.cwd()}/${e.path}`),r=o&&await P(`${process.cwd()}/${e.path}`);e&&e.type==="file"&&(!o||o&&!r.isFile())&&s.push({type:"file",path:e.path}),e&&e.type==="directory"&&(!o||o&&!r.isDirectory())&&s.push({type:"directory",path:e.path})}if(s?.length>0){const t=s?.filter(r=>r.type==="file"),e=s?.filter(r=>r.type==="directory");let o=`The following paths are missing and required in a Joystick project:

`;if(t?.length>0){o+=`  ${p.yellow(">")} Required Files:

`;for(let r=0;r<t?.length;r+=1){const c=t[r],a=r+1===t?.length;o+=`  ${p.red(`/${c.path}
${a&&e?.length>0?`
`:""}`)}`}}if(e?.length>0){o+=`  ${p.yellow(">")} Required Directories:

`;for(let r=0;r<e?.length;r+=1){const c=e[r];o+=`  ${p.red(`/${c.path}
`)}`}}n(o,{level:"danger",docs:"https://cheatcode.co/docs/joystick/structure"}),process.exit(0)}},ts=async()=>{const s=await d(`${process.cwd()}/.joystick`),t=await d(`${process.cwd()}/tests`);process.env.NODE_ENV==="test"&&(!s||!t)&&(n("joystick test must be run in a directory with a .joystick folder and tests folder.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli/test"}),process.exit(0)),process.env.NODE_ENV!=="test"&&!s&&(n("joystick start must be run in a directory with a .joystick folder.",{level:"danger",docs:"https://cheatcode.co/docs/joystick/cli/start"}),process.exit(0))},x=async(s={})=>{await ts(),await es(),await ss();const t=Z(s?.port),e=await f(t),o=await f(t+1);e&&Y(t),o&&m(t),W(s,t);const r=await g(process.env.NODE_ENV);await Q(r),await R({environment:process.env.NODE_ENV,port:t,settings:r}),s?.tests&&(await f(1977)&&await m(1977),x({environment:"test",port:1977,watch:!1}).catch(a=>{console.error("Error starting test server:",a)})),H({hot_module_reload:(c=[])=>U(c),restart_app_server:()=>N(l,s?.watch,r,s?.imports,s?.tests),start_app_server:()=>O(l,s?.watch,s?.imports,s?.tests),start_hmr_server:s?.environment!=="test"?()=>z(l,i,s?.watch,r,s?.imports,s?.tests):null,run_tests:s?.tests?async()=>{setTimeout(async()=>{try{await E({__dirname:i})}catch(c){console.error("Error running tests after file change:",c)}},1e3)}:null},{excluded_paths:r?.config?.build?.excluded_paths,custom_copy_paths:r?.config?.build?.copy_paths?.map(c=>({path:c}))||[]}),J(h,l,i)};var Ds=x;export{Ds as default};
//# sourceMappingURL=index.js.map
