import h from"chokidar";import m from"fs";import{dirname as y}from"path";import g from"../../build/build_files.js";import v from"../../debounce.js";import _ from"./get_after_run_tasks.js";import k from"./get_file_codependencies.js";import l from"../../build/get_file_operation.js";import w from"../../build/get_path_platform.js";import R from"../../types.js";import b from"./watch_paths.js";import D from"../../unique_array.js";const{mkdir:u,copyFile:O,rm:d}=m.promises,n=async(e={},a={})=>{const s=process.initial_build_complete?await k(e?.path):[];if(a?.is_build_file&&await g({files:[{path:e?.path,platform:w(e?.path)}]}).catch((r=[])=>{if(!process.initial_build_complete&&r?.length>0&&process.exit(0),process.initial_build_complete&&r?.length>0)throw process.app_server_process.send(JSON.stringify({type:"BUILD_ERROR",paths:r.filter(({success:t})=>!t)})),process.hmr_server_process.send(JSON.stringify({type:"BUILD_ERROR"})),new Error("BUILD_ERROR")}),s?.length>0)for(let r=0;r<s?.length;r+=1){const t=s[r];await n({path:t},a)}return Promise.resolve()},$=async(e={})=>{switch(e?.operation){case"add_directory":return u(`.joystick/build/${e?.path}`,{recursive:!0});case"build_file":return n(e,{is_build_file:!0});case"copy_file":return await u(y(`.joystick/build/${e?.path}`),{recursive:!0}),await O(e?.path,`.joystick/build/${e?.path}`),n(e,{is_build_file:!1});case"delete_directory":return d(`.joystick/build/${e?.path}`,{recursive:!0});case"delete_file":return await d(`.joystick/build/${e?.path}`,{recursive:!0}),n(e,{is_build_file:!1});default:return!0}},E=(e={})=>({operation:e?.event,path:e?.path,after_run_tasks:process.initial_build_complete?_(e?.path):["start_app_server","start_hmr_server"]}),B=(e={})=>({operation:e?.event,path:e?.path,after_run_tasks:process.initial_build_complete?_(e?.path):["start_app_server","start_hmr_server"]}),I=(e={})=>({operation:e?.event,path:e?.path,after_run_tasks:process.initial_build_complete?_(e?.path):["start_app_server","start_hmr_server"]}),L=(e={})=>({operation:e?.is_custom_copy_path?"copy_file":l(e?.path),path:e?.path,after_run_tasks:process.initial_build_complete?_(e?.path):["start_app_server","start_hmr_server"]}),S=(e={})=>({operation:e?.is_custom_copy_path?"copy_file":l(e?.path),path:e?.path,after_run_tasks:process.initial_build_complete?_(e?.path):["start_app_server","start_hmr_server"]}),U=(e={})=>{switch(e?.event){case"add_file":return S(e);case"change_file":return L(e);case"delete_file":return I(e);case"add_directory":return B(e);case"delete_directory":return E(e)}},x=async(e=[],a={})=>{try{const s=new Set([]);for(let t=0;t<e?.length;t+=1){const i=e[t],c=U(i);await $(c);const o=D(c?.after_run_tasks||[]);if(o?.length>0)for(let p=0;p<o?.length;p+=1){const f=o[p];o.add(f)}}const r=Array.from(s);for(let t=0;t<r?.length;t+=1){const i=r[t];R.is_function(a[i])&&await a[i](e)}}catch{}},J=(e="")=>{switch(e){case"add":return"add_file";case"change":return"change_file";case"unlink":return"delete_file";case"addDir":return"add_directory";case"unlinkDir":return"delete_directory"}},N=(e={},a={})=>{const s=h.watch([...b,...a?.custom_copy_paths||[]].map(({path:t})=>t),{ignored:".joystick"});let r=[];process.initial_build_complete=!1,s.on("error",t=>console.error(t)),s.on("all",(t,i)=>{r.push({event:J(t),path:i,is_custom_copy_path:a?.custom_copy_paths?.length?a?.custom_copy_paths.some(c=>i.includes(c?.path)):!1}),v(async()=>{await x(r,e),process.initial_build_complete=!0,r=[]},100)})};var V=N;export{V as default};
