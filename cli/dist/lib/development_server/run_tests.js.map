{
  "version": 3,
  "sources": ["../../../src/lib/development_server/run_tests.js"],
  "sourcesContent": ["import child_process from \"child_process\";\nimport cli_log from \"../cli_log.js\";\nimport chalk from 'chalk';\n\nconst handle_ava_stderr = (stderr = '') => {\n  // NOTE: Squash output about using a configuration file (we always do in the framework).\n  if (stderr?.includes('Using configuration')) {\n    return null;\n  }\n\n  if (stderr?.includes('No tests found')) {\n    return cli_log('No tests found. Add tests in the /tests folder at the root of your Joystick app.', {\n      level: 'danger',\n      docs: 'https://cheatcode.co/docs/joystick/test/setup',\n    });\n  }\n  \n  console.log(stderr);\n};\n\nconst handle_ava_stdout = (stdout = '') => {\n  // NOTE: Squash output about using a configuration file (we always do in the framework).\n  if (stdout?.includes('Using configuration')) {\n    return null;\n  }\n\n  if (stdout?.includes('No tests found in')) {\n    const [message] = stdout?.split(',');\n    return console.log(`${message}\\n`);\n  }\n  \n  console.log(stdout);\n};\n\nconst handle_ava_stdio = (ava = {}, run_tests_options = {}) => {\n  ava.stdout.on('data', function (data) {\n    const string = data.toString();\n    handle_ava_stdout(string, run_tests_options);\n  });\n\n  ava.stderr.on('data', function (data) {\n    const string = data.toString();\n    handle_ava_stderr(string, run_tests_options);\n  });\n};\n\nconst run_tests_integrated = (run_tests_options = {}) => {\n  const ava_path = `${process.cwd()}/node_modules/.bin/ava`;\n  const tap_reporter_path = `${run_tests_options?.__dirname}/tap_reporter.js`;\n  \n  return new Promise((resolve, reject) => {\n    // NOTE: Run ava directly and spawn tap reporter separately to avoid shell exit propagation\n    const ava = child_process.spawn(ava_path, [\n      '--config', `${run_tests_options?.__dirname}/ava_config.js`,\n      '--tap'\n    ], {\n      env: {\n        ...(process.env),\n        databases: process.databases,\n        FORCE_COLOR: \"1\"\n      }\n    });\n\n    const tap_reporter = child_process.spawn('node', [tap_reporter_path], {\n      env: {\n        ...(process.env),\n        FORCE_COLOR: \"1\"\n      }\n    });\n\n    // NOTE: Pipe ava output to tap reporter\n    ava.stdout.pipe(tap_reporter.stdin);\n    \n    // NOTE: Stream tap reporter output to console\n    tap_reporter.stdout.on('data', (data) => {\n      process.stdout.write(data);\n    });\n\n    tap_reporter.stderr.on('data', (data) => {\n      process.stderr.write(data);\n    });\n\n    // NOTE: Handle ava stderr directly (before piping to tap reporter)\n    ava.stderr.on('data', (data) => {\n      const stderr_string = data.toString();\n      if (!stderr_string.includes('Using configuration')) {\n        process.stderr.write(data);\n      }\n    });\n\n    // NOTE: Handle process exits without propagating to parent\n    ava.on('exit', (code, signal) => {\n      tap_reporter.stdin.end();\n    });\n\n    tap_reporter.on('exit', (code, signal) => {\n      // NOTE: Always resolve, never reject - we want to keep servers running\n      resolve();\n    });\n\n    // NOTE: Handle any errors without crashing parent process\n    ava.on('error', (error) => {\n      console.error('Test runner error:', error.message);\n      resolve();\n    });\n\n    tap_reporter.on('error', (error) => {\n      console.error('TAP reporter error:', error.message);\n      resolve();\n    });\n  });\n};\n\nconst run_tests = (run_tests_options = {}) => {\n  // NOTE: A little bananas to reason through this. In order for Ava to run w/o errors,\n  // the Ava binary being run here has to be identical to the one used in @joystick.js/test.\n  // That would equal the copy of Ava that's installed in a Joystick app's node_modules\n  // directory, not the node_modules directory of the CLI here. We can guarantee that will\n  // exist for the CLI here because a developer has to install @joystick.js/test which will\n  // add Ava as a dependency to their app in order to write tests.\n  const ava_path = `${process.cwd()}/node_modules/.bin/ava`;\n  const tap_reporter_path = `${run_tests_options?.__dirname}/tap_reporter.js`;\n  \n  return new Promise((resolve) => {\n    // NOTE: Despite using the app's node_modules path to reference Ava, we still want to reference\n    // the internal path here for the default test config in /lib/dev/tests.config.js.\n    // Use TAP output and pipe to custom reporter only when not in watch mode\n    const base_command = `DEBUG=ava:watcher && ${ava_path} --config ${run_tests_options?.__dirname}/ava_config.js`;\n    const watch_flag = run_tests_options?.watch ? '--watch' : '';\n    const tap_pipe = run_tests_options?.watch ? '' : `--tap | node ${tap_reporter_path}`;\n    const full_command = `${base_command} ${watch_flag} ${tap_pipe}`;\n    \n    const ava = child_process.exec(full_command, {\n      stdio: 'inherit',\n      env: {\n        ...(process.env),\n        databases: process.databases,\n        FORCE_COLOR: \"1\"\n      }\n    }, (error) => {\n      if (!error) {\n        // NOTE: Do this here because the standard SIGINT and SIGTERM hooks the dev process\n        // listens for don't catch a clean exit (and the process.exit() hook fires after exit).\n        run_tests_options.cleanup_process.send(JSON.stringify(({ process_ids: run_tests_options?.process_ids })));\n        process.exit(0);\n      } else {\n        // NOTE: Do not report any Ava errors here because they're picked up by the handle_ava_stdio();\n        // hook below. Just do a clean exit here so Node doesn't hang.\n        run_tests_options.cleanup_process.send(JSON.stringify(({ process_ids: run_tests_options?.process_ids })));\n        process.exit(0);\n      }\n    });\n\n    handle_ava_stdio(ava, run_tests_options);\n  });\n};\n\nexport { run_tests_integrated };\nexport default run_tests;\n"],
  "mappings": "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",
  "names": ["child_process", "cli_log", "handle_ava_stderr", "stderr", "handle_ava_stdout", "stdout", "message", "handle_ava_stdio", "ava", "run_tests_options", "data", "string", "run_tests_integrated", "ava_path", "tap_reporter_path", "resolve", "reject", "tap_reporter", "code", "signal", "error", "run_tests", "base_command", "watch_flag", "tap_pipe", "full_command", "run_tests_default"]
}
