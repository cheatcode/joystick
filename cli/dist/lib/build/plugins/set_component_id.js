import _ from"fs";import a from"../../generate_id.js";import r from"../../path_exists.js";const{readFile:p,writeFile:m}=_.promises,d=async(t=[],n={},o="")=>{for(let e=0;e<t.length;e+=1){const c=t[e];n[c.path]=c.component_id,await m(o,JSON.stringify(n))}},u=(t=[],n="")=>{let o=n;for(let e=0;e<t.length;e+=1){const c=t[e],i=c.source.replace(/\.component\(\{+(?!\n + _componentId)/g,()=>`.component({
  _componentId: '${c.component_id}',`);o=o.replace(c.source,i)}return o},h=(t="",n=[],o={})=>n?.map((e,c)=>{const i=n[c+1],s=e.path.replace("// ","");return{path:s,component_id:o[s]||a(16),index:e.index,source:t.substring(e.index,i?i.index:t.length)}}),l=(t="")=>[...t?.matchAll(/\/\/ ui+.*/gi),...t?.matchAll(/\/\/ email+.*/gi)].map(n=>({path:n[0],index:n.index})),g=async(t="")=>{if(await r(t)){const o=await p(t,"utf-8");return JSON.parse(o)}return{}},x=()=>["development","test"].includes(process.env.NODE_ENV)?"./.joystick/build/component_id_cache.json":"./.build/component_id_cache.json",f=async(t="")=>{const n=x(),o=await g(n),e=l(t),c=h(t,e,o),i=u(c,t);return await d(c,o,n),i};var j=f;export{j as default};
