{
  "version": 3,
  "sources": ["../../../../src/lib/build/plugins/bootstrap_component.js"],
  "sourcesContent": ["import chalk from 'chalk';\nimport fs from 'fs';\nimport get_platform_safe_path from '../../get_platform_safe_path.js';\nimport constants from '../../constants.js';\nimport set_component_id from './set_component_id.js';\nimport path_exists from '../../path_exists.js';\n\nconst { readFile, writeFile } = fs.promises;\n\nconst restore_examples_without_mounting_code = (code = '', examples_before_replacement = []) => {\n\tfor (let i = 0; i < examples_before_replacement?.length; i += 1) {\n    const example_to_restore = examples_before_replacement[i];\n    code = code.replace(`%example:${i}%`, example_to_restore);\n  }\n};\n\nconst add_page_mounting_code = (code = '', default_export = '', component_name = '') => {\n\treturn code.replace(\n    `${default_export};`,\n    `if (\n      typeof window !== 'undefined' &&\n      window.__joystick_should_auto_mount__ === true &&\n      !window.__joystick_layout_url__ &&\n      window.__joystick_page_url__ &&\n      !window.__joystick_hmr_update__ &&\n      joystick &&\n      joystick.mount\n    ) {\n      joystick.mount(${component_name}, window.__joystick_ssr_props__ || {}, document.getElementById('app'));\n    }\n\n    export default ${component_name};\n    `\n  );\n};\n\nconst add_layout_mounting_code = (code = '', default_export = '', component_name = '') => {\n\treturn code.replace(\n\t  `${default_export};`,\n\t  `if (\n\t    typeof window !== 'undefined' &&\n\t    window.__joystick_should_auto_mount__ === true &&\n\t    window.__joystick_layout_url__ &&\n      window.__joystick_page_url__ &&\n      !window.__joystick_hmr_update__ &&\n\t    joystick &&\n\t    joystick.mount\n\t  ) {\n\t    (async () => {\n\t      const layout_component_file = await import(window.__joystick_layout_url__);\n\t      const page_component_file = await import(window.window.__joystick_page_url__);\n\t      const layout = layout_component_file.default;\n\t      const page = page_component_file.default;\n\t      joystick.mount(layout, Object.assign({ ...window.__joystick_ssr_props__ }, { page }), document.getElementById('app'));\n\t    })();\n\t  }\n\n\texport default ${component_name};\n\t  `\n\t);\n};\n\nconst replace_commented_code = (code = '') => {\n\treturn code.replace(constants.JOYSTICK_COMMENT_REGEX, \"\");\n};\n\nconst set_placeholders_for_examples = (code = '') => {\n\t// NOTE: Replace any <example> bracketed code with a placeholder. This ensures\n\t// that we don't accidentally include any mounting code (or inject a _componentId)\n\t// in Joystick example code included as content on the page.\n\t//\n\t// example_index is tracked to account for potential for multiple examples in a\n\t// single file. example_index acts as a placeholder for the code to swap back\n  // in after the _componentId is set in restore_examples_without_mounting_code().\n  let example_index = 0;\n\n  return code.replace(\n    constants.EXAMPLE_CODE_REGEX,\n    () => {\n      return `%example:${example_index++}%`;\n    }\n  );\n};\n\nconst get_examples_before_replacement = (code = '') => {\n\treturn code.match(constants.EXAMPLE_CODE_REGEX) || [];\n};\n\nconst get_component_name = (default_export = null) => {\n  const default_export_parts = (default_export && default_export.split(\" \")) || [];\n  return default_export_parts?.pop();\n};\n\nconst check_if_valid_component_file = (has_joystick_ui = false, default_export = null) => {\n\treturn has_joystick_ui && !!default_export;\n};\n\nconst get_default_export = (code = '') => {\n\tconst export_default_matches = code.match(constants.EXPORT_DEFAULT_REGEX) || [];\n\treturn export_default_matches && export_default_matches[0];\n};\n\nconst check_if_has_joystick_ui = (code = '') => {\n  const joystick_ui_matches = code.match(constants.JOYSTICK_UI_REGEX) || [];\n\treturn !!joystick_ui_matches && !!joystick_ui_matches[0];\n};\n\nconst check_if_is_component_type = (type ='', build_args = {}) => {\n  return [get_platform_safe_path(type)].some(\n    (bootstrap_target) => {\n      return build_args.path.includes(bootstrap_target);\n    }\n  );\n};\n\nconst check_if_should_set_component_id = (entry_point = '') => {\n\treturn [\n    get_platform_safe_path(\"ui/\"),\n    get_platform_safe_path(\"email/\"),\n  ].some((bootstrap_target) => {\n    return entry_point.includes(bootstrap_target);\n  });\n};\n\nconst bootstrap_component = (build = {}) => {\n  build.onLoad({ filter: /\\.js$/ }, async (build_args = {}) => {\n    const is_layout_component = check_if_is_component_type('ui/layouts', build_args);\n    const is_page_component = check_if_is_component_type('ui/pages', build_args);      \n    const is_email_component = check_if_is_component_type('email/', build_args);\n    const is_component = is_layout_component || is_page_component || is_email_component;\n\n    if (is_component) {\n      let file_contents = await readFile(get_platform_safe_path(build_args.path), \"utf-8\");\n      \n      const has_joystick_ui = check_if_has_joystick_ui(file_contents);\n      const default_export = get_default_export(file_contents);\n      const is_valid_component_file = check_if_valid_component_file(has_joystick_ui, default_export);\n      const examples_before_replacement = get_examples_before_replacement(file_contents);\n      const component_name = get_component_name(default_export);\n\n      file_contents = set_placeholders_for_examples(file_contents);\n      file_contents = replace_commented_code(file_contents);\n      file_contents = component_name && is_layout_component ?\n        add_layout_mounting_code(file_contents, default_export, component_name) :\n        file_contents;\n      file_contents = component_name && is_page_component ?\n        add_page_mounting_code(file_contents, default_export, component_name) :\n        file_contents;\n\n      restore_examples_without_mounting_code(file_contents, examples_before_replacement);\n\n      return {\n        contents: file_contents,\n        loader: \"js\",\n      };\n    }\n  });\n\n  build.onEnd(() => {\n    return new Promise(async (resolve) => {\n      for (let i = 0; i < build?.initialOptions?.entryPoints?.length; i += 1) {\n        const entry_point = build?.initialOptions?.entryPoints[i];\n        const should_set_component_id = check_if_should_set_component_id(entry_point);\n        const build_exists = await path_exists(`${build?.initialOptions?.outdir}/${entry_point}`);\n\n        if (should_set_component_id && build_exists) {\n          let file_contents = await readFile(`${build?.initialOptions?.outdir}/${entry_point}`, \"utf-8\");\n          const has_joystick_ui = check_if_has_joystick_ui(file_contents);\n\t\t\t\t\tconst examples_before_replacement = get_examples_before_replacement(file_contents);\n          \n          file_contents = set_placeholders_for_examples(file_contents);\n\n          if (has_joystick_ui) {\n            file_contents = await set_component_id(file_contents);\n\n            for (let i = 0; i < examples_before_replacement?.length; i += 1) {\n              const example_to_restore = examples_before_replacement[i];\n              file_contents = file_contents.replace(`%example:${i}%`, example_to_restore);\n            }\n            \n            await writeFile(`${build?.initialOptions?.outdir}/${entry_point}`, file_contents);\n          }\n        }\n      }\n\n      resolve();\n    });\n  });\n};\n\nexport default bootstrap_component;\n"],
  "mappings": "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",
  "names": ["fs", "get_platform_safe_path", "constants", "set_component_id", "path_exists", "readFile", "writeFile", "restore_examples_without_mounting_code", "code", "examples_before_replacement", "i", "example_to_restore", "add_page_mounting_code", "default_export", "component_name", "add_layout_mounting_code", "replace_commented_code", "set_placeholders_for_examples", "example_index", "get_examples_before_replacement", "get_component_name", "check_if_valid_component_file", "has_joystick_ui", "get_default_export", "export_default_matches", "check_if_has_joystick_ui", "joystick_ui_matches", "check_if_is_component_type", "type", "build_args", "bootstrap_target", "check_if_should_set_component_id", "entry_point", "bootstrap_component", "build", "is_layout_component", "is_page_component", "is_email_component", "file_contents", "is_valid_component_file", "resolve", "should_set_component_id", "build_exists", "bootstrap_component_default"]
}
