{
  "version": 3,
  "sources": ["../../../../src/lib/build/plugins/set_component_id.js"],
  "sourcesContent": ["import fs from \"fs\";\nimport generate_id from \"../../generate_id.js\";\nimport path_exists from \"../../path_exists.js\";\n\nconst { readFile, writeFile } = fs.promises;\n\nconst update_component_id_cache = async (component_id_targets = [], component_id_cache = {}, component_id_cache_path = '') => {\n  for (let i = 0; i < component_id_targets.length; i += 1) {\n    const component = component_id_targets[i];\n    component_id_cache[component.path] = component.component_id;\n    await writeFile(component_id_cache_path, JSON.stringify(component_id_cache));\n  }\n};\n\nconst inject_component_id = (component_id_targets = [], file = '') => {\n  let updated_file = file;\n\n  for (let i = 0; i < component_id_targets.length; i += 1) {\n    const component = component_id_targets[i];\n\n    const tainted = component.source.replace(\n      /\\.component\\(\\{+(?!\\n + _componentId)/g,\n      () => {\n        return `.component({\\n  _componentId: '${component.component_id}',`;\n      }\n    );\n\n    updated_file = updated_file.replace(component.source, tainted);\n  }\n\n  return updated_file;\n};\n\nconst get_component_id_targets = (file = '', component_paths_from_esbuild_output = [], component_id_cache = {}) => {\n  return component_paths_from_esbuild_output?.map((component_path, component_path_index) => {\n    const next_component_path = component_paths_from_esbuild_output[component_path_index + 1];\n    const path_without_comment = component_path.path.replace(\"// \", \"\");\n\n    return {\n      path: path_without_comment,\n      component_id: component_id_cache[path_without_comment] || generate_id(16),\n      index: component_path.index,\n      source: file.substring(\n        component_path.index,\n        next_component_path ? next_component_path.index : file.length\n      ),\n    };\n  });\n};\n\nconst get_component_paths_from_esbuild_output = (file = '') => {\n  return [...file?.matchAll(/\\/\\/ ui+.*/gi), ...file?.matchAll(/\\/\\/ email+.*/gi)]?.map((match) => {\n    return {\n      path: match[0],\n      index: match.index,\n    };\n  });\n};\n\nconst get_existing_component_id_cache = async (component_id_cache_path = '') => {\n  const has_component_id_cache = await path_exists(component_id_cache_path);\n\n  if (has_component_id_cache) {\n    const component_id_cache = await readFile(component_id_cache_path, 'utf-8');\n    return JSON.parse(component_id_cache);\n  }\n\n  return {};\n};\n\nconst get_component_id_cache_path = () => {\n  return ['development', 'test'].includes(process.env.NODE_ENV)\n    ? `./.joystick/build/component_id_cache.json`\n    : `./.build/component_id_cache.json`;\n};\n\nconst set_component_id = async (file = \"\") => {\n  const component_id_cache_path = get_component_id_cache_path();\n  const component_id_cache = await get_existing_component_id_cache(component_id_cache_path);\n  const component_paths_from_esbuild_output = get_component_paths_from_esbuild_output(file);\n  const component_id_targets = get_component_id_targets(file, component_paths_from_esbuild_output, component_id_cache);\n\n  const file_with_component_id = inject_component_id(component_id_targets, file);\n  await update_component_id_cache(component_id_targets, component_id_cache, component_id_cache_path);\n\n  return file_with_component_id;\n};\n\nexport default set_component_id;\n"],
  "mappings": "AAAA,OAAOA,MAAQ,KACf,OAAOC,MAAiB,uBACxB,OAAOC,MAAiB,uBAExB,KAAM,CAAE,SAAAC,EAAU,UAAAC,CAAU,EAAIJ,EAAG,SAE7BK,EAA4B,MAAOC,EAAuB,CAAC,EAAGC,EAAqB,CAAC,EAAGC,EAA0B,KAAO,CAC5H,QAASC,EAAI,EAAGA,EAAIH,EAAqB,OAAQG,GAAK,EAAG,CACvD,MAAMC,EAAYJ,EAAqBG,CAAC,EACxCF,EAAmBG,EAAU,IAAI,EAAIA,EAAU,aAC/C,MAAMN,EAAUI,EAAyB,KAAK,UAAUD,CAAkB,CAAC,CAC7E,CACF,EAEMI,EAAsB,CAACL,EAAuB,CAAC,EAAGM,EAAO,KAAO,CACpE,IAAIC,EAAeD,EAEnB,QAASH,EAAI,EAAGA,EAAIH,EAAqB,OAAQG,GAAK,EAAG,CACvD,MAAMC,EAAYJ,EAAqBG,CAAC,EAElCK,EAAUJ,EAAU,OAAO,QAC/B,yCACA,IACS;AAAA,mBAAkCA,EAAU,YAAY,IAEnE,EAEAG,EAAeA,EAAa,QAAQH,EAAU,OAAQI,CAAO,CAC/D,CAEA,OAAOD,CACT,EAEME,EAA2B,CAACH,EAAO,GAAII,EAAsC,CAAC,EAAGT,EAAqB,CAAC,IACpGS,GAAqC,IAAI,CAACC,EAAgBC,IAAyB,CACxF,MAAMC,EAAsBH,EAAoCE,EAAuB,CAAC,EAClFE,EAAuBH,EAAe,KAAK,QAAQ,MAAO,EAAE,EAElE,MAAO,CACL,KAAMG,EACN,aAAcb,EAAmBa,CAAoB,GAAKnB,EAAY,EAAE,EACxE,MAAOgB,EAAe,MACtB,OAAQL,EAAK,UACXK,EAAe,MACfE,EAAsBA,EAAoB,MAAQP,EAAK,MACzD,CACF,CACF,CAAC,EAGGS,EAA0C,CAACT,EAAO,KAC/C,CAAC,GAAGA,GAAM,SAAS,cAAc,EAAG,GAAGA,GAAM,SAAS,iBAAiB,CAAC,EAAG,IAAKU,IAC9E,CACL,KAAMA,EAAM,CAAC,EACb,MAAOA,EAAM,KACf,EACD,EAGGC,EAAkC,MAAOf,EAA0B,KAAO,CAG9E,GAF+B,MAAMN,EAAYM,CAAuB,EAE5C,CAC1B,MAAMD,EAAqB,MAAMJ,EAASK,EAAyB,OAAO,EAC1E,OAAO,KAAK,MAAMD,CAAkB,CACtC,CAEA,MAAO,CAAC,CACV,EAEMiB,EAA8B,IAC3B,CAAC,cAAe,MAAM,EAAE,SAAS,QAAQ,IAAI,QAAQ,EACxD,4CACA,mCAGAC,EAAmB,MAAOb,EAAO,KAAO,CAC5C,MAAMJ,EAA0BgB,EAA4B,EACtDjB,EAAqB,MAAMgB,EAAgCf,CAAuB,EAClFQ,EAAsCK,EAAwCT,CAAI,EAClFN,EAAuBS,EAAyBH,EAAMI,EAAqCT,CAAkB,EAE7GmB,EAAyBf,EAAoBL,EAAsBM,CAAI,EAC7E,aAAMP,EAA0BC,EAAsBC,EAAoBC,CAAuB,EAE1FkB,CACT,EAEA,IAAOC,EAAQF",
  "names": ["fs", "generate_id", "path_exists", "readFile", "writeFile", "update_component_id_cache", "component_id_targets", "component_id_cache", "component_id_cache_path", "i", "component", "inject_component_id", "file", "updated_file", "tainted", "get_component_id_targets", "component_paths_from_esbuild_output", "component_path", "component_path_index", "next_component_path", "path_without_comment", "get_component_paths_from_esbuild_output", "match", "get_existing_component_id_cache", "get_component_id_cache_path", "set_component_id", "file_with_component_id", "set_component_id_default"]
}
