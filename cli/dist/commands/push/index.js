import m from"chalk";import u from"inquirer";import g from"../../lib/build/index.js";import c from"../../lib/cli_log.js";import h from"./prompts/confirm_deployment.js";import y from"./create_version.js";import w from"./get_app_domain.js";import v from"./get_deployment.js";import $ from"./get_provision_domain.js";import b from"./get_settings_file.js";import k from"./get_session_token.js";import x from"./handle_initial_deployment.js";import S from"./handle_version_deployment.js";import j from"../../lib/loader.js";import D from"./upload_build_to_cdn.js";import B from"./validate_deployment.js";import O from"./validate_push_config.js";const _=(r="",s="",e={})=>{let t="";for(let o=0;o<e?.errors?.length;o+=1){const n=e?.errors[o];r==="push_config"&&(t+=`${m.yellowBright(`> ${n.field}`)}
`),t+=`${n?.error}
${o+1===e?.errors?.length?"":`
`}`}c(`${s?`${m.yellowBright(s)}


`:""}${t}`,{level:"danger",docs:{push_config:"https://cheatcode.co/docs/push/config",deployment:"https://cheatcode.co/docs/push/subscription"}[r]}),process.exit(0)},q=async()=>{const r=await k();return r||(c(data?.error?.message,{level:"danger",docs:"https://cheatcode.co/docs/push/cli#authentication"}),process.exit(0))},A=(r="")=>(c(`settings.${r}.json must contain a push config object. Add this following the docs link below and try again.`,{level:"danger",docs:"https://cheatcode.co/docs/push/config"}),process.exit(0)),I=async(r={},s={})=>{process.loader=new j,process.loader.print("Starting deployment...");const e=await q(),t=s?.environment||"production",o=await b({environment:t});if(!o?.push)return A(t);const n=$(s?.provision_server),l=w(s?.provision_server),i=await v({domain:o?.push?.domain,session_token:e,push_provision_domain:n});let p;i?.status==="undeployed"&&(p=await O({push_provision_domain:n,push_config:o?.push}),p?.errors?.length>0&&_("push_config",`Push config in settings.${t}.json failed validation with the following errors:`,p));const d=await B({session_token:e,push_provision_domain:n,push_config:o?.push});d?.errors?.length>0&&_("deployment","Deployment failed validation with the following errors:",d);const{confirm_deployment:f}=i?.status==="undeployed"?await u.prompt(h(p?.instances)):{confirm_deployment:!0};if(f){i?.status==="undeployed"&&console.log(`
`);const a=new Date().toISOString();await g({environment:t,encrypt_build:!0,encryption_key:i?.deployment_secret,silence_confirmation:!0}),process.loader.print("Uploading version..."),await D(a,i,e);const J=await y({push_provision_domain:n,domain:o?.push?.domain,session_token:e,body:{settings:JSON.stringify(o),build_timestamp:a}});return process.loader.print("Deploying app..."),i?.status==="undeployed"?x({push_provision_domain:n,push_app_domain:l,session_token:e,environment:t,build_timestamp:a,deployment:i}):S({push_provision_domain:n,push_app_domain:l,session_token:e,environment:t,build_timestamp:a,deployment:i})}};var X=I;export{X as default};
